esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  includes:
    - includes/ap_mode_helper.h
  platformio_options:
    build_flags: -DBOARD_HAS_PSRAM
    board_build.esp-idf.memory_type: qio_opi
    board_build.flash_mode: dio
    board_upload.maximum_ram_size: 524288
    board_build.flash_size: 16MB
  on_boot:
  - priority: 500
    then:
    - delay: 3000ms
    - switch.turn_on: backlight_switch
    - light.turn_on:
        id: lcd_backlight
        brightness: 80%
  - priority: 600
    then:
      - lambda: |-
          id(force_ap_mode) = false;
      - wifi.enable

  - priority: -100
    then:
      - script.execute: boot_flow
  - priority: 900
    then:
      - lvgl.widget.hide: btn_boot_menu
      - lvgl.page.show: boot_page
      - script.execute: maybe_show_boot_menu

substitutions:
  wifi_preset_1_label: "network 1"
  wifi_preset_2_label: "network 2"
  wifi_preset_3_label: "network 3"
  device_name: "solar-display"
  friendly_name: "Solar Display"
  api_key_full: !secret api_encryption_key
  ota_key_full: !secret ota_password
preferences:
  flash_write_interval: 5min

esp32:
  board: esp32-s3-devkitc-1
  variant: esp32s3
  flash_size: 16MB
  cpu_frequency: 240MHz
  framework:
    type: esp-idf
    sdkconfig_options:
      CONFIG_ESP32S3_DEFAULT_CPU_FREQ_240: y
      CONFIG_ESP32S3_DATA_CACHE_64KB: y
      CONFIG_SPIRAM_FETCH_INSTRUCTIONS: y
      CONFIG_SPIRAM_RODATA: y
      CONFIG_ESPTOOLPY_FLASHSIZE_8MB: y
psram:
  mode: octal
  speed: 80MHz

logger: 
  level: INFO
api:
  encryption:
    key: !secret api_encryption_key
  on_client_connected:
    - script.execute: finish_boot
  on_client_disconnected:
    - lambda: "if (!id(api_ready)) {\n  lv_label_set_text(id(lbl_boot_status), \"Disconnected.\ \ Retrying…\");\n}"
ota:
  - platform: esphome
    password: !secret ota_password
wifi:
  networks:
    - ssid: !secret wifi_ssid_1
      password: !secret wifi_password_1
    - ssid: !secret wifi_ssid_2
      password: !secret wifi_password_2
    - ssid: !secret wifi_ssid_3
      password: !secret wifi_password_3
  reboot_timeout: 0s
  ap:
    ssid: "${friendly_name} Fallback Hotspot"
    ap_timeout: 15s
  on_connect:
    then:
      - lambda: |-
          // If the user forced AP-only setup mode, do not stay connected as STA.
          if (id(force_ap_mode)) {
          esp_wifi_disconnect();
          esp_wifi_set_mode(WIFI_MODE_AP);
          }
      - lambda: if (!id(api_ready)) lv_label_set_text(id(lbl_boot_status), "Wi-Fi OK. Waiting for API…");
      - lambda: |-
          lv_label_set_text(id(lbl_wifi_state), "Connected");
          lv_label_set_text(id(lbl_addwifi_state), "Connected");
  on_disconnect:
    then:
      - lambda: if (!id(api_ready)) lv_label_set_text(id(lbl_boot_status), "Wi-Fi lost. Reconnecting…");
      - lambda: |-
          if (id(force_ap_mode)) {
          lv_label_set_text(id(lbl_wifi_state), "AP");
          lv_label_set_text(id(lbl_addwifi_state), "AP");
          } else {
          lv_label_set_text(id(lbl_wifi_state), "Disconnected (AP if enabled)");
          lv_label_set_text(id(lbl_addwifi_state), "Disconnected");
          }
captive_portal: 
  id: cp

# --- AP-only "setup" mode ---
# ESPHome's built-in fallback AP/captive portal is designed to turn off as soon
# as STA connects. To keep the portal available even when normal Wi-Fi is in
# range, we enforce Wi-Fi mode = AP-only while `force_ap_mode` is true.



external_components:

# CH32V003 I/O expander used on the 7B board (for reset/backlight)
- source: github://pr#10071
  components: [waveshare_io_ch32v003]
  refresh: 1h

i2c:
- id: bus_a
  sda: 8
  scl: 9
  scan: true



waveshare_io_ch32v003:
  - id: wave_io
    address: 0x24

output:
  - platform: waveshare_io_ch32v003
    id: pwm_backlight_output
    waveshare_io_ch32v003_id: wave_io
    inverted: true
    min_power: 0.03
    max_power: 1
light:
  - platform: monochromatic
    id: lcd_backlight
    name: "Screen Backlight"
    output: pwm_backlight_output
    restore_mode: ALWAYS_ON
    default_transition_length: 0ms
    on_state:
      - lambda: |-
          // Keep slider/label in sync if brightness changes (e.g. from HA)
          float b = id(lcd_backlight).current_values.get_brightness();
          int v = (int) lroundf(b * 100.0f);
          if (v < 5) v = 5;
          if (v > 100) v = 100;
          lv_slider_set_value(id(sld_brightness), v, LV_ANIM_OFF);

          char buf[8];
          snprintf(buf, sizeof(buf), "%d%%", v);
          lv_label_set_text(id(lbl_brightness_val), buf);
    on_turn_on:
      - switch.turn_on: backlight_switch
    on_turn_off:
      - switch.turn_off: backlight_switch
#ch422g:
#- id: io_ex
switch:
- platform: template
  id: display_auto_sleep_toggle
  name: Display Auto Sleep
  optimistic: true
  restore_mode: RESTORE_DEFAULT_ON
- platform: gpio
  id: backlight_switch
  restore_mode: ALWAYS_ON
  pin:
    waveshare_io_ch32v003: wave_io
    number: 2
    mode: { output: true }

- platform: template
  id: graph_values_toggle
  name: Show Graph Values
  optimistic: true
  restore_mode: RESTORE_DEFAULT_ON
- platform: template
  id: show_totals_toggle
  name: Show Daily Totals
  optimistic: true
  restore_mode: RESTORE_DEFAULT_ON
- platform: template
  id: suggestion_toggle
  name: Show Tips/Suggestions
  optimistic: true
  restore_mode: RESTORE_DEFAULT_ON


- platform: template
  id: simulate_backup_switch
  name: Simulate Backup Mode
  optimistic: true
  restore_mode: RESTORE_DEFAULT_OFF
  on_turn_on:
    then:
      - if:
          condition:
            switch.is_on: change_homepage 
          then:
            - lvgl.page.show: home_page         # old/original homepage
          else:
            - lvgl.page.show: home_page_2       # new homepage
- platform: template
  id: change_homepage
  name: homepage toggle
  optimistic: true
  restore_mode: RESTORE_DEFAULT_OFF
  on_turn_on:
    then:
      - if:
          condition:
              lambda: return id(api_ready);
          then:
            - lvgl.page.show: home_page
            - lambda: |-
                id(use_original_home) = true;
  on_turn_off:
    then:
      - if:
          condition:
              lambda: return id(api_ready);
          then:
            - lvgl.page.show: home_page_2
            - lambda: |-
                id(use_original_home) = false;
touchscreen:
- platform: gt911
  id: my_touchscreen
  update_interval: 16ms
  interrupt_pin: 4
  reset_pin:
    waveshare_io_ch32v003: wave_io
    number: 1
  on_touch:
  - if:
      condition:
        switch.is_off: backlight_switch
      then:
        - switch.turn_on: backlight_switch

number:
  - platform: template
    id: display_timeout_seconds
    name: "Display Timeout (s)"
    optimistic: true
    restore_value: true
    initial_value: 300
    min_value: 30
    max_value: 1800
    step: 30
    on_value:
      then:
        - lvgl.label.update:
            id: lbl_display_timeout_state
            text: !lambda |-
                float v = x;  // number value in seconds
                if (v < 60.0f) {
                return str_sprintf("%.0fs", v);
                } else {
                return str_sprintf("%.0fm", v / 60.0f);
                }
globals:
- id: force_ap_mode
  type: bool
  restore_value: false
  initial_value: "false"
- id: fallback_ap_ssid_str
  type: std::string
  restore_value: yes
  initial_value: '"Solar-Display Fallback Hotspot"'

- id: fallback_ap_pass_str
  type: std::string
  restore_value: yes
  initial_value: ""

- id: add_wifi_ssid_str
  type: std::string
  restore_value: yes
  initial_value: ""

- id: add_wifi_pass_str
  type: std::string
  restore_value: yes
  initial_value: ""
- id: loading_rot
  type: int
  restore_value: false
  initial_value: '0'

- id: hu_dev1_name_str
  type: std::string
  restore_value: yes
  initial_value: '"Device 1"'

- id: hu_dev2_name_str
  type: std::string
  restore_value: yes
  initial_value: '"Device 2"'

- id: hu_dev3_name_str
  type: std::string
  restore_value: yes
  initial_value: '"Device 3"'

- id: hu_dev4_name_str
  type: std::string
  restore_value: yes
  initial_value: '"Device 4"'

- id: hu_dev5_name_str
  type: std::string
  restore_value: yes
  initial_value: '"Device 5"'

# === Home Usage icon selection (0..10) ===
- id: hu_dev1_icon_idx
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_dev2_icon_idx
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_dev3_icon_idx
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_dev4_icon_idx
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_dev5_icon_idx
  type: int
  restore_value: yes
  initial_value: '0'

# Editing selection while on usage_settings_page (not persisted until SAVE)
- id: hu_edit_icon_idx
  type: int
  restore_value: no
  initial_value: '0'


- id: hu_current_device
  type: int
  restore_value: false
  initial_value: '1'

- id: hu_home_usage_active
  type: bool
  restore_value: no
  initial_value: 'false'

- id: ld1125_last_presence_ms
  type: uint32_t
  restore_value: no
  initial_value: '0'
- id: hu_d1_phase
  type: float
  initial_value: '0'
  restore_value: no
- id: hu_d2_phase
  type: float
  initial_value: '0'
  restore_value: no
- id: hu_d3_phase
  type: float
  initial_value: '0'
  restore_value: no
- id: hu_d4_phase
  type: float
  initial_value: '0'
  restore_value: no
- id: hu_d5_phase
  type: float
  initial_value: '0'
  restore_value: no
- id: use_original_home
  type: bool
  restore_value: true
  initial_value: "false"    # false => home_page_2 is default
- id: current_dataset
  type: int
  restore_value: true
  initial_value: '0'
- id: api_ready
  type: bool
  restore_value: false
  initial_value: 'false'
- id: boot_extra_delay_ms
  type: int
  restore_value: false
  initial_value: '10000'

# -------- Interval rotation (auto page cycling) --------
- id: interval_enabled
  type: bool
  restore_value: yes
  initial_value: 'false'

- id: interval_seconds
  type: int
  restore_value: yes
  initial_value: '10'

# Bitmask of selected pages to rotate between
# bit0 home_page, bit1 home_page_2, bit2 solar_page, bit3 solar_info_page,
# bit4 battery_page, bit5 grid_page, bit6 graph_page, bit7 home_usage_page
- id: interval_pages_mask
  type: int
  restore_value: yes
  initial_value: '1'   # default: home_page only

- id: interval_countdown
  type: int
  restore_value: false
  initial_value: '0'

- id: interval_current_bit
  type: int
  restore_value: false
  initial_value: '0'

- id: interval_target_bit
  type: int
  restore_value: false
  initial_value: '0'

- id: interval_mode_active
  type: bool
  restore_value: false
  initial_value: 'false'


- id: interval_prelude_remaining
  type: int
  restore_value: false
  initial_value: '10'

- id: interval_running
  type: bool
  restore_value: false
  initial_value: 'false'

- id: hu_sp1_name_str
  type: std::string
  restore_value: yes
  initial_value: '"Subpanel 1"'
- id: hu_sp2_name_str
  type: std::string
  restore_value: yes
  initial_value: '"Subpanel 2"'
- id: hu_sp1_icon_idx
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_sp2_icon_idx
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_sp1_enabled
  type: bool
  restore_value: yes
  initial_value: 'false'
- id: hu_sp2_enabled
  type: bool
  restore_value: yes
  initial_value: 'false'

- id: hu_anim_enabled
  type: bool
  restore_value: no
  initial_value: 'false'
- id: hu_dev1_route
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_dev2_route
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_dev3_route
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_dev4_route
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_dev5_route
  type: int
  restore_value: yes
  initial_value: '0'
- id: hu_sp1_phase
  type: float
  restore_value: false
  initial_value: '0.0'
- id: hu_sp2_phase
  type: float
  restore_value: false
  initial_value: '0.0'
- id: hu_current_subpanel
  type: int
  restore_value: false
  initial_value: '1'
- id: hu_sp_edit_icon_idx
  type: int
  restore_value: false
  initial_value: '0'

time:
- platform: sntp
  id: sntp_time
  timezone: Europe/Brussels
binary_sensor:
- platform: template
  id: presence_any
  name: "Presence"
  device_class: occupancy
  lambda: |-
      // For now presence = HMMD only
      return id(hmmd_presence).state;

  # Wake the screen immediately whenever presence becomes true
  on_press:
    then:
      - if:
          condition:
            switch.is_on: display_auto_sleep_toggle
          then:
            - switch.turn_on: backlight_switch

- platform: gpio
  id: hmmd_presence
  name: "HMMD Presence"
  device_class: occupancy
  pin:
    number: GPIO6        # HMMD OT2 wired to GP6 on the board
    mode:
      input: true
      pullup: false
      pulldown: false
    inverted: false
  on_press:
    - lambda: |-
        // HMMD saw presence: remember the time for the screen timeout logic
        id(ld1125_last_presence_ms) = millis();
    - logger.log: "HMMD PRESENCE: ON (OT2 went HIGH)"
  on_release:
    - logger.log: "HMMD PRESENCE: OFF (OT2 went LOW)"



- platform: homeassistant
  id: grid_backup_status_ha
  entity_id: binary_sensor.solaredge_i1_grid_status
  on_state:
    then:
      - if:
          condition:
              lambda: return id(api_ready) && (x == false);
          then:
            - if:
                condition:
                  switch.is_on: change_homepage 
                then:
                  - lvgl.page.show: home_page         # old/original homepage
                else:
                  - lvgl.page.show: home_page_2       # new homepage
sensor:

- platform: template
  id: ld1125_distance
  name: "LD1125H Distance"
  unit_of_measurement: "m"
  accuracy_decimals: 2
- platform: homeassistant
  id: export_daily_kwh
  entity_id: sensor.package_sigen_exported_power_daily
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_export_daily), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_export_daily), b);'
- platform: homeassistant
  id: export_weekly_kwh
  entity_id: sensor.package_sigen_exported_power_weekly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_export_weekly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_export_weekly), b);'
- platform: homeassistant
  id: export_monthly_kwh
  entity_id: sensor.package_sigen_exported_power_monthly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_export_monthly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_export_monthly), b);'
- platform: homeassistant
  id: export_yearly_kwh
  entity_id: sensor.package_sigen_exported_power_yearly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_export_yearly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_export_yearly), b);'
- platform: homeassistant
  name: Solar Panel Production
  entity_id: sensor.package_sigen_pv_power
  id: solar_panel_production_sensor
  on_value:
  - lambda: 'char buffer[20];

      snprintf(buffer, sizeof(buffer), "%.0f W", x);

      lv_label_set_text(id(solar_input_value_label), buffer);

      if (x > 6000) {

      lv_obj_set_style_text_color(id(solar_input_value_label), lv_color_hex(0x388E3C), LV_PART_MAIN);

      } else if (x > 1000) {

      lv_obj_set_style_text_color(id(solar_input_value_label), lv_color_hex(0xFF9800), LV_PART_MAIN);

      } else {

      lv_obj_set_style_text_color(id(solar_input_value_label), lv_color_hex(0xB71C1C), LV_PART_MAIN);

      }'
- platform: homeassistant
  name: Solar House Consumption
  entity_id: sensor.package_sigen_house_consumption_w
  id: solar_house_consumption_sensor
  on_value:
  - lambda: 'char buffer[20];

      snprintf(buffer, sizeof(buffer), "%.0f W", x);

      lv_label_set_text(id(home_usage_value_label), buffer);

      lv_label_set_text(id(hu_home_usage_value_label), buffer);

      lv_obj_set_style_text_color(id(home_usage_value_label), lv_color_white(), LV_PART_MAIN);
      lv_obj_set_style_text_color(id(hu_home_usage_value_label), lv_color_white(), LV_PART_MAIN);'
- platform: homeassistant
  name: SolarEdge Battery State of Charge
  entity_id: sensor.package_sigen_battery_soc
  id: solaredge_battery_soc
  on_value:
    - lambda: |-
        lv_bar_set_value(id(battery_bar), x, LV_ANIM_ON);

        char buffer[10];
        snprintf(buffer, sizeof(buffer), "%.0f%%", x);
        lv_label_set_text(id(battery_percent_label), buffer);

        // Update circular SoC display
        lv_label_set_text(id(batt_soc_circle_text), buffer);
        lv_arc_set_value(id(batt_soc_arc), (int)x);
        lv_label_set_text(id(batt_soc_circle_text), buffer);

        // Optional: set bar color
        lv_obj_set_style_bg_color(id(battery_bar), lv_color_hex(0x388E3C), LV_PART_INDICATOR);

    - lambda: |-
        // ---- home_page_2 battery image visibility ----

        // First, hide all battery icons
        lv_obj_add_flag(id(hp2_batt_img_0010), LV_OBJ_FLAG_HIDDEN);
        lv_obj_add_flag(id(hp2_batt_img_1020), LV_OBJ_FLAG_HIDDEN);
        lv_obj_add_flag(id(hp2_batt_img_2030), LV_OBJ_FLAG_HIDDEN);
        lv_obj_add_flag(id(hp2_batt_img_3040), LV_OBJ_FLAG_HIDDEN);
        lv_obj_add_flag(id(hp2_batt_img_4050), LV_OBJ_FLAG_HIDDEN);
        lv_obj_add_flag(id(hp2_batt_img_5060), LV_OBJ_FLAG_HIDDEN);
        lv_obj_add_flag(id(hp2_batt_img_6070), LV_OBJ_FLAG_HIDDEN);
        lv_obj_add_flag(id(hp2_batt_img_7080), LV_OBJ_FLAG_HIDDEN);
        lv_obj_add_flag(id(hp2_batt_img_8090), LV_OBJ_FLAG_HIDDEN);
        lv_obj_add_flag(id(hp2_batt_img_90100), LV_OBJ_FLAG_HIDDEN);

        // Then show the correct one based on SoC percentage
        if (x < 10) {
          lv_obj_clear_flag(id(hp2_batt_img_0010), LV_OBJ_FLAG_HIDDEN);
        } else if (x < 20) {
          lv_obj_clear_flag(id(hp2_batt_img_1020), LV_OBJ_FLAG_HIDDEN);
        } else if (x < 30) {
          lv_obj_clear_flag(id(hp2_batt_img_2030), LV_OBJ_FLAG_HIDDEN);
        } else if (x < 40) {
          lv_obj_clear_flag(id(hp2_batt_img_3040), LV_OBJ_FLAG_HIDDEN);
        } else if (x < 50) {
          lv_obj_clear_flag(id(hp2_batt_img_4050), LV_OBJ_FLAG_HIDDEN);
        } else if (x < 60) {
          lv_obj_clear_flag(id(hp2_batt_img_5060), LV_OBJ_FLAG_HIDDEN);
        } else if (x < 70) {
          lv_obj_clear_flag(id(hp2_batt_img_6070), LV_OBJ_FLAG_HIDDEN);
        } else if (x < 80) {
          lv_obj_clear_flag(id(hp2_batt_img_7080), LV_OBJ_FLAG_HIDDEN);
        } else if (x < 90) {
          lv_obj_clear_flag(id(hp2_batt_img_8090), LV_OBJ_FLAG_HIDDEN);
        } else {
          lv_obj_clear_flag(id(hp2_batt_img_90100), LV_OBJ_FLAG_HIDDEN);
        }

- platform: homeassistant
  id: grid_to_house
  entity_id: sensor.package_sigen_grid_to_house_w
  on_value:
  - lambda: '// Feeds the Grid page "Export Now" label (mirrors your earlier working behavior)

      if (std::isnan(x)) { lv_label_set_text(id(lbl_export_now), "—"); return; }

      char b[20];

      float v = x;

      if (fabsf(v) >= 1000.0f) snprintf(b, sizeof(b), "%.1f kW", v/1000.0f);

      else snprintf(b, sizeof(b), "%.0f W", v);

      lv_label_set_text(id(lbl_export_now), b);'
- platform: homeassistant
  id: grid_to_battery
  entity_id: sensor.package_sigen_grid_to_battery_w
- platform: homeassistant
  id: generation_to_grid
  entity_id: sensor.package_sigen_pv_to_grid_w
- platform: homeassistant
  id: generation_to_battery
  entity_id: sensor.package_sigen_pv_to_battery_w
- platform: homeassistant
  id: generation_to_house
  entity_id: sensor.package_sigen_pv_to_house_w
- platform: homeassistant
  id: battery_to_house
  entity_id: sensor.package_sigen_battery_to_house_w
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_to_house_now), "—"); return; }

      char b[20];

      float v = x;

      if (fabsf(v) >= 1000.0f) snprintf(b, sizeof(b), "%.1f kW", v/1000.0f);

      else snprintf(b, sizeof(b), "%.0f W", v);

      lv_label_set_text(id(lbl_batt_to_house_now), b);'
- platform: homeassistant
  id: battery_to_grid
  entity_id: sensor.package_sigen_battery_to_grid_w
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_to_grid_now), "—"); return; }

      char b[20];

      float v = x;

      if (fabsf(v) >= 1000.0f) snprintf(b, sizeof(b), "%.1f kW", v/1000.0f);

      else snprintf(b, sizeof(b), "%.0f W", v);

      lv_label_set_text(id(lbl_batt_to_grid_now), b);'
- platform: homeassistant
  id: battery_out_w
  entity_id: sensor.package_sigen_battery_out_w

- platform: homeassistant
  id: battery_in_w
  entity_id: sensor.package_sigen_battery_in_w
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_in_now), "—"); return; }

      char b[20];

      float v = x;

      if (fabsf(v) >= 1000.0f) snprintf(b, sizeof(b), "%.1f kW", v/1000.0f);

      else snprintf(b, sizeof(b), "%.0f W", v);

      lv_label_set_text(id(lbl_batt_in_now), b);'
- platform: homeassistant
  id: battery_in_daily
  entity_id: sensor.package_sigen_battery_in_daily
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_in_daily), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_batt_in_daily), b);'
- platform: homeassistant
  id: battery_in_weekly
  entity_id: sensor.package_sigen_battery_in_weekly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_in_weekly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_batt_in_weekly), b);'
- platform: homeassistant
  id: battery_in_monthly
  entity_id: sensor.package_sigen_battery_in_monthly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_in_monthly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_batt_in_monthly), b);'
- platform: homeassistant
  id: battery_in_yearly
  entity_id: sensor.package_sigen_battery_in_yearly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_in_yearly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_batt_in_yearly), b);'
- platform: homeassistant
  id: battery_out_daily
  entity_id: sensor.package_sigen_battery_out_daily
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_out_daily), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_batt_out_daily), b);'
- platform: homeassistant
  id: battery_out_weekly
  entity_id: sensor.package_sigen_battery_out_weekly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_out_weekly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_batt_out_weekly), b);'
- platform: homeassistant
  id: battery_out_monthly
  entity_id: sensor.package_sigen_battery_out_monthly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_out_monthly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_batt_out_monthly), b);'
- platform: homeassistant
  id: battery_out_yearly
  entity_id: sensor.package_sigen_battery_out_yearly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_batt_out_yearly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_batt_out_yearly), b);'
- platform: homeassistant
  id: imported_power_w
  entity_id: sensor.package_sigen_imported_power_w
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_import_now), "—"); return; }

      char b[20];

      float v = x;

      if (fabsf(v) >= 1000.0f) snprintf(b, sizeof(b), "%.1f kW", v/1000.0f);

      else snprintf(b, sizeof(b), "%.0f W", v);

      lv_label_set_text(id(lbl_import_now), b);'
- platform: homeassistant
  id: imported_power_daily
  entity_id: sensor.package_sigen_imported_power_daily
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_import_daily), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_import_daily), b);'
- platform: homeassistant
  id: imported_power_weekly
  entity_id: sensor.package_sigen_imported_power_weekly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_import_weekly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_import_weekly), b);'
- platform: homeassistant
  id: imported_power_monthly
  entity_id: sensor.package_sigen_imported_power_monthly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_import_monthly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_import_monthly), b);'
- platform: homeassistant
  id: imported_power_yearly
  entity_id: sensor.package_sigen_imported_power_yearly
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_import_yearly), "—"); return; }

      char b[24]; snprintf(b, sizeof(b), "%.1f kWh", x);

      lv_label_set_text(id(lbl_import_yearly), b);'
- platform: homeassistant
  id: house_consumption_daily
  entity_id: sensor.package_sigen_house_consumption_daily
- platform: homeassistant
  id: house_consumption_weekly
  entity_id: sensor.package_sigen_house_consumption_weekly
- platform: homeassistant
  id: house_consumption_monthly
  entity_id: sensor.package_sigen_house_consumption_monthly
- platform: homeassistant
  id: house_consumption_yearly
  entity_id: sensor.package_sigen_house_consumption_yearly

- platform: wifi_signal
  name: WiFi Signal
  id: wifi_signal_sensor
  update_interval: 30s
  on_value:
  - lambda: 'char b[24];

      snprintf(b, sizeof(b), "%.0f dBm", x);

      lv_label_set_text(id(lbl_wifi_rssi), b);'
- platform: homeassistant
  id: prod_h00
  entity_id: sensor.package_sigen_pv_by_hour_h00
- platform: homeassistant
  id: prod_h01
  entity_id: sensor.package_sigen_pv_by_hour_h01
- platform: homeassistant
  id: prod_h02
  entity_id: sensor.package_sigen_pv_by_hour_h02
- platform: homeassistant
  id: prod_h03
  entity_id: sensor.package_sigen_pv_by_hour_h03
- platform: homeassistant
  id: prod_h04
  entity_id: sensor.package_sigen_pv_by_hour_h04
- platform: homeassistant
  id: prod_h05
  entity_id: sensor.package_sigen_pv_by_hour_h05
- platform: homeassistant
  id: prod_h06
  entity_id: sensor.package_sigen_pv_by_hour_h06
- platform: homeassistant
  id: prod_h07
  entity_id: sensor.package_sigen_pv_by_hour_h07
- platform: homeassistant
  id: prod_h08
  entity_id: sensor.package_sigen_pv_by_hour_h08
- platform: homeassistant
  id: prod_h09
  entity_id: sensor.package_sigen_pv_by_hour_h09
- platform: homeassistant
  id: prod_h10
  entity_id: sensor.package_sigen_pv_by_hour_h10
- platform: homeassistant
  id: prod_h11
  entity_id: sensor.package_sigen_pv_by_hour_h11
- platform: homeassistant
  id: prod_h12
  entity_id: sensor.package_sigen_pv_by_hour_h12
- platform: homeassistant
  id: prod_h13
  entity_id: sensor.package_sigen_pv_by_hour_h13
- platform: homeassistant
  id: prod_h14
  entity_id: sensor.package_sigen_pv_by_hour_h14
- platform: homeassistant
  id: prod_h15
  entity_id: sensor.package_sigen_pv_by_hour_h15
- platform: homeassistant
  id: prod_h16
  entity_id: sensor.package_sigen_pv_by_hour_h16
- platform: homeassistant
  id: prod_h17
  entity_id: sensor.package_sigen_pv_by_hour_h17
- platform: homeassistant
  id: prod_h18
  entity_id: sensor.package_sigen_pv_by_hour_h18
- platform: homeassistant
  id: prod_h19
  entity_id: sensor.package_sigen_pv_by_hour_h19
- platform: homeassistant
  id: prod_h20
  entity_id: sensor.package_sigen_pv_by_hour_h20
- platform: homeassistant
  id: prod_h21
  entity_id: sensor.package_sigen_pv_by_hour_h21
- platform: homeassistant
  id: prod_h22
  entity_id: sensor.package_sigen_pv_by_hour_h22
- platform: homeassistant
  id: prod_h23
  entity_id: sensor.package_sigen_pv_by_hour_h23
- platform: homeassistant
  id: tohouse_h00
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h00
- platform: homeassistant
  id: tohouse_h01
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h01
- platform: homeassistant
  id: tohouse_h02
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h02
- platform: homeassistant
  id: tohouse_h03
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h03
- platform: homeassistant
  id: tohouse_h04
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h04
- platform: homeassistant
  id: tohouse_h05
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h05
- platform: homeassistant
  id: tohouse_h06
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h06
- platform: homeassistant
  id: tohouse_h07
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h07
- platform: homeassistant
  id: tohouse_h08
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h08
- platform: homeassistant
  id: tohouse_h09
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h09
- platform: homeassistant
  id: tohouse_h10
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h10
- platform: homeassistant
  id: tohouse_h11
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h11
- platform: homeassistant
  id: tohouse_h12
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h12
- platform: homeassistant
  id: tohouse_h13
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h13
- platform: homeassistant
  id: tohouse_h14
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h14
- platform: homeassistant
  id: tohouse_h15
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h15
- platform: homeassistant
  id: tohouse_h16
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h16
- platform: homeassistant
  id: tohouse_h17
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h17
- platform: homeassistant
  id: tohouse_h18
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h18
- platform: homeassistant
  id: tohouse_h19
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h19
- platform: homeassistant
  id: tohouse_h20
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h20
- platform: homeassistant
  id: tohouse_h21
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h21
- platform: homeassistant
  id: tohouse_h22
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h22
- platform: homeassistant
  id: tohouse_h23
  entity_id: sensor.package_sigen_pv_to_house_by_hour_h23
- platform: homeassistant
  id: house_h00
  entity_id: sensor.package_sigen_house_consumption_by_hour_h00
- platform: homeassistant
  id: house_h01
  entity_id: sensor.package_sigen_house_consumption_by_hour_h01
- platform: homeassistant
  id: house_h02
  entity_id: sensor.package_sigen_house_consumption_by_hour_h02
- platform: homeassistant
  id: house_h03
  entity_id: sensor.package_sigen_house_consumption_by_hour_h03
- platform: homeassistant
  id: house_h04
  entity_id: sensor.package_sigen_house_consumption_by_hour_h04
- platform: homeassistant
  id: house_h05
  entity_id: sensor.package_sigen_house_consumption_by_hour_h05
- platform: homeassistant
  id: house_h06
  entity_id: sensor.package_sigen_house_consumption_by_hour_h06
- platform: homeassistant
  id: house_h07
  entity_id: sensor.package_sigen_house_consumption_by_hour_h07
- platform: homeassistant
  id: house_h08
  entity_id: sensor.package_sigen_house_consumption_by_hour_h08
- platform: homeassistant
  id: house_h09
  entity_id: sensor.package_sigen_house_consumption_by_hour_h09
- platform: homeassistant
  id: house_h10
  entity_id: sensor.package_sigen_house_consumption_by_hour_h10
- platform: homeassistant
  id: house_h11
  entity_id: sensor.package_sigen_house_consumption_by_hour_h11
- platform: homeassistant
  id: house_h12
  entity_id: sensor.package_sigen_house_consumption_by_hour_h12
- platform: homeassistant
  id: house_h13
  entity_id: sensor.package_sigen_house_consumption_by_hour_h13
- platform: homeassistant
  id: house_h14
  entity_id: sensor.package_sigen_house_consumption_by_hour_h14
- platform: homeassistant
  id: house_h15
  entity_id: sensor.package_sigen_house_consumption_by_hour_h15
- platform: homeassistant
  id: house_h16
  entity_id: sensor.package_sigen_house_consumption_by_hour_h16
- platform: homeassistant
  id: house_h17
  entity_id: sensor.package_sigen_house_consumption_by_hour_h17
- platform: homeassistant
  id: house_h18
  entity_id: sensor.package_sigen_house_consumption_by_hour_h18
- platform: homeassistant
  id: house_h19
  entity_id: sensor.package_sigen_house_consumption_by_hour_h19
- platform: homeassistant
  id: house_h20
  entity_id: sensor.package_sigen_house_consumption_by_hour_h20
- platform: homeassistant
  id: house_h21
  entity_id: sensor.package_sigen_house_consumption_by_hour_h21
- platform: homeassistant
  id: house_h22
  entity_id: sensor.package_sigen_house_consumption_by_hour_h22
- platform: homeassistant
  id: house_h23
  entity_id: sensor.package_sigen_house_consumption_by_hour_h23
- platform: homeassistant
  id: imp_h00
  entity_id: sensor.package_sigen_imported_power_by_hour_h00
- platform: homeassistant
  id: imp_h01
  entity_id: sensor.package_sigen_imported_power_by_hour_h01
- platform: homeassistant
  id: imp_h02
  entity_id: sensor.package_sigen_imported_power_by_hour_h02
- platform: homeassistant
  id: imp_h03
  entity_id: sensor.package_sigen_imported_power_by_hour_h03
- platform: homeassistant
  id: imp_h04
  entity_id: sensor.package_sigen_imported_power_by_hour_h04
- platform: homeassistant
  id: imp_h05
  entity_id: sensor.package_sigen_imported_power_by_hour_h05
- platform: homeassistant
  id: imp_h06
  entity_id: sensor.package_sigen_imported_power_by_hour_h06
- platform: homeassistant
  id: imp_h07
  entity_id: sensor.package_sigen_imported_power_by_hour_h07
- platform: homeassistant
  id: imp_h08
  entity_id: sensor.package_sigen_imported_power_by_hour_h08
- platform: homeassistant
  id: imp_h09
  entity_id: sensor.package_sigen_imported_power_by_hour_h09
- platform: homeassistant
  id: imp_h10
  entity_id: sensor.package_sigen_imported_power_by_hour_h10
- platform: homeassistant
  id: imp_h11
  entity_id: sensor.package_sigen_imported_power_by_hour_h11
- platform: homeassistant
  id: imp_h12
  entity_id: sensor.package_sigen_imported_power_by_hour_h12
- platform: homeassistant
  id: imp_h13
  entity_id: sensor.package_sigen_imported_power_by_hour_h13
- platform: homeassistant
  id: imp_h14
  entity_id: sensor.package_sigen_imported_power_by_hour_h14
- platform: homeassistant
  id: imp_h15
  entity_id: sensor.package_sigen_imported_power_by_hour_h15
- platform: homeassistant
  id: imp_h16
  entity_id: sensor.package_sigen_imported_power_by_hour_h16
- platform: homeassistant
  id: imp_h17
  entity_id: sensor.package_sigen_imported_power_by_hour_h17
- platform: homeassistant
  id: imp_h18
  entity_id: sensor.package_sigen_imported_power_by_hour_h18
- platform: homeassistant
  id: imp_h19
  entity_id: sensor.package_sigen_imported_power_by_hour_h19
- platform: homeassistant
  id: imp_h20
  entity_id: sensor.package_sigen_imported_power_by_hour_h20
- platform: homeassistant
  id: imp_h21
  entity_id: sensor.package_sigen_imported_power_by_hour_h21
- platform: homeassistant
  id: imp_h22
  entity_id: sensor.package_sigen_imported_power_by_hour_h22
- platform: homeassistant
  id: imp_h23
  entity_id: sensor.package_sigen_imported_power_by_hour_h23
- platform: homeassistant
  id: exp_h00
  entity_id: sensor.package_sigen_exported_power_by_hour_h00
- platform: homeassistant
  id: exp_h01
  entity_id: sensor.package_sigen_exported_power_by_hour_h01
- platform: homeassistant
  id: exp_h02
  entity_id: sensor.package_sigen_exported_power_by_hour_h02
- platform: homeassistant
  id: exp_h03
  entity_id: sensor.package_sigen_exported_power_by_hour_h03
- platform: homeassistant
  id: exp_h04
  entity_id: sensor.package_sigen_exported_power_by_hour_h04
- platform: homeassistant
  id: exp_h05
  entity_id: sensor.package_sigen_exported_power_by_hour_h05
- platform: homeassistant
  id: exp_h06
  entity_id: sensor.package_sigen_exported_power_by_hour_h06
- platform: homeassistant
  id: exp_h07
  entity_id: sensor.package_sigen_exported_power_by_hour_h07
- platform: homeassistant
  id: exp_h08
  entity_id: sensor.package_sigen_exported_power_by_hour_h08
- platform: homeassistant
  id: exp_h09
  entity_id: sensor.package_sigen_exported_power_by_hour_h09
- platform: homeassistant
  id: exp_h10
  entity_id: sensor.package_sigen_exported_power_by_hour_h10
- platform: homeassistant
  id: exp_h11
  entity_id: sensor.package_sigen_exported_power_by_hour_h11
- platform: homeassistant
  id: exp_h12
  entity_id: sensor.package_sigen_exported_power_by_hour_h12
- platform: homeassistant
  id: exp_h13
  entity_id: sensor.package_sigen_exported_power_by_hour_h13
- platform: homeassistant
  id: exp_h14
  entity_id: sensor.package_sigen_exported_power_by_hour_h14
- platform: homeassistant
  id: exp_h15
  entity_id: sensor.package_sigen_exported_power_by_hour_h15
- platform: homeassistant
  id: exp_h16
  entity_id: sensor.package_sigen_exported_power_by_hour_h16
- platform: homeassistant
  id: exp_h17
  entity_id: sensor.package_sigen_exported_power_by_hour_h17
- platform: homeassistant
  id: exp_h18
  entity_id: sensor.package_sigen_exported_power_by_hour_h18
- platform: homeassistant
  id: exp_h19
  entity_id: sensor.package_sigen_exported_power_by_hour_h19
- platform: homeassistant
  id: exp_h20
  entity_id: sensor.package_sigen_exported_power_by_hour_h20
- platform: homeassistant
  id: exp_h21
  entity_id: sensor.package_sigen_exported_power_by_hour_h21
- platform: homeassistant
  id: exp_h22
  entity_id: sensor.package_sigen_exported_power_by_hour_h22
- platform: homeassistant
  id: exp_h23
  entity_id: sensor.package_sigen_exported_power_by_hour_h23
- platform: homeassistant
  id: bin_h00
  entity_id: sensor.package_sigen_battery_in_by_hour_h00
- platform: homeassistant
  id: bin_h01
  entity_id: sensor.package_sigen_battery_in_by_hour_h01
- platform: homeassistant
  id: bin_h02
  entity_id: sensor.package_sigen_battery_in_by_hour_h02
- platform: homeassistant
  id: bin_h03
  entity_id: sensor.package_sigen_battery_in_by_hour_h03
- platform: homeassistant
  id: bin_h04
  entity_id: sensor.package_sigen_battery_in_by_hour_h04
- platform: homeassistant
  id: bin_h05
  entity_id: sensor.package_sigen_battery_in_by_hour_h05
- platform: homeassistant
  id: bin_h06
  entity_id: sensor.package_sigen_battery_in_by_hour_h06
- platform: homeassistant
  id: bin_h07
  entity_id: sensor.package_sigen_battery_in_by_hour_h07
- platform: homeassistant
  id: bin_h08
  entity_id: sensor.package_sigen_battery_in_by_hour_h08
- platform: homeassistant
  id: bin_h09
  entity_id: sensor.package_sigen_battery_in_by_hour_h09
- platform: homeassistant
  id: bin_h10
  entity_id: sensor.package_sigen_battery_in_by_hour_h10
- platform: homeassistant
  id: bin_h11
  entity_id: sensor.package_sigen_battery_in_by_hour_h11
- platform: homeassistant
  id: bin_h12
  entity_id: sensor.package_sigen_battery_in_by_hour_h12
- platform: homeassistant
  id: bin_h13
  entity_id: sensor.package_sigen_battery_in_by_hour_h13
- platform: homeassistant
  id: bin_h14
  entity_id: sensor.package_sigen_battery_in_by_hour_h14
- platform: homeassistant
  id: bin_h15
  entity_id: sensor.package_sigen_battery_in_by_hour_h15
- platform: homeassistant
  id: bin_h16
  entity_id: sensor.package_sigen_battery_in_by_hour_h16
- platform: homeassistant
  id: bin_h17
  entity_id: sensor.package_sigen_battery_in_by_hour_h17
- platform: homeassistant
  id: bin_h18
  entity_id: sensor.package_sigen_battery_in_by_hour_h18
- platform: homeassistant
  id: bin_h19
  entity_id: sensor.package_sigen_battery_in_by_hour_h19
- platform: homeassistant
  id: bin_h20
  entity_id: sensor.package_sigen_battery_in_by_hour_h20
- platform: homeassistant
  id: bin_h21
  entity_id: sensor.package_sigen_battery_in_by_hour_h21
- platform: homeassistant
  id: bin_h22
  entity_id: sensor.package_sigen_battery_in_by_hour_h22
- platform: homeassistant
  id: bin_h23
  entity_id: sensor.package_sigen_battery_in_by_hour_h23
- platform: homeassistant
  id: bout_h00
  entity_id: sensor.package_sigen_battery_out_by_hour_h00
- platform: homeassistant
  id: bout_h01
  entity_id: sensor.package_sigen_battery_out_by_hour_h01
- platform: homeassistant
  id: bout_h02
  entity_id: sensor.package_sigen_battery_out_by_hour_h02
- platform: homeassistant
  id: bout_h03
  entity_id: sensor.package_sigen_battery_out_by_hour_h03
- platform: homeassistant
  id: bout_h04
  entity_id: sensor.package_sigen_battery_out_by_hour_h04
- platform: homeassistant
  id: bout_h05
  entity_id: sensor.package_sigen_battery_out_by_hour_h05
- platform: homeassistant
  id: bout_h06
  entity_id: sensor.package_sigen_battery_out_by_hour_h06
- platform: homeassistant
  id: bout_h07
  entity_id: sensor.package_sigen_battery_out_by_hour_h07
- platform: homeassistant
  id: bout_h08
  entity_id: sensor.package_sigen_battery_out_by_hour_h08
- platform: homeassistant
  id: bout_h09
  entity_id: sensor.package_sigen_battery_out_by_hour_h09
- platform: homeassistant
  id: bout_h10
  entity_id: sensor.package_sigen_battery_out_by_hour_h10
- platform: homeassistant
  id: bout_h11
  entity_id: sensor.package_sigen_battery_out_by_hour_h11
- platform: homeassistant
  id: bout_h12
  entity_id: sensor.package_sigen_battery_out_by_hour_h12
- platform: homeassistant
  id: bout_h13
  entity_id: sensor.package_sigen_battery_out_by_hour_h13
- platform: homeassistant
  id: bout_h14
  entity_id: sensor.package_sigen_battery_out_by_hour_h14
- platform: homeassistant
  id: bout_h15
  entity_id: sensor.package_sigen_battery_out_by_hour_h15
- platform: homeassistant
  id: bout_h16
  entity_id: sensor.package_sigen_battery_out_by_hour_h16
- platform: homeassistant
  id: bout_h17
  entity_id: sensor.package_sigen_battery_out_by_hour_h17
- platform: homeassistant
  id: bout_h18
  entity_id: sensor.package_sigen_battery_out_by_hour_h18
- platform: homeassistant
  id: bout_h19
  entity_id: sensor.package_sigen_battery_out_by_hour_h19
- platform: homeassistant
  id: bout_h20
  entity_id: sensor.package_sigen_battery_out_by_hour_h20
- platform: homeassistant
  id: bout_h21
  entity_id: sensor.package_sigen_battery_out_by_hour_h21
- platform: homeassistant
  id: bout_h22
  entity_id: sensor.package_sigen_battery_out_by_hour_h22
- platform: homeassistant
  id: bout_h23
  entity_id: sensor.package_sigen_battery_out_by_hour_h23
- platform: homeassistant
  id: soc_h00
  entity_id: sensor.battery_soc_h00
- platform: homeassistant
  id: soc_h01
  entity_id: sensor.battery_soc_h01
- platform: homeassistant
  id: soc_h02
  entity_id: sensor.battery_soc_h02
- platform: homeassistant
  id: soc_h03
  entity_id: sensor.battery_soc_h03
- platform: homeassistant
  id: soc_h04
  entity_id: sensor.battery_soc_h04
- platform: homeassistant
  id: soc_h05
  entity_id: sensor.battery_soc_h05
- platform: homeassistant
  id: soc_h06
  entity_id: sensor.battery_soc_h06
- platform: homeassistant
  id: soc_h07
  entity_id: sensor.battery_soc_h07
- platform: homeassistant
  id: soc_h08
  entity_id: sensor.battery_soc_h08
- platform: homeassistant
  id: soc_h09
  entity_id: sensor.battery_soc_h09
- platform: homeassistant
  id: soc_h10
  entity_id: sensor.battery_soc_h10
- platform: homeassistant
  id: soc_h11
  entity_id: sensor.battery_soc_h11
- platform: homeassistant
  id: soc_h12
  entity_id: sensor.battery_soc_h12
- platform: homeassistant
  id: soc_h13
  entity_id: sensor.battery_soc_h13
- platform: homeassistant
  id: soc_h14
  entity_id: sensor.battery_soc_h14
- platform: homeassistant
  id: soc_h15
  entity_id: sensor.battery_soc_h15
- platform: homeassistant
  id: soc_h16
  entity_id: sensor.battery_soc_h16
- platform: homeassistant
  id: soc_h17
  entity_id: sensor.battery_soc_h17
- platform: homeassistant
  id: soc_h18
  entity_id: sensor.battery_soc_h18
- platform: homeassistant
  id: soc_h19
  entity_id: sensor.battery_soc_h19
- platform: homeassistant
  id: soc_h20
  entity_id: sensor.battery_soc_h20
- platform: homeassistant
  id: soc_h21
  entity_id: sensor.battery_soc_h21
- platform: homeassistant
  id: soc_h22
  entity_id: sensor.battery_soc_h22
- platform: homeassistant
  id: soc_h23
  entity_id: sensor.battery_soc_h23
- platform: homeassistant
  id: pv_now_w
  entity_id: sensor.package_sigen_pv_power
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_pv_now), "—"); return; }

      char b[20];

      float v = x;

      if (fabsf(v) >= 1000.0f) snprintf(b, sizeof(b), "%.1f kW", v/1000.0f);

      else snprintf(b, sizeof(b), "%.0f W", v);

      lv_label_set_text(id(lbl_pv_now), b);'
- platform: homeassistant
  id: solar_lifetime_raw
  entity_id: sensor.sigen_plant_total_pv_generation
  on_value:
  - lambda: '// --- OPTION A: lifetime is in kWh ---

      float mwh = x / 1000.0f;


      // --- OPTION B: lifetime is in Wh ---

      // float mwh = x / 1000000.0f;


      char b[24];

      snprintf(b, sizeof(b), "%.2f MWh", mwh);

      lv_label_set_text(id(lbl_solar_lifetime_value), b);'
- platform: homeassistant
  id: pv_daily
  entity_id: sensor.package_sigen_pv_daily
  on_value:
    lambda: if (std::isnan(x)) { lv_label_set_text(id(lbl_pv_daily), "—"); } else { char b[24]; snprintf(b,
      sizeof(b), "%.1f kWh", x); lv_label_set_text(id(lbl_pv_daily), b); }
- platform: homeassistant
  id: pv_weekly
  entity_id: sensor.package_sigen_pv_weekly
  on_value:
    lambda: if (std::isnan(x)) { lv_label_set_text(id(lbl_pv_weekly), "—"); } else { char b[24];
      snprintf(b, sizeof(b), "%.1f kWh", x); lv_label_set_text(id(lbl_pv_weekly), b); }
- platform: homeassistant
  id: pv_monthly
  entity_id: sensor.package_sigen_pv_monthly
  on_value:
    lambda: if (std::isnan(x)) { lv_label_set_text(id(lbl_pv_monthly), "—"); } else { char b[24];
      snprintf(b, sizeof(b), "%.1f kWh", x); lv_label_set_text(id(lbl_pv_monthly), b); }
- platform: homeassistant
  id: pv_yearly
  entity_id: sensor.package_sigen_pv_yearly
  on_value:
    lambda: if (std::isnan(x)) { lv_label_set_text(id(lbl_pv_yearly), "—"); } else { char b[24];
      snprintf(b, sizeof(b), "%.1f kWh", x); lv_label_set_text(id(lbl_pv_yearly), b); }
- platform: homeassistant
  id: pv_to_batt_w
  entity_id: sensor.package_sigen_pv_to_battery_w
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_pv_to_batt_now), "—"); return; }

      char b[20]; float v=x;

      if (fabsf(v)>=1000.0f) snprintf(b,sizeof(b),"%.1f kW",v/1000.0f);

      else snprintf(b,sizeof(b),"%.0f W",v);

      lv_label_set_text(id(lbl_pv_to_batt_now), b);'
- platform: homeassistant
  id: pv_to_grid_w
  entity_id: sensor.package_sigen_pv_to_grid_w
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_pv_to_grid_now), "—"); return; }

      char b[20]; float v=x;

      if (fabsf(v)>=1000.0f) snprintf(b,sizeof(b),"%.1f kW",v/1000.0f);

      else snprintf(b,sizeof(b),"%.0f W",v);

      lv_label_set_text(id(lbl_pv_to_grid_now), b);'
- platform: homeassistant
  id: pv_to_house_w
  entity_id: sensor.package_sigen_pv_to_house_w
  on_value:
  - lambda: 'if (std::isnan(x)) { lv_label_set_text(id(lbl_pv_to_house_now), "—"); return; }

      char b[20]; float v=x;

      if (fabsf(v)>=1000.0f) snprintf(b,sizeof(b),"%.1f kW",v/1000.0f);

      else snprintf(b,sizeof(b),"%.0f W",v);

      lv_label_set_text(id(lbl_pv_to_house_now), b);'
- platform: homeassistant
  id: pv_to_house_daily
  entity_id: sensor.package_sigen_pv_to_house_daily
  on_value:
    lambda: if (std::isnan(x)) { lv_label_set_text(id(lbl_pv2h_daily), "—"); } else { char b[24];
      snprintf(b, sizeof(b), "%.1f kWh", x); lv_label_set_text(id(lbl_pv2h_daily), b); }
- platform: homeassistant
  id: pv_to_house_weekly
  entity_id: sensor.package_sigen_pv_to_house_weekly
  on_value:
    lambda: if (std::isnan(x)) { lv_label_set_text(id(lbl_pv2h_weekly), "—"); } else { char b[24];
      snprintf(b, sizeof(b), "%.1f kWh", x); lv_label_set_text(id(lbl_pv2h_weekly), b); }
- platform: homeassistant
  id: pv_to_house_monthly
  entity_id: sensor.package_sigen_pv_to_house_monthly
  on_value:
    lambda: if (std::isnan(x)) { lv_label_set_text(id(lbl_pv2h_monthly), "—"); } else { char b[24];
      snprintf(b, sizeof(b), "%.1f kWh", x); lv_label_set_text(id(lbl_pv2h_monthly), b); }
- platform: homeassistant
  id: pv_to_house_yearly
  entity_id: sensor.package_sigen_pv_to_house_yearly
  on_value:
    lambda: if (std::isnan(x)) { lv_label_set_text(id(lbl_pv2h_yearly), "—"); } else { char b[24];
      snprintf(b, sizeof(b), "%.1f kWh", x); lv_label_set_text(id(lbl_pv2h_yearly), b); }
- platform: homeassistant
  id: solar_battery_time_remaining
  entity_id: sensor.solar_battery_time_remaining

- platform: homeassistant
  id: hu_dev1_usage
  entity_id: sensor.hu_device_1_usage

- platform: homeassistant
  id: hu_dev2_usage
  entity_id: sensor.hu_device_2_usage

- platform: homeassistant
  id: hu_dev3_usage
  entity_id: sensor.hu_device_3_usage

- platform: homeassistant
  id: hu_dev4_usage
  entity_id: sensor.hu_device_4_usage

- platform: homeassistant
  id: hu_dev5_usage
  entity_id: sensor.hu_device_5_usage


- platform: homeassistant
  id: hu_sp1_usage
  entity_id: sensor.hu_subpanel_1_usage

- platform: homeassistant
  id: hu_sp2_usage
  entity_id: sensor.hu_subpanel_2_usage

text_sensor:

- platform: wifi_info
  ip_address:
    name: WiFi IP
    id: wifi_ip_text
    on_value:
      - lambda: |-
          // In AP mode we always show the portal IP
          if (id(force_ap_mode)) {
            lv_label_set_text(id(lbl_wifi_ip), "192.168.4.1");
            return;
          }

          std::string s = x.c_str();
          lv_label_set_text(id(lbl_wifi_ip), s.empty() ? "--" : s.c_str());

  ssid:
    name: WiFi SSID
    id: wifi_ssid_text
    on_value:
      - lambda: |-
          // In AP mode we show the AP SSID (your editable fallback string)
          if (id(force_ap_mode)) {
            std::string ap = id(fallback_ap_ssid_str).c_str();
            lv_label_set_text(id(lbl_wifi_ssid), ap.empty() ? "--" : ap.c_str());
            return;
          }

          std::string s = x.c_str();
          lv_label_set_text(id(lbl_wifi_ssid), s.empty() ? "--" : s.c_str());

lvgl:
  id: my_lvgl

  top_layer:
    widgets:
      - obj:
          id: loading_overlay
          hidden: true
          clickable: false
          scrollable: false
          x: 0
          y: 0
          width: 1024
          height: 600
          bg_color: 0x000000
          bg_opa: 40%
          border_width: 0
          widgets:
            - obj:
                id: loading_card
                align: center
                width: 280
                height: 170
                radius: 20
                bg_color: 0x1C2229
                border_width: 1
                border_color: 0x333333
                scrollable: false
                widgets:
                  - arc:
                      id: loading_arc
                      align: top_mid
                      y: 18
                      width: 80
                      height: 80
                      min_value: 0
                      max_value: 100
                      value: 75
                      start_angle: 0
                      end_angle: 270
                      adjustable: false
                      indicator:
                        arc_width: 10
                        arc_color: 0x2E7D32
                        bg_opa: 0%
                        border_width: 0
                        pad_all: 0
                  - label:
                      id: loading_text
                      align: bottom_mid
                      y: 0
                      text: Loading…
                      text_font: my_font
                      text_color: 0xFFFFFF
      - obj:
          id: secret_overlay
          hidden: true
          clickable: true
          scrollable: false
          x: 0
          y: 0
          width: 1024
          height: 600
          bg_color: 0x000000
          bg_opa: 60%
          border_width: 0
          pad_all: 0
          # Tap the dark background to close
          on_click:
            - lvgl.widget.hide: secret_overlay
          widgets:
            - obj:
                id: secret_card
                align: center
                width: 820
                height: 320
                radius: 18
                bg_color: 0x1C2229
                border_width: 1
                border_color: 0x333333
                pad_all: 18
                clickable: true   # so taps on the card don't close the overlay
                scrollable: false
                widgets:
                  - label:
                      id: secret_title
                      text: Secret
                      text_font: my_font_large
                      text_color: 0xFFFFFF
                      x: 0
                      y: 0

                  - button:
                      id: btn_secret_close
                      width: 44
                      height: 44
                      radius: 22
                      align: top_right
                      x: 0
                      y: 0
                      bg_color: 0x2E3A46
                      pad_all: 0
                      on_click:
                        - lvgl.widget.hide: secret_overlay
                      widgets:
                        - label:
                            text: "\U000F0156"
                            align: center
                            text_font: mdi_60
                            text_color: 0xFFFFFF

                  - label:
                      id: secret_value
                      x: 0
                      y: 70
                      width: 784
                      height: 220
                      text: "-"
                      text_font: my_font_small
                      text_color: 0xFFFFFF
                      long_mode: WRAP
  pages:
  - id: boot_page
#    bg_color: 0x141B21
    bg_color: 0x1C2229
    widgets:
    - image:
        id: boot_logo
        src: esphome_logo
        align: center
        y: -38
        bg_opa: 0%
    - label:
        id: lbl_boot_status
        text: Starting…
        text_font: my_font
        text_color: 16777215
        align: center
        y: 150
    - button:
        id: btn_boot_menu
        width: 102
        height: 70
        align: top_right
        x: -38            # nudge from right edge
        y: 15             # nudge from top
        bg_color: 0x23282F
        bg_opa: 0
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        shadow_color: 0x23282F
        on_click:
          - lambda: |-
              id(hu_anim_enabled) = false;
              id(hu_home_usage_active) = false;
          - lvgl.widget.show: loading_overlay
          - delay: 20ms
          - lvgl.page.show: menu_page
          - delay: 250ms
          - lvgl.widget.hide: loading_overlay
        widgets:
          - image:
              src: img_menu_res
              align: center
              bg_opa: 0
              zoom: 0.5
  - id: home_usage_page
    bg_color: 0x141B21
    on_load:
      then:
        - lambda: |-
            id(hu_home_usage_active) = true;
            id(hu_anim_enabled) = true;
    on_unload:
      then:
        - lambda: |-
            id(hu_home_usage_active) = false;
            id(hu_anim_enabled) = false;
              id(hu_home_usage_active) = false;
    widgets:
      # Title
      - line:
          id: hu_line_d1
          x: 0
          y: 0
          width: 1024
          height: 600
          line_width: 3
          line_color: 0x334455
          line_rounded: true
          points:
            - x: 0
              y: 1

      - line:
          id: hu_line_d2
          x: 0
          y: 0
          width: 1024
          height: 600
          line_width: 3
          line_color: 0x334455
          line_rounded: true
          points:
            - x: 0
              y: 1

      - line:
          id: hu_line_d3
          x: 0
          y: 0
          width: 1024
          height: 600
          line_width: 3
          line_color: 0x334455
          line_rounded: true
          points:
            - x: 0
              y: 1

      - line:
          id: hu_line_d4
          x: 0
          y: 0
          width: 1024
          height: 600
          line_width: 3
          line_color: 0x334455
          line_rounded: true
          points:
            - x: 0
              y: 1

      - line:
          id: hu_line_d5
          x: 0
          y: 0
          width: 1024
          height: 600
          line_width: 3
          line_color: 0x334455
          line_rounded: true
          points:
            - x: 0
              y: 1      

      - line:
          id: hu_line_sp1
          x: 0
          y: 0
          width: 1024
          height: 600
          line_width: 3
          line_color: 0x334455
          line_rounded: true
          points:
            - x: 0
              y: 0
            - x: 0
              y: 1

      - line:
          id: hu_line_sp2
          x: 0
          y: 0
          width: 1024
          height: 600
          line_width: 3
          line_color: 0x334455
          line_rounded: true
          points:
            - x: 0
              y: 0
            - x: 0
              y: 1

      # 
      # Home -> Subpanel 1 flow dots (6 dots)
      - obj:
          id: hu_sp1_dot_0
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
      - obj:
          id: hu_sp1_dot_1
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
      - obj:
          id: hu_sp1_dot_2
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
      - obj:
          id: hu_sp1_dot_3
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
      - obj:
          id: hu_sp1_dot_4
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
      - obj:
          id: hu_sp1_dot_5
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0

      # Home -> Subpanel 2 flow dots (6 dots)
      - obj:
          id: hu_sp2_dot_0
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
      - obj:
          id: hu_sp2_dot_1
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
      - obj:
          id: hu_sp2_dot_2
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
      - obj:
          id: hu_sp2_dot_3
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
      - obj:
          id: hu_sp2_dot_4
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
      - obj:
          id: hu_sp2_dot_5
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0

#Home -> Device 1 flow dots (6 dots)
      - obj:
          id: hu_d1_dot_0
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32      # green-ish, adjust as you like
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d1_dot_1
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d1_dot_2
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d1_dot_3
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d1_dot_4
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d1_dot_5
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20
      - obj:
          id: hu_d2_dot_0
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32      # green-ish, adjust as you like
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d2_dot_1
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d2_dot_2
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d2_dot_3
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d2_dot_4
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d2_dot_5
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d3_dot_0
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32      # green-ish, adjust as you like
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d3_dot_1
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d3_dot_2
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d3_dot_3
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d3_dot_4
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d3_dot_5
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d4_dot_0
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32      # green-ish, adjust as you like
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d4_dot_1
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d4_dot_2
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d4_dot_3
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d4_dot_4
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d4_dot_5
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20
      - obj:
          id: hu_d5_dot_0
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32      # green-ish, adjust as you like
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d5_dot_1
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d5_dot_2
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d5_dot_3
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d5_dot_4
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20

      - obj:
          id: hu_d5_dot_5
          hidden: true
          width: 10
          height: 10
          radius: 5
          bg_color: 0x2E7D32
          border_width: 0
          x: -20
          y: -20
      - button:
          id: hu_btn_menu
          width: 102
          height: 70
          align: top_right
          x: -38            # nudge from right edge
          y: 15             # nudge from top
          bg_color: 0x23282F
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          pad_all: 0
          shadow_color: 0x23282F
          on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lambda: |-
                id(hu_home_usage_active) = false;
            - lvgl.page.show: menu_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - image:
                src: img_menu_res
                align: center
                bg_opa: 0
                zoom: 0.6    
      - label:
          id: hu_title
          text: "Home usage"
          x: 40
          y: 20
          text_color: 0xFFFFFF
          text_font: my_font_large    # or whatever you use for big titles

      # Home node on the LEFT (reuse your existing home icon)
      - image:
          id: hu_node_home
          src: node_home_100          # same home icon as on your info flow page
          x: 80
          y: 240


      - label:
          id: hu_home_usage_value_label
          text: "0 W"
          text_font: my_font_medium
          x: 60
          y: 350
          text_color: 0xFFFFFF

      # ─── Subpanels (middle) ───
      - image:
          id: hu_sp1_icon
          src: hu_icon_homecog
          x: 390
          y: 110
          bg_opa: 0
          zoom: 0.9
          hidden: true
      - label:
          id: hu_sp1_name
          text: "Subpanel 1"
          x: 360
          y: 175
          text_color: 0xB4DCFF
          text_font: my_font
          hidden: true
      - label:
          id: hu_sp1_value
          text: ""
          x: 360
          y: 200
          text_color: 0xFFFFFF
          text_font: my_font_medium
          hidden: true

      - image:
          id: hu_sp2_icon
          src: hu_icon_homecog
          x: 390
          y: 445
          bg_opa: 0
          zoom: 0.9
          hidden: true
      - label:
          id: hu_sp2_name
          text: "Subpanel 2"
          x: 360
          y: 510
          text_color: 0xB4DCFF
          text_font: my_font
          hidden: true
      - label:
          id: hu_sp2_value
          text: ""
          x: 360
          y: 535
          text_color: 0xFFFFFF
          text_font: my_font_medium
          hidden: true


      # ─── Device placeholders on the RIGHT ───
      # Using solar icon as placeholder, slightly smaller

      # Device 1
      - image:
          id: hu_dev1_icon
          src: hu_icon_homecog        # placeholder icon
          x: 720
          y: 120
          bg_opa: 0
          zoom: 0.9
      - label:
          id: hu_dev1_name
          text: "Device 1"
          x: 780
          y: 120
          text_color: 0xB4DCFF
          text_font: my_font
      - label:
          id: hu_dev1_value
          text: "--"
          x: 780
          y: 150
          text_color: 0xFFFFFF
          text_font: my_font

      # Device 2
      - image:
          id: hu_dev2_icon
          src: hu_icon_homecog
          x: 720
          y: 220
          bg_opa: 0
          zoom: 0.9
      - label:
          id: hu_dev2_name
          text: "Device 2"
          x: 780
          y: 220
          text_color: 0xB4DCFF
          text_font: my_font
      - label:
          id: hu_dev2_value
          text: "--"
          x: 780
          y: 250
          text_color: 0xFFFFFF
          text_font: my_font

      # Device 3
      - image:
          id: hu_dev3_icon
          src: hu_icon_homecog
          x: 720
          y: 320
          bg_opa: 0
          zoom: 0.9
      - label:
          id: hu_dev3_name
          text: "Device 3"
          x: 780
          y: 320
          text_color: 0xB4DCFF
          text_font: my_font
      - label:
          id: hu_dev3_value
          text: "--"
          x: 780
          y: 350
          text_color: 0xFFFFFF
          text_font: my_font

      # Device 4
      - image:
          id: hu_dev4_icon
          src: hu_icon_homecog
          bg_opa: 0
          zoom: 0.9
          x: 720
          y: 420
      - label:
          id: hu_dev4_name
          text: "Device 4"
          x: 780
          y: 420
          text_color: 0xB4DCFF
          text_font: my_font
      - label:
          id: hu_dev4_value
          text: "--"
          x: 780
          y: 450
          text_color: 0xFFFFFF
          text_font: my_font

      # Device 5
      - image:
          id: hu_dev5_icon
          src: hu_icon_homecog
          bg_opa: 0
          zoom: 0.9
          x: 720
          y: 520
      - label:
          id: hu_dev5_name
          text: "Device 5"
          x: 780
          y: 520
          text_color: 0xB4DCFF
          text_font: my_font
      - label:
          id: hu_dev5_value
          text: "--"
          x: 780
          y: 550
          text_color: 0xFFFFFF
          text_font: my_font
          
  - id: home_page
    bg_color: 0x141B21
    border_width: 0
    outline_width: 0
    shadow_width: 0
    pad_all: 0
    scrollable: false
    scrollbar_mode: 'off'
    widgets:
    - obj:
        id: col_solar
        x: 51
        y: 150
        width: 282
        height: 400
        bg_opa: 0%
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        widgets:
        - image:
            id: img_home_solar
            src: node_solar_img
            align: top_mid
            bg_opa: 0%
            clickable: true
            on_click:
              - lvgl.widget.show: loading_overlay
              - delay: 20ms
              - lvgl.page.show: solar_page
              - delay: 250ms
              - lvgl.widget.hide: loading_overlay
        - image:
            id: img_home_grid
            src: node_grid_100
            align: top_mid
            bg_opa: 0%
            clickable: true
            on_click:
              - lvgl.widget.show: loading_overlay
              - delay: 20ms
              - lvgl.page.show: grid_page
              - delay: 250ms
              - lvgl.widget.hide: loading_overlay
        - label:
            id: solar_input_value_label
            text: 0 W
            text_font: my_font_large
            text_color: 65280
            align: bottom_mid
            y: -125
    - obj:
        id: col_battery
        x: 307
        y: 150
        width: 410
        height: 400
        bg_opa: 0%
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        widgets:
        - image:
            id: img_home_battery
            src: node_battery_100
            align: top_mid
            bg_opa: 0%
            clickable: true
            on_click:
              - lvgl.widget.show: loading_overlay
              - delay: 20ms
              - lvgl.page.show: battery_page
              - delay: 250ms
              - lvgl.widget.hide: loading_overlay
        - label:
            id: battery_percent_label
            text: 0%
            text_font: my_font
            text_color: 16777215
            align: center
            y: 0
        - bar:
            id: battery_bar
            width: 384
            height: 28
            value: 0
            align: bottom_mid
            y: -138
            border_width: 0
            outline_width: 0
            shadow_width: 0
            pad_all: 0
            bg_color: 0
            bg_opa: 100%
    - obj:
        id: col_home
        x: 717
        y: 150
        width: 256
        height: 400
        bg_opa: 0%
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        widgets:
        - image:
            id: img_home_home
            src: node_home_100
            align: top_mid
            bg_opa: 0%
            clickable: true
            on_click:
              - if:
                  condition:
                    switch.is_on: change_homepage 
                  then:
                    - lvgl.widget.show: loading_overlay
                    - delay: 20ms
                    - lvgl.page.show: home_page         # old/original homepage
                    - delay: 250ms
                    - lvgl.widget.hide: loading_overlay
                  else:
                    - lvgl.widget.show: loading_overlay
                    - delay: 20ms
                    - lvgl.page.show: home_page_2       # new homepage
                    - delay: 250ms
                    - lvgl.widget.hide: loading_overlay
        - label:
            id: home_usage_value_label
            text: 0 W
            text_font: my_font_large
            text_color: mdi_red
            align: bottom_mid
            y: -125
    - button:
        id: btn_topright_home
        width: 102
        height: 70
        align: top_right
        x: -38            # nudge from right edge
        y: 15             # nudge from top
        bg_color: 0x23282F
        bg_opa: 0
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        shadow_color: 0x23282F
        on_click:
          - lvgl.widget.show: loading_overlay
          - delay: 20ms
          - lvgl.page.show: menu_page
          - delay: 250ms
          - lvgl.widget.hide: loading_overlay
        widgets:
          - image:
              src: img_menu_res
              align: center
              bg_opa: 0
              zoom: 0.5  

    - obj:
        id: suggestion_box
        x: 0
        y: 125
        width: 1024
        height: 150
        bg_color: 2236962
        bg_opa: 100%
        border_width: 4
        border_color: 16711680
        radius: 10
        align: top_mid
        widgets:
        - label:
            id: suggestion_label
            text: ''
            text_font: my_font_medium
            text_color: 16777215
            long_mode: wrap
            align: center
            x: 0
            y: 0

  - id: home_page_2
    bg_color: 0x141B21
    border_width: 0
    outline_width: 0
    shadow_width: 0
    pad_all: 0
    scrollable: false
    scrollbar_mode: 'off'
    widgets:
    - obj:
        id: hp2_row
        width: 1024           # set near your screen width (e.g., 800 for 800px wide)
        height: 325
        align: top_mid        # center this container on the page
        y: 88
        bg_opa: 0%          # <— make the row fully transparent
        border_opa: 0%
        outline_opa: 0%
        shadow_width: 0        
        layout:
          type: flex
          flex_flow: row
          flex_align_main: center     # <— center along the row
          flex_align_cross: center    # <— center along the column
          pad_column: 16            # <— even gaps between cards
          pad_row: 0
        widgets:
          - obj:
              id: hp2_card_solar
              x: 51
              y: 150
              width: 211
              height: 288
              radius: 19
              bg_color: 0x1C2229
              shadow_width: 6
              shadow_color: 0x222222
              border_width: 0
              outline_width: 0
              scrollable: false
              scrollbar_mode: 'off'         
              pad_all: 0
              pad_top: 0
              pad_bottom: 12
              pad_left: 12
              pad_right: 12
              on_click:
                then:
                  - lvgl.widget.show: loading_overlay
                  - delay: 20ms
                  - lvgl.page.show: solar_info_page
                  - delay: 250ms
                  - lvgl.widget.hide: loading_overlay
              widgets:
              - image:
                  id: hp2_img_solar_inst
                  src: hp2_img_solar
                  align: top_mid
                  y: -60
                  bg_opa: 0%
                  zoom: 0.7
              - label:
                  text: Solar
                  text_font: my_font_medium
                  text_color: 0xFFFFFF
                  align: bottom_mid
                  y: -100
              - label:
                  id: hp2_lbl_solar_w
                  text: "0 W"
                  text_font: my_font_medium
                  align: bottom_mid
                  text_color: 0xFFFFFF
                  y: -56
                  text_align: center
          - obj:
              id: hp2_card_home
              x: 269
              y: 150
              width: 211
              height: 288
              radius: 19
              bg_color: 0x1C2229
              shadow_width: 6
              shadow_color: 0x222222
              border_width: 0
              outline_width: 0
              scrollable: false
              scrollbar_mode: 'off'
              pad_all: 0
              pad_top: 0
              pad_bottom: 12
              pad_left: 12
              pad_right: 12
              on_click:
                then:
                  - lvgl.widget.show: loading_overlay
                  - delay: 20ms
                  - lvgl.page.show: home_usage_page
                  - delay: 250ms
                  - lvgl.widget.hide: loading_overlay
              widgets:
              - image:
                  id: hp2_img_home_inst
                  src: hp2_img_home
                  align: top_mid
                  y: -60
                  bg_opa: 0%
                  zoom: 0.7
              - label:
                  text: Home
                  text_font: my_font_medium
                  text_color: 0xFFFFFF
                  align: bottom_mid
                  y: -100
              - label:
                  id: hp2_lbl_home_w
                  text: "0 W"
                  text_font: my_font_medium
                  align: bottom_mid
                  text_color: 0xFFFFFF
                  y: -56
                  text_align: center
          - obj:
              id: hp2_card_grid
              x: 486
              y: 150
              width: 211
              height: 288
              radius: 19
              bg_color: 0x1C2229
              shadow_width: 6
              shadow_color: 0x222222
              border_width: 0
              outline_width: 0
              scrollable: false
              scrollbar_mode: 'off'
              pad_all: 0
              pad_top: 0
              pad_bottom: 12
              pad_left: 12
              pad_right: 12
              on_click:
                then:
                  - lvgl.widget.show: loading_overlay
                  - delay: 20ms
                  - lvgl.page.show: grid_page
                  - delay: 250ms
                  - lvgl.widget.hide: loading_overlay
              widgets:
              - image:
                  id: hp2_img_grid_inst
                  src: hp2_img_grid
                  align: top_mid
                  y: -60
                  bg_opa: 0%
                  zoom: 0.7
              - label:
                  text: Grid
                  text_font: my_font_medium
                  text_color: 0xFFFFFF
                  align: bottom_mid
                  y: -100
              - label:
                  id: hp2_lbl_grid_w
                  text: "0 W"
                  text_font: my_font_medium
                  align: bottom_mid
                  text_color: 0xFFFFFF
                  y: -56
                  text_align: center
              - image:
                  id: hp2_img_grid_arrow_up_inst      # WIDGET (lv_img)
                  src: arrow_up_res                   # points to resource
                  y: 125
                  x: -40
                  bg_opa: 0%
                  hidden: true
                  zoom: 0.2

              - image:
                  id: hp2_img_grid_arrow_down_inst    # WIDGET (lv_img)
                  src: arrow_down_res
                  y: 125
                  x: -40
                  bg_opa: 0%
                  hidden: false
                  zoom: 0.2
          - obj:
              id: hp2_card_battery
              x: 704
              y: 150
              width: 211
              height: 288
              radius: 19
              bg_color: 0x1C2229
              shadow_width: 6
              shadow_color: 0x222222
              border_width: 0
              outline_width: 0
              scrollable: false
              scrollbar_mode: 'off'
              pad_all: 0
              pad_top: 0
              pad_bottom: 12
              pad_left: 12
              pad_right: 12
              on_click:
                then:
                  - lvgl.widget.show: loading_overlay
                  - delay: 20ms
                  - lvgl.page.show: battery_page
                  - delay: 250ms
                  - lvgl.widget.hide: loading_overlay
              widgets:
              - image:
                  id: hp2_batt_img_0010
                  src: hp2_batt_0010
                  align: top_mid
                  y: 0
                  zoom: 1
                  bg_opa: 0%
              - image:
                  id: hp2_batt_img_1020
                  src: hp2_batt_1020
                  align: top_mid
                  y: 0
                  bg_opa: 0%
                  zoom: 1
                  hidden: true
              - image:
                  id: hp2_batt_img_2030
                  src: hp2_batt_2030
                  align: top_mid
                  y: 0
                  bg_opa: 0%
                  zoom: 1
                  hidden: true
              - image:
                  id: hp2_batt_img_3040
                  src: hp2_batt_3040
                  align: top_mid
                  y: 0
                  bg_opa: 0%
                  zoom: 1
                  hidden: true
              - image:
                  id: hp2_batt_img_4050
                  src: hp2_batt_4050
                  align: top_mid
                  y: 0
                  bg_opa: 0%
                  zoom: 1
                  hidden: true
              - image:
                  id: hp2_batt_img_5060
                  src: hp2_batt_5060
                  align: top_mid
                  y: 0
                  bg_opa: 0%
                  zoom: 1
                  hidden: true
              - image:
                  id: hp2_batt_img_6070
                  src: hp2_batt_6070
                  align: top_mid
                  y: 0
                  bg_opa: 0%
                  zoom: 1
                  hidden: true
              - image:
                  id: hp2_batt_img_7080
                  src: hp2_batt_7080
                  align: top_mid
                  y: 0
                  bg_opa: 0%
                  zoom: 1
                  hidden: true
              - image:
                  id: hp2_batt_img_8090
                  src: hp2_batt_8090
                  align: top_mid
                  y: 0
                  bg_opa: 0%
                  zoom: 1
                  hidden: true
              - image:
                  id: hp2_batt_img_90100
                  src: hp2_batt_90100
                  align: top_mid
                  y: 0
                  bg_opa: 0%
                  zoom: 1
                  hidden: true
              - label:
                  text: Battery
                  text_font: my_font_medium
                  text_color: 0xFFFFFF
                  align: bottom_mid
                  y: -100
              - label:
                  id: hp2_lbl_batt_power
                  text: "+0 W"
                  text_font: my_font_medium
                  align: bottom_mid
                  y: -56
                  text_align: center
              - label:
                  id: hp2_lbl_batt_pct
                  text: "0 %"
                  text_font: my_font_medium
                  align: bottom_mid
                  text_color: 0xFFFFFF
                  y: -12
                  text_align: center
    - obj:
        id: hp2_summary_card
        width: 890
        height: 119
        align: top_mid
        scrollable: false
        scrollbar_mode: 'off'
        pad_all: 0
        pad_top: 4
        pad_bottom: 4
        pad_left: 5
        pad_right: 5        
        y: 400                   # sits under the cards; adjust if needed
        radius: 19
        bg_color: 0x1C2229
        shadow_width: 0
        border_opa: 0%
        outline_opa: 0%
        layout:
          type: flex
          flex_flow: column
          flex_align_main: start
          flex_align_cross: start
        widgets:
          # top divider row with two labels
          - obj:
              width: 880
              height: 45
              pad_all: 0
              pad_top: 0
              pad_bottom: 1
              pad_left: 0
              pad_right: 500
              shadow_width: 0
              border_opa: 0%
              outline_opa: 0%
              scrollable: false
              scrollbar_mode: 'off'
              bg_color: 0x1C2229
              layout:
                type: flex
                flex_flow: row
                flex_align_main: space_between
                flex_align_cross: center
              widgets:
                - label:
                    id: hp2_lbl_exported_today_caption
                    text: "Exported today"
                    align: TOP_LEFT
                    x: 31
                    text_color: 0xE0E0E0
                    text_font: my_font
                - label:
                    id: hp2_lbl_exported_today_value
                    text: "--"
                    align: TOP_LEFT
                    text_color: 0xFFFFFF
                    text_font: my_font

          # thin divider
          - obj:
              width: 860
              height: 1
              bg_color: 0x3A3F46

          # bottom row
          - obj:
              width: 880
              height: 38
              pad_all: 0
              pad_top: 0
              pad_bottom: 0
              pad_left: 0
              pad_right: 500
              shadow_width: 0
              border_opa: 0%
              outline_opa: 0%
              scrollable: false
              scrollbar_mode: 'off'
              bg_color: 0x1C2229
              layout:
                type: flex
                flex_flow: row
                flex_align_main: space_between
                flex_align_cross: center
              widgets:
                - label:
                    id: hp2_lbl_selfuse_today_caption
                    text: "Self-use today"
                    align: TOP_LEFT
                    x: 31
                    text_color: 0xE0E0E0
                    text_font: my_font
                - label:
                    id: hp2_lbl_selfuse_today_value
                    text: "--"
                    align: TOP_LEFT
                    text_color: 0xFFFFFF
                    text_font: my_font
                  
    - button:
        id: hp2_btn_menu
        width: 102
        height: 70
        align: top_right
        x: -38            # nudge from right edge
        y: 15             # nudge from top
        bg_color: 0x23282F
        bg_opa: 0
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        shadow_color: 0x23282F
        on_click:
          - lvgl.widget.show: loading_overlay
          - delay: 20ms
          - lvgl.page.show: menu_page
          - delay: 250ms
          - lvgl.widget.hide: loading_overlay
        widgets:
          - image:
              src: img_menu_res
              align: center
              bg_opa: 0
              zoom: 0.6           
    - button:
        id: hp2_btn_esphome
        width: 102
        height: 70
        align: top_right
        x: -909         # nudge from right edge
        y: 15             # nudge from top
        bg_color: 0x23282F
        bg_opa: 0
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        shadow_color: 0x23282F
        on_click:
          - lvgl.widget.show: loading_overlay
          - delay: 20ms
          - lvgl.page.show: menu_page
          - delay: 250ms
          - lvgl.widget.hide: loading_overlay
        widgets:
          - image:
              src: esphome_logo
              align: center
              bg_opa: 0
              zoom: 0.25          

    - label:
        id: hp2_lbl_suggestion
        text: ""
        width: 973
        align: bottom_mid
        y: -10                    # lift a little from the edge
        text_align: center
        text_color: 0xFFFFFF
        text_font: my_font_medium
        long_mode: wrap
  - id: solar_info_page
    bg_color: 0x141B21
    widgets:
    - image:
        id: node_solar
        src: node_solar_img
        x: 448
        y: 12
        clickable: true
        on_click:
        - lvgl.widget.show: loading_overlay
        - delay: 20ms
        - lvgl.page.show: solar_page
        - delay: 250ms
        - lvgl.widget.hide: loading_overlay
    - image:
        id: node_home
        src: node_home_100
        x: 781
        y: 238
        clickable: true
        on_click:
          - if:
              condition:
                switch.is_on: change_homepage 
              then:
                - lvgl.widget.show: loading_overlay
                - delay: 20ms
                - lvgl.page.show: home_page         # old/original homepage
                - delay: 250ms
                - lvgl.widget.hide: loading_overlay
              else:
                - lvgl.widget.show: loading_overlay
                - delay: 20ms
                - lvgl.page.show: home_page_2       # new homepage
                - delay: 250ms
                - lvgl.widget.hide: loading_overlay
    - obj:
        id: batt_soc_circle
        width: 82
        height: 80
        radius: 40
        bg_opa: 0%
        border_width: 6
        border_color: 3355443
        scrollable: false
        scrollbar_mode: 'off'
        align: RIGHT_MID
        x: -15
        y: 38
        widgets:
        - label:
            id: batt_soc_circle_text
            text: --%
            text_font: my_font_small
            text_color: 16777215
            long_mode: clip
            align: CENTER
            scrollable: false
    - arc:
        id: batt_soc_arc
        width: 82
        height: 80
        value: 0
        min_value: 0
        max_value: 100
        rotation: 270
        start_angle: 0
        end_angle: 360
        arc_width: 6
        arc_color: 3355443
        indicator:
          arc_width: 6
          arc_color: 1234773
        scrollable: false
        scrollbar_mode: 'off'
        align: TOP_LEFT
        x: -102
        y: -100
    - image:
        id: node_battery
        src: node_battery_100
        x: 448
        y: 438
        clickable: true
        on_click:
        - lvgl.widget.show: loading_overlay
        - delay: 20ms
        - lvgl.page.show: battery_page
        - delay: 250ms
        - lvgl.widget.hide: loading_overlay
    - image:
        id: node_grid
        src: node_grid_100
        x: 115
        y: 238
        clickable: true
        on_click:
        - lvgl.widget.show: loading_overlay
        - delay: 20ms
        - lvgl.page.show: grid_page
        - delay: 250ms
        - lvgl.widget.hide: loading_overlay
    - obj:
        id: g2h_dot_0
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2h_dot_1
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2h_dot_2
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2h_dot_3
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2h_dot_4
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2h_dot_5
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: grid2h_dot_0
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: grid2h_dot_1
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: grid2h_dot_2
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: grid2h_dot_3
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: grid2h_dot_4
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: grid2h_dot_5
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: b2h_dot_0
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: b2h_dot_1
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: b2h_dot_2
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: b2h_dot_3
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: b2h_dot_4
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: b2h_dot_5
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: g2b_dot_0
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2b_dot_1
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2b_dot_2
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2b_dot_3
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2b_dot_4
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2b_dot_5
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: grid2b_dot_0
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: grid2b_dot_1
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: grid2b_dot_2
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: grid2b_dot_3
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: grid2b_dot_4
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: grid2b_dot_5
        width: 10
        height: 10
        radius: 5
        bg_color: 1225943
        border_width: 0
    - obj:
        id: g2g_dot_0
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2g_dot_1
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2g_dot_2
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2g_dot_3
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2g_dot_4
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: g2g_dot_5
        width: 10
        height: 10
        radius: 5
        bg_color: 14132754
        border_width: 0
    - obj:
        id: b2g_dot_0
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: b2g_dot_1
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: b2g_dot_2
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: b2g_dot_3
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: b2g_dot_4
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - obj:
        id: b2g_dot_5
        width: 10
        height: 10
        radius: 5
        bg_color: 1234773
        border_width: 0
    - label:
        id: lbl_g2h
        x: 678
        y: 162
        text: ''
        text_color: 14132754
        text_font: my_font
    - label:
        id: lbl_grid2h
        x: 512
        y: 262
        text: ''
        text_color: 1225943
        text_font: my_font
    - label:
        id: lbl_pv_total_info
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_home_total_info
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_grid_totals_info
        text: ''
        text_font: my_font_small
        text_color: 16777215
        width: 205
    - label:
        id: lbl_batt_totals_info
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_b2h
        x: 678
        y: 375
        text: ''
        text_color: 1234773
        text_font: my_font
    - label:
        id: lbl_g2b
        x: 512
        y: 262
        text: ''
        text_color: 14132754
        text_font: my_font
    - label:
        id: lbl_grid2b
        x: 346
        y: 375
        text: ''
        text_color: 1225943
        text_font: my_font
    - label:
        id: lbl_g2g
        x: 346
        y: 162
        text: ''
        text_color: 14132754
        text_font: my_font
    - label:
        id: lbl_b2g
        x: 346
        y: 375
        text: ''
        text_color: 1234773
        text_font: my_font
    - button:
        id: btn_topright_info
        width: 102
        height: 70
        align: top_right
        x: -38            # nudge from right edge
        y: 15             # nudge from top
        bg_color: 0x23282F
        bg_opa: 0
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        shadow_color: 0x23282F
        on_click:
          - lvgl.widget.show: loading_overlay
          - delay: 20ms
          - lvgl.page.show: menu_page
          - delay: 250ms
          - lvgl.widget.hide: loading_overlay
        widgets:
          - image:
              src: img_menu_res
              align: center
              bg_opa: 0
              zoom: 0.5      

  - id: battery_page
    bg_color: 0x141B21
    widgets:
    - label:
        x: 51
        y: 20
        text: Battery
        text_font: my_font_large
        text_color: 16777215
    - obj:
        id: card_batt_in
        x: 77
        y: 100
        width: 384
        height: 500
        bg_opa: 0%
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        widgets:
        - label:
            x: 0
            y: 0
            text: Charging
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 62
            text: Now
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_in_now
            x: 154
            y: 62
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 125
            text: Today
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_in_daily
            x: 154
            y: 125
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 188
            text: Week
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_in_weekly
            x: 154
            y: 188
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 250
            text: Month
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_in_monthly
            x: 154
            y: 250
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 312
            text: Year
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_in_yearly
            x: 154
            y: 312
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215
    - obj:
        id: card_batt_out
        x: 576
        y: 100
        width: 384
        height: 500
        bg_opa: 0%
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        widgets:
        - label:
            x: 0
            y: 0
            text: Discharging
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 62
            text: To House
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_to_house_now
            x: 154
            y: 62
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 125
            text: To Grid
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_to_grid_now
            x: 154
            y: 125
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 188
            text: Today
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_out_daily
            x: 154
            y: 188
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 250
            text: Week
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_out_weekly
            x: 154
            y: 250
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 312
            text: Month
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_out_monthly
            x: 154
            y: 312
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 375
            text: Year
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_batt_out_yearly
            x: 154
            y: 375
            width: 179
            text: --
            text_font: my_font
            text_color: 16777215

    - button:
        id: btn_topright_battery
        width: 102
        height: 70
        align: top_right
        x: -38            # nudge from right edge
        y: 15             # nudge from top
        bg_color: 0x23282F
        bg_opa: 0
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        shadow_color: 0x23282F
        on_click:
          - lvgl.widget.show: loading_overlay
          - delay: 20ms
          - lvgl.page.show: menu_page
          - delay: 250ms
          - lvgl.widget.hide: loading_overlay
        widgets:
          - image:
              src: img_menu_res
              align: center
              bg_opa: 0
              zoom: 0.5                              

  - id: solar_page
    bg_color: 0x141B21
    widgets:
    - label:
        x: 51
        y: 20
        text: Solar
        text_font: my_font_large
        text_color: 16777215
    - obj:
        id: card_pv_prod
        x: 77
        y: 100
        width: 384
        height: 500
        bg_opa: 0%
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        widgets:
        - label:
            x: 0
            y: 0
            text: Production
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 62
            text: Now
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv_now
            x: 154
            y: 62
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 125
            text: Lifetime
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_solar_lifetime_value
            x: 154
            y: 125
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 188
            text: Today
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv_daily
            x: 154
            y: 188
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 250
            text: Week
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv_weekly
            x: 154
            y: 250
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 312
            text: Month
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv_monthly
            x: 154
            y: 312
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 375
            text: Year
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv_yearly
            x: 154
            y: 375
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
    - obj:
        id: card_pv_dist
        x: 576
        y: 100
        width: 384
        height: 500
        bg_opa: 0%
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        widgets:
        - label:
            x: 0
            y: 0
            text: PV Distribution
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 62
            text: To House
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv_to_house_now
            x: 154
            y: 62
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 125
            text: To Grid
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv_to_grid_now
            x: 154
            y: 125
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 188
            text: To Battery
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv_to_batt_now
            x: 154
            y: 188
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 262
            text: PV to House Totals
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 312
            text: Today
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv2h_daily
            x: 154
            y: 312
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 375
            text: Week
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv2h_weekly
            x: 154
            y: 375
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 438
            text: Month
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv2h_monthly
            x: 154
            y: 438
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 500
            text: Year
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_pv2h_yearly
            x: 154
            y: 500
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
    - button:
        id: btn_topright_solar
        width: 102
        height: 70
        align: top_right
        x: -38            # nudge from right edge
        y: 15             # nudge from top
        bg_color: 0x23282F
        bg_opa: 0
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        shadow_color: 0x23282F
        on_click:
          - lvgl.widget.show: loading_overlay
          - delay: 20ms
          - lvgl.page.show: menu_page
          - delay: 250ms
          - lvgl.widget.hide: loading_overlay
        widgets:
          - image:
              src: img_menu_res
              align: center
              bg_opa: 0
              zoom: 0.5  

  - id: grid_page
    bg_color: 0x141B21
    widgets:
    - label:
        x: 51
        y: 20
        text: Grid
        text_font: my_font_large
        text_color: 16777215
    - obj:
        id: card_import
        x: 77
        y: 100
        width: 384
        height: 500
        bg_opa: 0%
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        widgets:
        - label:
            x: 0
            y: 0
            text: Import
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 62
            text: Now
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_import_now
            x: 154
            y: 62
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 125
            text: Today
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_import_daily
            x: 154
            y: 125
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 188
            text: Week
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_import_weekly
            x: 154
            y: 188
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 250
            text: Month
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_import_monthly
            x: 154
            y: 250
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 312
            text: Year
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_import_yearly
            x: 154
            y: 312
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
    - obj:
        id: card_export
        x: 576
        y: 100
        width: 384
        height: 500
        bg_opa: 0%
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        widgets:
        - label:
            x: 0
            y: 0
            text: Export
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 62
            text: Now
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_export_now
            x: 154
            y: 62
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 125
            text: Today
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_export_daily
            x: 154
            y: 125
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 188
            text: Week
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_export_weekly
            x: 154
            y: 188
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 250
            text: Month
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_export_monthly
            x: 154
            y: 250
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215
        - label:
            x: 0
            y: 312
            text: Year
            text_font: my_font
            text_color: mdi_grey
        - label:
            id: lbl_export_yearly
            x: 154
            y: 312
            width: 205
            text: --
            text_font: my_font
            text_color: 16777215

    - button:
        id: btn_topright_grid
        width: 102
        height: 70
        align: top_right
        x: -38            # nudge from right edge
        y: 15             # nudge from top
        bg_color: 0x23282F
        bg_opa: 0
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        shadow_color: 0x23282F
        on_click:
          - lvgl.widget.show: loading_overlay
          - delay: 20ms
          - lvgl.page.show: menu_page
          - delay: 250ms
          - lvgl.widget.hide: loading_overlay
        widgets:
          - image:
              src: img_menu_res
              align: center
              bg_opa: 0
              zoom: 0.5  

  - id: menu_page
    bg_color: 0x141B21
    widgets:
      - label:
          x: 51
          y: 20
          text: Menu
          text_font: my_font_large
          text_color: 16777215

      - button:
          id: btn_topright_menu_close
          width: 102
          height: 70
          align: top_right
          x: -38            # nudge from right edge
          y: 15             # nudge from top
          bg_color: 0x23282F
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          pad_all: 0
          shadow_color: 0x23282F
          on_click:
            - if:
                condition:
                  switch.is_on: change_homepage 
                then:
                  - lvgl.widget.show: loading_overlay
                  - delay: 20ms
                  - lvgl.page.show: home_page         # old/original homepage
                  - delay: 250ms
                  - lvgl.widget.hide: loading_overlay
                else:
                  - lvgl.widget.show: loading_overlay
                  - delay: 20ms
                  - lvgl.page.show: home_page_2       # new homepage
                  - delay: 250ms
                  - lvgl.widget.hide: loading_overlay
          widgets:
            - image:
                src: img_close_res
                align: center
                bg_opa: 0
                zoom: 0.5

      - obj:
          id: menu_grid
          x: 51
          y: 140
          width: 922
          height: 440
          bg_opa: 0%
          border_width: 0
          scrollable: false
          scrollbar_mode: 'off'
          pad_all: 0
          layout:
            type: flex
            flex_flow: row_wrap
            pad_row: 14
            pad_column: 14
          widgets:
            - button:
                id: go_to_home_button
                width: 298
                height: 115
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 3355443
                on_click:
                  - if:
                      condition:
                        switch.is_on: change_homepage 
                      then:
                        - lvgl.widget.show: loading_overlay
                        - delay: 20ms
                        - lvgl.page.show: home_page         # old/original homepage
                        - delay: 250ms
                        - lvgl.widget.hide: loading_overlay
                      else:
                        - lvgl.widget.show: loading_overlay
                        - delay: 20ms
                        - lvgl.page.show: home_page_2       # new homepage
                        - delay: 250ms
                        - lvgl.widget.hide: loading_overlay
                widgets:
                  - label:
                      text: Home
                      text_color: 16777215
                      text_font: my_font
                      align: center

            - button:
                id: go_to_info_button
                width: 298
                height: 115
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 3355443
                on_click:
                - lvgl.widget.show: loading_overlay
                - delay: 20ms
                - lvgl.page.show: solar_info_page
                - delay: 250ms
                - lvgl.widget.hide: loading_overlay
                widgets:
                  - label:
                      text: Power Flow
                      text_color: 16777215
                      text_font: my_font
                      align: center

            - button:
                id: go_to_solar_button
                width: 298
                height: 115
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 3355443
                on_click:
                - lvgl.widget.show: loading_overlay
                - delay: 20ms
                - lvgl.page.show: solar_page
                - delay: 250ms
                - lvgl.widget.hide: loading_overlay
                widgets:
                  - label:
                      text: Solar
                      text_color: 16777215
                      text_font: my_font
                      align: center

            - button:
                id: go_to_battery_button
                width: 298
                height: 115
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 3355443
                on_click:
                - lvgl.widget.show: loading_overlay
                - delay: 20ms
                - lvgl.page.show: battery_page
                - delay: 250ms
                - lvgl.widget.hide: loading_overlay
                widgets:
                  - label:
                      text: Battery
                      text_color: 16777215
                      text_font: my_font
                      align: center

            - button:
                id: go_to_grid_button
                width: 298
                height: 115
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 3355443
                on_click:
                - lvgl.widget.show: loading_overlay
                - delay: 20ms
                - lvgl.page.show: grid_page
                - delay: 250ms
                - lvgl.widget.hide: loading_overlay
                widgets:
                  - label:
                      text: Grid
                      text_color: 16777215
                      text_font: my_font
                      align: center

            - button:
                id: go_to_graph_button
                width: 298
                height: 115
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 3355443
                on_click:
                - lvgl.widget.show: loading_overlay
                - delay: 20ms
                - lvgl.page.show: graph_page
                - delay: 250ms
                - lvgl.widget.hide: loading_overlay
                widgets:
                  - label:
                      text: Graph
                      text_color: 16777215
                      text_font: my_font
                      align: center

            - button:
                id: go_to_home_usage_button
                width: 298
                height: 115
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 3355443
                on_click:
                - lvgl.widget.show: loading_overlay
                - delay: 20ms
                - lvgl.page.show: home_usage_page
                - delay: 250ms
                - lvgl.widget.hide: loading_overlay
                widgets:
                  - label:
                      text: Home Usage
                      text_color: 16777215
                      text_font: my_font
                      align: center

            - button:
                id: go_to_settings_button
                width: 298
                height: 115
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 3355443
                on_click:
                - lvgl.widget.show: loading_overlay
                - delay: 20ms
                - lvgl.page.show: settings_page
                - delay: 250ms
                - lvgl.widget.hide: loading_overlay
                widgets:
                  - label:
                      text: Settings
                      text_color: 16777215
                      text_font: my_font
                      align: center

            - button:
                id: go_to_new_button
                width: 298
                height: 115
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 3355443
                on_click:
                - lvgl.widget.show: loading_overlay
                - delay: 20ms
                - lvgl.page.show: interval_page
                - delay: 250ms
                - lvgl.widget.hide: loading_overlay
                widgets:
                  - label:
                      text: Interval
                      text_color: 16777215
                      text_font: my_font
                      align: center

  - id: interval_page
    bg_color: 0x141B21
    on_load:
      then:
        - lambda: |-
            // Enter interval mode, but wait on this page for a short countdown
            id(interval_mode_active) = true;
            id(interval_running) = false;
            id(interval_prelude_remaining) = 10;

            int mask = id(interval_pages_mask) & 0xFF;
            if (mask == 0) {
              // default to Home if nothing selected
              mask = 1;
              id(interval_pages_mask) = mask;
            }

            // pick first enabled bit as the first target
            for (int b = 0; b < 8; b++) {
              if (mask & (1 << b)) {
                id(interval_current_bit) = b;
                id(interval_target_bit)  = b;
                break;
              }
            }

        - lvgl.label.update:
            id: interval_prelude_lbl
            text: !lambda |-
                return str_sprintf("Starting in: %ds", id(interval_prelude_remaining));
        - lvgl.label.update:
            id: interval_every_lbl
            text: !lambda |-
                return str_sprintf("Then every %ds", id(interval_seconds));

    widgets:
      - label:
          x: 51
          y: 20
          text: Interval
          text_font: my_font_large
          text_color: 16777215
      - button:
          id: btn_interval_close
          width: 102
          height: 70
          align: top_right
          x: -38            # nudge from right edge
          y: 15             # nudge from top
          bg_color: 0x23282F
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          pad_all: 0
          shadow_color: 0x23282F
          on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: menu_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay   
          widgets:
            - image:
                src: img_menu_res
                align: center
                bg_opa: 0
                zoom: 0.5                              
      - label:
          id: interval_prelude_lbl
          x: 51
          y: 90
          text: "Starting in: 3s"
          text_font: my_font
          text_color: 0xFFFFFF

      - label:
          id: interval_every_lbl
          x: 51
          y: 135
          text: "Then every 10s"
          text_font: my_font_small
          text_color: 0x9E9E9E

      - label:
          x: 51
          y: 165
          text: Tap Start to begin now, or wait.
          text_font: my_font_small
          text_color: 0x9E9E9E

      - button:
          id: btn_interval_start_now
          x: 51
          y: 220
          width: 300
          height: 90
          radius: 15
          bg_color: 0x2E7D32
          border_width: 0
          on_click:
            - lambda: |-
                id(interval_prelude_remaining) = 0;
          widgets:
            - label:
                text: Start
                text_font: my_font
                text_color: 0xFFFFFF
                align: center

      - button:
          id: btn_interval_settings
          x: 51
          y: 330
          width: 300
          height: 90
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 0x333333
          on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: interval_settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                text: Settings
                text_font: my_font
                text_color: 0xFFFFFF
                align: center

      - button:
          id: btn_interval_stop
          x: 51
          y: 440
          width: 300
          height: 90
          radius: 15
          bg_color: 0xB71C1C
          border_width: 0
          on_click:
            - lambda: |-
                id(interval_mode_active) = false;
                id(interval_running) = false;
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: menu_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                text: Stop
                text_font: my_font
                text_color: 0xFFFFFF
                align: center


  - id: interval_settings_page
    bg_color: 0x141B21
    on_load:
      then:
        - script.execute: interval_refresh_settings_ui

    widgets:
      - label:
          x: 51
          y: 20
          text: Interval settings
          text_font: my_font_large
          text_color: 0xFFFFFF

      - button:
          id: btn_interval_settings_close
          width: 102
          height: 70
          align: top_right
          x: -38            # nudge from right edge
          y: 15             # nudge from top
          bg_color: 0x23282F
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          pad_all: 0
          shadow_color: 0x23282F
          on_click:
          - lvgl.widget.show: loading_overlay
          - delay: 20ms
          - lvgl.page.show: settings_page
          - delay: 250ms
          - lvgl.widget.hide: loading_overlay   
          widgets:
            - image:
                src: img_close_res
                align: center
                bg_opa: 0
                zoom: 0.5                              

      # Seconds per page
      - label:
          x: 51
          y: 100
          text: Seconds per page
          text_font: my_font_small
          text_color: 0x9E9E9E

      - label:
          id: lbl_interval_seconds
          x: 51
          y: 130
          text: "10"
          text_font: my_font_large
          text_color: 0xFFFFFF

      - button:
          id: btn_interval_seconds_minus
          x: 170
          y: 135
          width: 70
          height: 60
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 0x333333
          on_click:
            - lambda: |-
                int v = id(interval_seconds) - 1;
                if (v < 2) v = 2;
                id(interval_seconds) = v;
            - script.execute: interval_refresh_settings_ui
          widgets:
            - label:
                text: "-"
                text_font: my_font_large
                text_color: 0xFFFFFF
                align: center

      - button:
          id: btn_interval_seconds_plus
          x: 250
          y: 135
          width: 70
          height: 60
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 0x333333
          on_click:
            - lambda: |-
                int v = id(interval_seconds) + 1;
                if (v > 300) v = 300;
                id(interval_seconds) = v;
            - script.execute: interval_refresh_settings_ui
          widgets:
            - label:
                text: "+"
                text_font: my_font_large
                text_color: 0xFFFFFF
                align: center

      - label:
          x: 51
          y: 205
          text: Pages to rotate (tap to toggle)
          text_font: my_font_small
          text_color: 0x9E9E9E

      # 3x3 grid of page toggles (8 pages + All/None)
      - obj:
          id: interval_pages_grid
          x: 51
          y: 235
          width: 922
          height: 330
          scrollable: false
          bg_opa: 0%
          border_width: 0
          layout:
            type: flex
            flex_flow: row_wrap
            pad_row: 14
            pad_column: 14
          pad_all: 0
          widgets:
            - button:
                id: btn_int_home
                width: 298
                height: 95
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(interval_pages_mask) ^= (1 << 0);
                  - script.execute: interval_refresh_settings_ui
                widgets:
                  - label:
                      text: Alt Home
                      x: 16
                      y: 30
                      text_font: my_font
                      text_color: 0xFFFFFF

            - button:
                id: btn_int_home2
                width: 298
                height: 95
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(interval_pages_mask) ^= (1 << 1);
                  - script.execute: interval_refresh_settings_ui
                widgets:
                  - label:
                      text: Home
                      x: 16
                      y: 30
                      text_font: my_font
                      text_color: 0xFFFFFF

            - button:
                id: btn_int_solar
                width: 298
                height: 95
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(interval_pages_mask) ^= (1 << 2);
                  - script.execute: interval_refresh_settings_ui
                widgets:
                  - label:
                      text: Solar
                      x: 16
                      y: 30
                      text_font: my_font
                      text_color: 0xFFFFFF

            - button:
                id: btn_int_info
                width: 298
                height: 95
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(interval_pages_mask) ^= (1 << 3);
                      
                  - script.execute: interval_refresh_settings_ui
                widgets:
                  - label:
                      text: Power Flow
                      x: 16
                      y: 30
                      text_font: my_font
                      text_color: 0xFFFFFF

            - button:
                id: btn_int_battery
                width: 298
                height: 95
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(interval_pages_mask) ^= (1 << 4);
                  - script.execute: interval_refresh_settings_ui
                widgets:
                  - label:
                      text: Battery
                      x: 16
                      y: 30
                      text_font: my_font
                      text_color: 0xFFFFFF

            - button:
                id: btn_int_grid
                width: 298
                height: 95
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(interval_pages_mask) ^= (1 << 5);
                  - script.execute: interval_refresh_settings_ui
                widgets:
                  - label:
                      text: Grid
                      x: 16
                      y: 30
                      text_font: my_font
                      text_color: 0xFFFFFF

            - button:
                id: btn_int_graph
                width: 298
                height: 95
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(interval_pages_mask) ^= (1 << 6);
                  - script.execute: interval_refresh_settings_ui
                widgets:
                  - label:
                      text: Graphs
                      x: 16
                      y: 30
                      text_font: my_font
                      text_color: 0xFFFFFF

            - button:
                id: btn_int_usage
                width: 298
                height: 95
                radius: 15
                bg_color: 0x1C2229
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(interval_pages_mask) ^= (1 << 7);
                  - script.execute: interval_refresh_settings_ui
                widgets:
                  - label:
                      text: Home Usage
                      x: 16
                      y: 30
                      text_font: my_font
                      text_color: 0xFFFFFF

            - button:
                id: btn_int_allnone
                width: 298
                height: 95
                radius: 15
                bg_color: 0x2E7D32
                border_width: 0
                on_click:
                  - lambda: |-
                      // Toggle all pages on/off
                      int mask = id(interval_pages_mask) & 0xFF;
                      if (mask == 0xFF) {
                        id(interval_pages_mask) = 1;  // default back to Home only
                      } else {
                        id(interval_pages_mask) = 0xFF;
                      }
                  - script.execute: interval_refresh_settings_ui
                widgets:
                  - label:
                      id: lbl_int_allnone
                      text: All
                      align: center
                      text_font: my_font
                      text_color: 0xFFFFFF
  - id: settings_page
    bg_color: 0x141B21
    widgets:
    - label:
        x: 51
        y: 20
        text: Settings
        text_font: my_font_large
        text_color: 16777215
    - button:
        id: btn_topright_settings
        width: 102
        height: 70
        align: top_right
        x: -38            # nudge from right edge
        y: 15             # nudge from top
        bg_color: 0x23282F
        bg_opa: 0
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        shadow_color: 0x23282F
        on_click:
        - lvgl.widget.show: loading_overlay
        - delay: 20ms
        - lvgl.page.show: menu_page
        - delay: 250ms
        - lvgl.widget.hide: loading_overlay
        widgets:
          - image:
              src: img_menu_res
              align: center
              bg_opa: 0
              zoom: 0.5  
    - button:
        id: btn_settings_scroll_up
        x: 20
        y: 160
        width: 55
        height: 110
        radius: 14
        bg_color: 0x1C2229
        border_width: 1
        border_color: 0x2A323A
        on_click:
          - lambda: |-
              // Scroll up by one "step"
              lv_obj_scroll_by(id(settings_scroll), 0, 170, LV_ANIM_OFF);
        widgets:
          - label:
              align: center
              text: "\U000F0143"
              text_font: mdi_60
              text_color: 0xFFFFFF

    - button:
        id: btn_settings_scroll_down
        x: 20
        y: 405
        width: 55
        height: 110
        radius: 14
        bg_color: 0x1C2229
        border_width: 1
        border_color: 0x2A323A
        on_click:
          - lambda: |-
              // Scroll down by one "step"
              lv_obj_scroll_by(id(settings_scroll), 0, -170, LV_ANIM_OFF);
        widgets:
          - label:
              align: center
              text: "\U000F0140"
              text_font: mdi_60
              text_color: 0xFFFFFF
    - obj:
        id: settings_scroll
        x: 90
        y: 100
        width: 883
        height: 475
        bg_opa: 0%
        border_width: 0
        scrollable: true
        scrollbar_mode: 'off'
        pad_all: 0
        layout:
          type: flex
          flex_flow: column
          pad_row: 12
        widgets:
        - button:
            id: card_setting_display
            width: 883
            height: 100
            radius: 15
            bg_color: 0x1C2229
            border_width: 1
            border_color: 3355443
            scrollable: false
            scrollbar_mode: 'off'
            on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: display_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
            widgets:
            - label:
                x: 20
                y: 18
                text: Display
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Backlight & auto sleep options
                text_font: my_font_small
                text_color: 10395294
        - button:
            id: card_setting_usage
            width: 883
            height: 100
            radius: 15
            bg_color: 0x1C2229
            border_width: 1
            border_color: 3355443
            scrollable: false
            scrollbar_mode: 'off'
            on_click:
              - lvgl.widget.show: loading_overlay
              - delay: 20ms
              - lvgl.page.show: usage_device_select_page
              - delay: 250ms
              - lvgl.widget.hide: loading_overlay
            widgets:
              - label:
                  x: 20
                  y: 18
                  text: Home Usage
                  text_font: my_font
                  text_color: 16777215
              - label:
                  x: 20
                  y: 55
                  text: Device names & more
                  text_font: my_font_small
                  text_color: 10395294
        - button:
            id: card_setting_interval
            width: 883
            height: 100
            radius: 15
            bg_color: 0x1C2229
            border_width: 1
            border_color: 3355443
            scrollable: false
            scrollbar_mode: 'off'
            on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: interval_settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
            widgets:
            - label:
                x: 20
                y: 18
                text: Interval
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Auto-rotate between pages
                text_font: my_font_small
                text_color: 10395294

        - button:
            id: card_setting_suggestions
            width: 883
            height: 100
            radius: 15
            bg_color: 0x1C2229
            border_width: 1
            border_color: 3355443
            scrollable: false
            scrollbar_mode: 'off'
            on_click:
            - switch.toggle: suggestion_toggle
            widgets:
            - label:
                x: 20
                y: 18
                text: Tips / Suggestions
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Enable the suggestion box on the flow screen
                text_font: my_font_small
                text_color: 10395294
            - obj:
                id: pill_suggestions
                width: 141
                height: 45
                radius: 22
                bg_color: 4342338
                align: RIGHT_MID
                x: -15
                pad_all: 0
                scrollable: false
                scrollbar_mode: 'off'
                widgets:
                - label:
                    id: lbl_suggestions_state
                    text: --
                    text_font: my_font_small
                    text_color: 16777215
                    align: CENTER
                    width: 141
                    text_align: CENTER
                    x: 0
                    y: 0
        - button:
            id: card_setting_graphvals
            width: 883
            height: 100
            radius: 15
            bg_color: 0x1C2229
            border_width: 1
            border_color: 3355443
            scrollable: false
            scrollbar_mode: 'off'
            on_click:
            - switch.toggle: graph_values_toggle
            widgets:
            - label:
                x: 20
                y: 18
                text: Graph Values
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Show value labels on the Graph page
                text_font: my_font_small
                text_color: 10395294
            - obj:
                id: pill_graphvals
                width: 141
                height: 45
                radius: 22
                bg_color: 4342338
                align: right_mid
                x: -15
                pad_all: 0
                scrollable: false
                scrollbar_mode: 'off'
                widgets:
                - label:
                    id: lbl_graph_values_state
                    text: --
                    text_font: my_font_small
                    text_color: 16777215
                    align: center
                    width: 141
                    text_align: center
                    x: 0
                    y: 0
        - button:
            id: card_setting_dailytotals
            width: 883
            height: 100
            radius: 15
            bg_color: 0x1C2229
            border_width: 1
            border_color: 3355443
            scrollable: false
            scrollbar_mode: 'off'
            on_click:
            - switch.toggle: show_totals_toggle
            widgets:
            - label:
                x: 20
                y: 18
                text: Daily Totals
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Show PV / Home / Grid / Battery totals on flow screen
                text_font: my_font_small
                text_color: 10395294
            - obj:
                id: pill_daily_totals
                width: 141
                height: 45
                radius: 22
                bg_color: 4342338
                align: RIGHT_MID
                x: -15
                pad_all: 0
                scrollable: false
                scrollbar_mode: 'off'
                widgets:
                - label:
                    id: lbl_daily_totals_state
                    text: --
                    text_font: my_font_small
                    text_color: 16777215
                    align: CENTER
                    width: 141
                    text_align: CENTER
                    x: 0
                    y: 0
        - button:
            id: card_setting_wifi
            width: 883
            height: 100
            radius: 15
            bg_color: 0x1C2229
            border_width: 1
            border_color: 3355443
            scrollable: false
            scrollbar_mode: 'off'
            on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: wifi_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
            widgets:
            - label:
                x: 20
                y: 18
                text: Wi-Fi
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: View connection, SSID, IP & signal
                text_font: my_font_small
                text_color: 10395294
            - obj:
                width: 141
                height: 45
                radius: 22
                bg_color: 3046706
                align: right_mid
                x: -15
                pad_all: 0
                scrollable: false
                scrollbar_mode: 'off'
                widgets:
                - label:
                    text: Open
                    text_font: my_font_small
                    text_color: 16777215
                    align: center
                    width: 141
                    text_align: center
                    x: 0
                    y: 0

        - button:
            id: card_setting_reboot_reconnect
            width: 883
            height: 100
            radius: 15
            bg_color: 0x1C2229
            border_width: 1
            border_color: 3355443
            scrollable: false
            scrollbar_mode: 'off'
            on_click:
              - lvgl.widget.show: loading_overlay
              - delay: 20ms
              - button.press: restart_device
            widgets:
              - label:
                  x: 20
                  y: 18
                  text: Reboot / Reconnect
                  text_font: my_font
                  text_color: 16777215
              - label:
                  x: 20
                  y: 55
                  text: Restart the device (reconnects after boot)
                  text_font: my_font_small
                  text_color: 10395294
              - obj:
                  width: 141
                  height: 45
                  radius: 22
                  bg_color: 3046706
                  align: right_mid
                  x: -15
                  pad_all: 0
                  scrollable: false
                  scrollbar_mode: 'off'
                  widgets:
                    - label:
                        text: Reboot
                        text_font: my_font_small
                        text_color: 16777215
                        align: center
                        width: 141
                        text_align: center
                        x: 0
                        y: 0
        - button:
            id: card_setting_backup_sim
            width: 883
            height: 100
            radius: 15
            bg_color: 0x1C2229
            border_width: 1
            border_color: 3355443
            scrollable: false
            scrollbar_mode: 'off'
            on_click:
            - switch.toggle: simulate_backup_switch
            widgets:
            - label:
                x: 20
                y: 18
                text: Simulate Backup Mode
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Force OFF-GRID alert to test flashing banner
                text_font: my_font_small
                text_color: 10395294
            - obj:
                id: pill_backup_sim
                width: 141
                height: 45
                radius: 22
                bg_color: 4342338
                align: right_mid
                x: -15
                pad_all: 0
                scrollable: false
                scrollbar_mode: 'off'
                widgets:
                - label:
                    id: lbl_backup_sim_state
                    text: --
                    text_font: my_font_small
                    text_color: 16777215
                    align: center
                    width: 141
                    text_align: center
                    x: 0
                    y: 0
        - button:
            id: card_setting_homepage_toggle
            width: 883
            height: 100
            radius: 15
            bg_color: 0x1C2229
            border_width: 1
            border_color: 3355443
            scrollable: false
            scrollbar_mode: 'off'
            on_click:
            - switch.toggle: change_homepage
            widgets:
            - label:
                x: 20
                y: 18
                text: Original Homepage
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Change Back to the Old Basic Homepage
                text_font: my_font_small
                text_color: 10395294
            - obj:
                id: pill_homepage_select
                width: 141
                height: 45
                radius: 22
                bg_color: 4342338
                align: right_mid
                x: -15
                pad_all: 0
                scrollable: false
                scrollbar_mode: 'off'
                widgets:
                - label:
                    id: lbl_homepage_select_state
                    text: --
                    text_font: my_font_small
                    text_color: 16777215
                    align: center
                    width: 141
                    text_align: center
                    x: 0
                    y: 0

  - id: usage_device_select_page
    bg_color: 0x141B21
    on_load:
      then:
        # Update device buttons with current names
        - lvgl.label.update:
            id: lbl_usage_sel_dev1
            text: !lambda "return id(hu_dev1_name_str).c_str();"
        - lvgl.label.update:
            id: lbl_usage_sel_dev2
            text: !lambda "return id(hu_dev2_name_str).c_str();"
        - lvgl.label.update:
            id: lbl_usage_sel_dev3
            text: !lambda "return id(hu_dev3_name_str).c_str();"
        - lvgl.label.update:
            id: lbl_usage_sel_dev4
            text: !lambda "return id(hu_dev4_name_str).c_str();"
        - lvgl.label.update:
            id: lbl_usage_sel_dev5
            text: !lambda "return id(hu_dev5_name_str).c_str();"
        - lvgl.label.update:
            id: lbl_usage_sel_sp1
            text: !lambda "return id(hu_sp1_name_str).c_str();"
        - lvgl.label.update:
            id: lbl_usage_sel_sp2
            text: !lambda "return id(hu_sp2_name_str).c_str();"
    widgets:
      # Title
      - label:
          x: 51
          y: 20
          text: Home Usage Devices
          text_font: my_font_large
          text_color: 0xFFFFFF 
          
      # Subpanel 1
      - obj:
          x: 80
          y: 95
          width: 420
          height: 70
          radius: 12
          bg_color: 0x1C2229
          border_width: 1
          border_color: 0x333333
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lambda: |-
                id(hu_current_subpanel) = 1;
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: subpanel_settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                id: lbl_usage_sel_sp1
                x: 20
                y: 0
                text: "Subpanel 1"
                text_font: my_font
                text_color: 0xFFFFFF

      # Subpanel 2
      - obj:
          x: 524
          y: 95
          width: 420
          height: 70
          radius: 15
          bg_color: 0x1C2229
          border_width: 0
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lambda: |-
                id(hu_current_subpanel) = 2;
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: subpanel_settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                id: lbl_usage_sel_sp2
                x: 20
                y: 0
                text: "Subpanel 2"
                text_font: my_font
                text_color: 0xFFFFFF



      # Back to Settings
      - button:
          id: btn_usage_sel_back
          width: 70
          height: 70
          align: top_right
          x: -38
          y: 15
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          pad_all: 0
          on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - image:
                src: img_close_res
                align: center
                bg_opa: 0
                zoom: 0.5

      # Device 1
      - obj:
          x: 80
          y: 180
          width: 864
          height: 70
          radius: 15
          bg_color: 0x1C2229
          border_width: 0
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lambda: |-
                id(hu_current_device) = 1;
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: usage_settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                id: lbl_usage_sel_dev1
                x: 20
                y: 0
                text: "Device 1"
                text_font: my_font
                text_color: 0xFFFFFF

      # Device 2
      - obj:
          x: 80
          y: 265
          width: 864
          height: 70
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 0x333333
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lambda: |-
                id(hu_current_device) = 2;
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: usage_settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                id: lbl_usage_sel_dev2
                x: 20
                y: 0
                text: "Device 2"
                text_font: my_font
                text_color: 0xFFFFFF

      # Device 3
      - obj:
          x: 80
          y: 350
          width: 864
          height: 70
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 0x333333
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lambda: |-
                id(hu_current_device) = 3;
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: usage_settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                id: lbl_usage_sel_dev3
                x: 20
                y: 0
                text: "Device 3"
                text_font: my_font
                text_color: 0xFFFFFF

      # Device 4
      - obj:
          x: 80
          y: 435
          width: 864
          height: 70
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 0x333333
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lambda: |-
                id(hu_current_device) = 4;
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: usage_settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                id: lbl_usage_sel_dev4
                x: 20
                y: 0
                text: "Device 4"
                text_font: my_font
                text_color: 0xFFFFFF

      # Device 5
      - obj:
          x: 80
          y: 520
          width: 864
          height: 70
          radius: 15
          bg_color: 0x1C2229
          border_width: 0
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lambda: |-
                id(hu_current_device) = 5;
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: usage_settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                id: lbl_usage_sel_dev5
                x: 20
                y: 0
                text: "Device 5"
                text_font: my_font
                text_color: 0xFFFFFF

  - id: usage_settings_page
    bg_color: 0x141B21
    on_load:
      then:
        # Fill title and name for current device when page is opened
        - lvgl.label.update:
            id: lbl_usage_dev_title
            text: !lambda |-
                int dev = id(hu_current_device);
                if (dev < 1 || dev > 5) dev = 1;
                return str_sprintf("Device %d", dev);
        - lvgl.textarea.update:
            id: ta_hu_dev_name
            text: !lambda |-
                int dev = id(hu_current_device);
                if (dev == 1) return id(hu_dev1_name_str).c_str();
                if (dev == 2) return id(hu_dev2_name_str).c_str();
                if (dev == 3) return id(hu_dev3_name_str).c_str();
                if (dev == 4) return id(hu_dev4_name_str).c_str();
                if (dev == 5) return id(hu_dev5_name_str).c_str();
                return id(hu_dev1_name_str).c_str();
        - lambda: |-
            int dev = id(hu_current_device);
            int idx = 0;
            if (dev == 1) idx = id(hu_dev1_icon_idx);
            else if (dev == 2) idx = id(hu_dev2_icon_idx);
            else if (dev == 3) idx = id(hu_dev3_icon_idx);
            else if (dev == 4) idx = id(hu_dev4_icon_idx);
            else if (dev == 5) idx = id(hu_dev5_icon_idx);
            id(hu_edit_icon_idx) = idx;
        - lvgl.widget.hide: btn_usage_kb_done
        - script.execute: hu_refresh_icon_picker
    widgets:
      # Title
      - label:
          id: lbl_usage_dev_title
          x: 51
          y: 20
          text: Device 1
          text_font: my_font_large
          text_color: 0xFFFFFF

      # Close/back button (top-right)
      - button:
          id: btn_usage_close
          width: 70
          height: 70
          align: top_right
          x: -38
          y: 15
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          pad_all: 0
          on_click:
            - lvgl.widget.hide: kb_usage
            - lvgl.widget.hide: btn_usage_kb_done
            - lvgl.page.show: usage_device_select_page
            - lvgl.widget.hide: btn_usage_kb_done
            - lvgl.page.show: usage_device_select_page
          widgets:
            - image:
                src: img_close_res
                align: center
                bg_opa: 0
                zoom: 0.5
      - obj:
          id: btn_usage_kb_done
          x: 20
          y: -230
          width: 100
          height: 40
          align: bottom_left
          bg_color: 0x333333
          radius: 10
          pad_all: 8
          on_click:
            - lvgl.widget.hide: kb_usage
            - lvgl.widget.hide: btn_usage_kb_done
          widgets:
            - label:
                id: lbl_usage_kb_done
                text: "Done"
                align: center
                text_color: 0xFFFFFF
                long_mode: dot
          hidden: true
      # Name field
      - label:
          x: 80
          y: 120
          text: "Name:"
          text_font: my_font_small
          text_color: 0x9E9E9E

      - textarea:
          id: ta_hu_dev_name
          x: 200
          y: 115
          width: 760
          height: 40
          text: ""
          text_font: my_font
          text_color: 0x000000
          max_length: 20
          one_line: true
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lvgl.keyboard.update:
                id: kb_usage
                textarea: ta_hu_dev_name
            - lvgl.widget.show: kb_usage
            - lvgl.widget.show: btn_usage_kb_done

      # Icon selection
      - label:
          x: 80
          y: 175
          text: "Icon:"
          text_font: my_font_small
          text_color: 0x9E9E9E

      - obj:
          id: hu_icon_grid
          x: 200
          y: 205
          width: 760
          height: 250
          bg_opa: 0%
          border_width: 0
          pad_all: 0
          layout:
            type: flex
            flex_flow: ROW_WRAP
            flex_align_main: START
            flex_align_cross: START
            flex_align_track: START
          widgets:
            - button:
                id: btn_hu_icon_0
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(hu_edit_icon_idx) = 0;
                  - script.execute: hu_refresh_icon_picker
                widgets:
                  - image:
                      src: hu_icon_homecog
                      align: center
                  - label:
                      id: chk_hu_icon_0
                      text: " "
                      hidden: true
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      align: top_right
                      x: -8
                      y: 6

            - button:
                id: btn_hu_icon_1
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(hu_edit_icon_idx) = 1;
                  - script.execute: hu_refresh_icon_picker
                widgets:
                  - image:
                      src: hu_icon_towel
                      align: center
                  - label:
                      id: chk_hu_icon_1
                      text: " "
                      hidden: true
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      align: top_right
                      x: -8
                      y: 6

            - button:
                id: btn_hu_icon_2
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(hu_edit_icon_idx) = 2;
                  - script.execute: hu_refresh_icon_picker
                widgets:
                  - image:
                      src: hu_icon_dehumidifier
                      align: center
                  - label:
                      id: chk_hu_icon_2
                      text: " "
                      hidden: true
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      align: top_right
                      x: -8
                      y: 6

            - button:
                id: btn_hu_icon_3
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(hu_edit_icon_idx) = 3;
                  - script.execute: hu_refresh_icon_picker
                widgets:
                  - image:
                      src: hu_icon_heater
                      align: center
                  - label:
                      id: chk_hu_icon_3
                      text: " "
                      hidden: true
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      align: top_right
                      x: -8
                      y: 6

            - button:
                id: btn_hu_icon_4
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(hu_edit_icon_idx) = 4;
                  - script.execute: hu_refresh_icon_picker
                widgets:
                  - image:
                      src: hu_icon_heating
                      align: center
                  - label:
                      id: chk_hu_icon_4
                      text: " "
                      hidden: true
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      align: top_right
                      x: -8
                      y: 6

            - button:
                id: btn_hu_icon_5
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(hu_edit_icon_idx) = 5;
                  - script.execute: hu_refresh_icon_picker
                widgets:
                  - image:
                      src: hu_icon_office
                      align: center
                  - label:
                      id: chk_hu_icon_5
                      text: " "
                      hidden: true
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      align: top_right
                      x: -8
                      y: 6

            - button:
                id: btn_hu_icon_6
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(hu_edit_icon_idx) = 6;
                  - script.execute: hu_refresh_icon_picker
                widgets:
                  - image:
                      src: hu_icon_pcdesk
                      align: center
                  - label:
                      id: chk_hu_icon_6
                      text: " "
                      hidden: true
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      align: top_right
                      x: -8
                      y: 6

            - button:
                id: btn_hu_icon_7
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(hu_edit_icon_idx) = 7;
                  - script.execute: hu_refresh_icon_picker
                widgets:
                  - image:
                      src: hu_icon_sauna
                      align: center
                  - label:
                      id: chk_hu_icon_7
                      text: " "
                      hidden: true
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      align: top_right
                      x: -8
                      y: 6

            - button:
                id: btn_hu_icon_8
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(hu_edit_icon_idx) = 8;
                  - script.execute: hu_refresh_icon_picker
                widgets:
                  - image:
                      src: hu_icon_sofa
                      align: center
                  - label:
                      id: chk_hu_icon_8
                      text: " "
                      hidden: true
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      align: top_right
                      x: -8
                      y: 6

            - button:
                id: btn_hu_icon_9
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                border_width: 1
                border_color: 0x333333
                on_click:
                  - lambda: |-
                      id(hu_edit_icon_idx) = 9;
                  - script.execute: hu_refresh_icon_picker
                widgets:
                  - image:
                      src: hu_icon_spa
                      align: center
                  - label:
                      id: chk_hu_icon_9
                      text: " "
                      hidden: true
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      align: top_right
                      x: -8
                      y: 6

      # Help / explanation page
      - button:
          id: btn_hu_help
          x: 200
          y: 465
          width: 160
          height: 40
          radius: 15
          bg_color: 0x23282F
          border_width: 0
          on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: usage_help_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                text: "Help"
                text_font: my_font_small
                text_color: 0xFFFFFF
                align: center

      # Save button
      - button:
          id: btn_hu_save
          x: 720
          y: 520
          width: 200
          height: 60
          radius: 15
          bg_color: 0x2E7D32
          border_width: 0
          on_click:
            - lambda: |-
                int dev = id(hu_current_device);
                std::string new_name = std::string(lv_textarea_get_text(id(ta_hu_dev_name)));
                if (dev == 1) id(hu_dev1_name_str) = new_name;
                else if (dev == 2) id(hu_dev2_name_str) = new_name;
                else if (dev == 3) id(hu_dev3_name_str) = new_name;
                else if (dev == 4) id(hu_dev4_name_str) = new_name;
                else if (dev == 5) id(hu_dev5_name_str) = new_name;
                int icon_idx = id(hu_edit_icon_idx);
                if (dev == 1) id(hu_dev1_icon_idx) = icon_idx;
                else if (dev == 2) id(hu_dev2_icon_idx) = icon_idx;
                else if (dev == 3) id(hu_dev3_icon_idx) = icon_idx;
                else if (dev == 4) id(hu_dev4_icon_idx) = icon_idx;
                else if (dev == 5) id(hu_dev5_icon_idx) = icon_idx;
            - lvgl.widget.hide: kb_usage
            - lvgl.widget.hide: btn_usage_kb_done
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: usage_device_select_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                text: "SAVE"
                text_font: my_font_small
                text_color: 0xFFFFFF
                align: center

      # Shared usage keyboard (floats over this page)
      - keyboard:
          id: kb_usage
          width: 1024
          height: 220
          align: bottom_mid
          y: 0
          mode: TEXT_LOWER
          floating: true
          bg_color: 0x1C2229
          border_width: 0
          outline_width: 0
          shadow_width: 0
          hidden: true
  - id: subpanel_settings_page
    bg_color: 0x141B21
    on_load:
      then:
        - lambda: |-
            const int sp = id(hu_current_subpanel);
            // Title
            if (id(lbl_sp_settings_title) != nullptr) {
              lv_label_set_text(id(lbl_sp_settings_title), sp == 1 ? "Subpanel 1 Settings" : "Subpanel 2 Settings");
            }
            // Load current subpanel settings into editor controls
            if (sp == 1) {
              id(hu_sp_edit_icon_idx) = id(hu_sp1_icon_idx);
              if (id(ta_hu_sp_name) != nullptr) lv_textarea_set_text(id(ta_hu_sp_name), id(hu_sp1_name_str).c_str());
            } else {
              id(hu_sp_edit_icon_idx) = id(hu_sp2_icon_idx);
              if (id(ta_hu_sp_name) != nullptr) lv_textarea_set_text(id(ta_hu_sp_name), id(hu_sp2_name_str).c_str());
            }
        - script.execute: hu_refresh_sp_icon_picker
        - script.execute: hu_refresh_sp_device_picker
    widgets:
      # Title
      - label:
          id: lbl_sp_settings_title
          x: 40
          y: 20
          text: "Subpanel Settings"
          text_font: my_font_large
          text_color: 0xFFFFFF

      # Back
      - button:
          id: btn_sp_settings_back
          width: 70
          height: 70
          align: top_right
          x: -38
          y: 15
          bg_opa: 0
          border_width: 0
          outline_width: 0
          on_click:
            - lvgl.widget.hide: kb_sp_usage
            - lvgl.widget.hide: btn_sp_kb_done
            - lvgl.page.show: usage_device_select_page
          widgets:
            - image:
                src: img_close_res
                align: center
                bg_opa: 0
                zoom: 0.5

      # Name
      - label:
          x: 40
          y: 85
          text: "Name:"
          text_font: my_font_small
          text_color: 0x9AA4AE

      - textarea:
          id: ta_hu_sp_name
          x: 40
          y: 115
          width: 700
          height: 44
          text: ""
          text_font: my_font
          text_color: 0x000000
          max_length: 20
          one_line: true
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lvgl.keyboard.update:
                id: kb_sp_usage
                textarea: ta_hu_sp_name
            - lvgl.widget.show: kb_sp_usage
            - lvgl.widget.show: btn_sp_kb_done

      # Save
      - button:
          id: btn_sp_settings_save
          x: 780
          y: 110
          width: 200
          height: 50
          radius: 14
          bg_color: 0x1C2229
          border_width: 0
          on_click:
            - lambda: |-
                const int sp = id(hu_current_subpanel);
                const char* nm = (id(ta_hu_sp_name) != nullptr) ? lv_textarea_get_text(id(ta_hu_sp_name)) : "";
                if (sp == 1) {
                  id(hu_sp1_name_str) = std::string(nm);
                  id(hu_sp1_icon_idx) = id(hu_sp_edit_icon_idx);
                  id(hu_sp1_enabled) = true;
                } else {
                  id(hu_sp2_name_str) = std::string(nm);
                  id(hu_sp2_icon_idx) = id(hu_sp_edit_icon_idx);
                  id(hu_sp2_enabled) = true;
                }
            - lvgl.widget.hide: kb_sp_usage
            - lvgl.widget.hide: btn_sp_kb_done
            - lvgl.page.show: usage_device_select_page
          widgets:
            - label:
                align: center
                text: "Save"
                text_font: my_font
                text_color: 0xFFFFFF

      # Icon selection
      - label:
          x: 40
          y: 175
          text: "Icon:"
          text_font: my_font_small
          text_color: 0x9AA4AE

      - obj:
          x: 40
          y: 205
          width: 944
          height: 220
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          scrollable: false
          scrollbar_mode: 'off'
          layout:
            type: flex
            flex_flow: ROW_WRAP
            pad_row: 12
            pad_column: 12
            flex_align_main: START
            flex_align_cross: START
            flex_align_track: START
          widgets:
            - button:
                id: btn_sp_icon_0
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      id(hu_sp_edit_icon_idx) = 0;
                  - script.execute: hu_refresh_sp_icon_picker
                widgets:
                  - image:
                      src: hu_icon_homecog
                      align: center
                  - label:
                      id: chk_sp_icon_0
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_icon_1
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      id(hu_sp_edit_icon_idx) = 1;
                  - script.execute: hu_refresh_sp_icon_picker
                widgets:
                  - image:
                      src: hu_icon_towel
                      align: center
                  - label:
                      id: chk_sp_icon_1
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_icon_2
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      id(hu_sp_edit_icon_idx) = 2;
                  - script.execute: hu_refresh_sp_icon_picker
                widgets:
                  - image:
                      src: hu_icon_dehumidifier
                      align: center
                  - label:
                      id: chk_sp_icon_2
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_icon_3
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      id(hu_sp_edit_icon_idx) = 3;
                  - script.execute: hu_refresh_sp_icon_picker
                widgets:
                  - image:
                      src: hu_icon_heater
                      align: center
                  - label:
                      id: chk_sp_icon_3
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_icon_4
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      id(hu_sp_edit_icon_idx) = 4;
                  - script.execute: hu_refresh_sp_icon_picker
                widgets:
                  - image:
                      src: hu_icon_heating
                      align: center
                  - label:
                      id: chk_sp_icon_4
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_icon_5
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      id(hu_sp_edit_icon_idx) = 5;
                  - script.execute: hu_refresh_sp_icon_picker
                widgets:
                  - image:
                      src: hu_icon_office
                      align: center
                  - label:
                      id: chk_sp_icon_5
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_icon_6
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      id(hu_sp_edit_icon_idx) = 6;
                  - script.execute: hu_refresh_sp_icon_picker
                widgets:
                  - image:
                      src: hu_icon_pcdesk
                      align: center
                  - label:
                      id: chk_sp_icon_6
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_icon_7
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      id(hu_sp_edit_icon_idx) = 7;
                  - script.execute: hu_refresh_sp_icon_picker
                widgets:
                  - image:
                      src: hu_icon_sauna
                      align: center
                  - label:
                      id: chk_sp_icon_7
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_icon_8
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      id(hu_sp_edit_icon_idx) = 8;
                  - script.execute: hu_refresh_sp_icon_picker
                widgets:
                  - image:
                      src: hu_icon_sofa
                      align: center
                  - label:
                      id: chk_sp_icon_8
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_icon_9
                width: 90
                height: 90
                radius: 18
                bg_color: 0x23282F
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      id(hu_sp_edit_icon_idx) = 9;
                  - script.execute: hu_refresh_sp_icon_picker
                widgets:
                  - image:
                      src: hu_icon_spa
                      align: center
                  - label:
                      id: chk_sp_icon_9
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true

      # Devices in this subpanel
      - label:
          x: 40
          y: 420
          text: "Devices in subpanel:"
          text_font: my_font_small
          text_color: 0x9AA4AE

      - obj:
          x: 40
          y: 450
          width: 944
          height: 80
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          scrollable: false
          scrollbar_mode: 'off'
          layout:
            type: flex
            flex_flow: ROW
            pad_row: 10
            pad_column: 10
            flex_align_main: START
            flex_align_cross: CENTER
            flex_align_track: CENTER
          widgets:
            - button:
                id: btn_sp_dev1
                width: 168
                height: 52
                radius: 14
                bg_color: 0x1C2229
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      const int sp = id(hu_current_subpanel);
                      if (sp == 1) {
                        id(hu_dev1_route) = (id(hu_dev1_route) == 1) ? 0 : 1;
                      } else {
                        id(hu_dev1_route) = (id(hu_dev1_route) == 2) ? 0 : 2;
                      }
                  - script.execute: hu_refresh_sp_device_picker
                widgets:
                  - label:
                      id: lbl_sp_dev1
                      align: center
                      text: ""
                      text_font: my_font_small
                      text_color: 0xFFFFFF
                  - label:
                      id: chk_sp_dev1
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_dev2
                width: 168
                height: 52
                radius: 14
                bg_color: 0x1C2229
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      const int sp = id(hu_current_subpanel);
                      if (sp == 1) {
                        id(hu_dev2_route) = (id(hu_dev2_route) == 1) ? 0 : 1;
                      } else {
                        id(hu_dev2_route) = (id(hu_dev2_route) == 2) ? 0 : 2;
                      }
                  - script.execute: hu_refresh_sp_device_picker
                widgets:
                  - label:
                      id: lbl_sp_dev2
                      align: center
                      text: ""
                      text_font: my_font_small
                      text_color: 0xFFFFFF
                  - label:
                      id: chk_sp_dev2
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_dev3
                width: 168
                height: 52
                radius: 14
                bg_color: 0x1C2229
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      const int sp = id(hu_current_subpanel);
                      if (sp == 1) {
                        id(hu_dev3_route) = (id(hu_dev3_route) == 1) ? 0 : 1;
                      } else {
                        id(hu_dev3_route) = (id(hu_dev3_route) == 2) ? 0 : 2;
                      }
                  - script.execute: hu_refresh_sp_device_picker
                widgets:
                  - label:
                      id: lbl_sp_dev3
                      align: center
                      text: ""
                      text_font: my_font_small
                      text_color: 0xFFFFFF
                  - label:
                      id: chk_sp_dev3
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_dev4
                width: 168
                height: 52
                radius: 14
                bg_color: 0x1C2229
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      const int sp = id(hu_current_subpanel);
                      if (sp == 1) {
                        id(hu_dev4_route) = (id(hu_dev4_route) == 1) ? 0 : 1;
                      } else {
                        id(hu_dev4_route) = (id(hu_dev4_route) == 2) ? 0 : 2;
                      }
                  - script.execute: hu_refresh_sp_device_picker
                widgets:
                  - label:
                      id: lbl_sp_dev4
                      align: center
                      text: ""
                      text_font: my_font_small
                      text_color: 0xFFFFFF
                  - label:
                      id: chk_sp_dev4
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true
            - button:
                id: btn_sp_dev5
                width: 168
                height: 52
                radius: 14
                bg_color: 0x1C2229
                bg_opa: 0
                border_width: 0
                on_click:
                  - lambda: |-
                      const int sp = id(hu_current_subpanel);
                      if (sp == 1) {
                        id(hu_dev5_route) = (id(hu_dev5_route) == 1) ? 0 : 1;
                      } else {
                        id(hu_dev5_route) = (id(hu_dev5_route) == 2) ? 0 : 2;
                      }
                  - script.execute: hu_refresh_sp_device_picker
                widgets:
                  - label:
                      id: lbl_sp_dev5
                      align: center
                      text: ""
                      text_font: my_font_small
                      text_color: 0xFFFFFF
                  - label:
                      id: chk_sp_dev5
                      text: "✓"
                      align: top_right
                      x: -10
                      y: 6
                      text_font: my_font_small
                      text_color: 0x2E7D32
                      hidden: true

      # Keyboard + done button (hidden by default)
      - keyboard:
          id: kb_sp_usage
          width: 1024
          height: 220
          align: bottom_mid
          y: 0
          mode: TEXT_LOWER
          floating: true
          bg_color: 0x1C2229
          border_width: 0
          outline_width: 0
          shadow_width: 0
          hidden: true

      - obj:
          id: btn_sp_kb_done
          hidden: true
          x: 20
          y: -230
          width: 120
          height: 50
          align: bottom_left
          radius: 10
          bg_color: 0x1C2229
          border_width: 0
          on_click:
            - lvgl.widget.hide: kb_sp_usage
            - lvgl.widget.hide: btn_sp_kb_done
          widgets:
            - label:
                align: center
                text: "Done"
                text_font: my_font
                text_color: 0xFFFFFF



  - id: usage_help_page
    bg_color: 0x141B21
    widgets:
      # Title
      - label:
          x: 51
          y: 20
          text: Home Usage Help
          text_font: my_font_large
          text_color: 0xFFFFFF

      # Back button
      - button:
          id: btn_usage_help_back
          width: 70
          height: 70
          align: top_right
          x: -38
          y: 15
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          pad_all: 0
          on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: usage_device_select_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - image:
                src: img_close_res
                align: center
                bg_opa: 0
                zoom: 0.5

      # Body text (placeholder explanation)
      - label:
          x: 80
          y: 120
          text: "Home assistant instructions:"
          text_font: my_font_small
          text_color: 0xDDDDDD
          long_mode: wrap
          width: 864
      - label:
          x: 80
          y: 145
          text: "Open File Editor in home assistant and goto packages,"
          text_font: my_font_small
          text_color: 0xDDDDDD
          long_mode: wrap
          width: 864
      - label:
          x: 80
          y: 165
          text: "In the Packages folder search for a file called energydevices.yaml"
          text_font: my_font_small
          text_color: 0xDDDDDD
          long_mode: wrap
          width: 864   
      - label:
          x: 80
          y: 185
          text: "In this file you can add the home assistant entities behind devices:"
          text_font: my_font_small
          text_color: 0xDDDDDD
          long_mode: wrap
          width: 864
      - label:
          x: 80
          y: 205
          text: "Like this     Devices: 'sensor.homeassistantentitiename'  " 
          text_color: 0xDDDDDD
          text_font: my_font_small
          long_mode: wrap
          width: 864
      - label:
          x: 80
          y: 225
          text: "Do not forget that this has to be a entitie that has a Power (W) Value" 
          text_color: 0xDDDDDD
          text_font: my_font_small
          long_mode: wrap
          width: 864                      
  - id: display_page
    bg_color: 0x141B21
    widgets:
      # Title
      - label:
          x: 51
          y: 20
          text: Display
          text_font: my_font_large
          text_color: 16777215

      # Card: Backlight (moved from Settings)
      - obj:
          id: card_display_backlight
          x: 77
          y: 100
          width: 870
          height: 100
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 3355443
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - switch.toggle: backlight_switch
          widgets:
            - label:
                x: 20
                y: 18
                text: Backlight
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Tap to toggle display backlight
                text_font: my_font_small
                text_color: 10395294
            - obj:
                id: pill_backlight
                width: 141
                height: 45
                radius: 22
                bg_color: 4342338
                align: right_mid
                x: -15
                pad_all: 0
                scrollable: false
                scrollbar_mode: 'off'
                widgets:
                  - label:
                      id: lbl_backlight_state
                      text: --
                      text_font: my_font_small
                      text_color: 16777215
                      align: center
                      width: 141
                      text_align: center
                      x: 0
                      y: 0

      # Card: Display mode (Sensor vs Always on)
      - obj:
          id: card_display_mode
          x: 77
          y: 220
          width: 870
          height: 100
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 3355443
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - switch.toggle: display_auto_sleep_toggle
          widgets:
            - label:
                x: 20
                y: 18
                text: Screen Sleep
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Sensor + touch when ON, always on when OFF
                text_font: my_font_small
                text_color: 10395294
            - obj:
                id: pill_display_mode
                width: 141
                height: 45
                radius: 22
                bg_color: 4342338
                align: right_mid
                x: -15
                pad_all: 0
                scrollable: false
                scrollbar_mode: 'off'
                widgets:
                  - label:
                      id: lbl_display_mode_state
                      text: --
                      text_font: my_font_small
                      text_color: 16777215
                      align: center
                      width: 141
                      text_align: center
                      x: 0
                      y: 0
      - obj:
          id: card_display_timeout
          x: 77
          y: 340
          width: 870
          height: 100
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 3355443
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lambda: |-
                float v = id(display_timeout_seconds).state;
                int current = (int)v;
                int next;

                // Cycle: 30s → 60s → 300s → 600s → 900s → 1800s → back to 30s
                switch (current) {
                  case 30:    next = 60;    break;   // 30s -> 1m
                  case 60:    next = 300;   break;   // 1m -> 5m
                  case 300:   next = 600;   break;   // 5m -> 10m
                  case 600:   next = 900;   break;   // 10m -> 15m
                  case 900:   next = 1800;  break;   // 15m -> 30m
                  case 1800:  // fallthrough
                  default:    next = 30;    break;   // back to 30s
                }

                id(display_timeout_seconds).publish_state(next);
          widgets:
            - label:
                x: 20
                y: 18
                text: Screen Timeout
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Time screen stays on after last movement
                text_font: my_font_small
                text_color: 10395294
            - obj:
                id: pill_display_timeout
                width: 141
                height: 45
                radius: 22
                bg_color: 4342338
                align: right_mid
                x: -15
                pad_all: 0
                scrollable: false
                scrollbar_mode: 'off'
                widgets:
                  - label:
                      id: lbl_display_timeout_state
                      text: 15s
                      text_font: my_font_small
                      text_color: 16777215
                      align: center
                      width: 141
                      text_align: center
                      x: 0
                      y: 0
      # - obj:
      #     id: card_display_sensor_test
      #     x: 77
      #     y: 510
      #     width: 870
      #     height: 100
      #     radius: 15
      #     bg_color: 0x1C2229
      #     border_width: 1
      #     border_color: 3355443
      #     scrollable: false
      #     scrollbar_mode: 'off'
      #     on_click:
      #       - switch.toggle: sensor_test_toggle
      #     widgets:
      #       - label:
      #           x: 20
      #           y: 18
      #           text: Sensor test
      #           text_font: my_font
      #           text_color: 16777215
      #       - label:
      #           x: 20
      #           y: 55
      #           text: Press to test the motion sensor and show distance
      #           text_font: my_font_small
      #           text_color: 10395294
      #       - obj:
      #           id: pill_sensor_test
      #           width: 190
      #           height: 45
      #           radius: 22
      #           bg_color: 4342338
      #           align: right_mid
      #           x: -15
      #           pad_all: 0
      #           scrollable: false
      #           scrollbar_mode: 'off'
      #           widgets:
      #             - label:
      #                 id: lbl_sensor_distance
      #                 text: ''
      #                 text_font: my_font_small
      #                 text_color: 16777215
      #                 align: center
      #                 width: 190
      #                 text_align: center
            # Card: Brightness
      - obj:
          id: card_display_brightness
          x: 77
          y: 460
          width: 870
          height: 120
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 3355443
          scrollable: false
          scrollbar_mode: 'off'
          widgets:
            - label:
                x: 20
                y: 18
                text: Brightness
                text_font: my_font
                text_color: 16777215
            - label:
                x: 20
                y: 55
                text: Slide to adjust screen brightness
                text_font: my_font_small
                text_color: 10395294

            - slider:
                id: sld_brightness
                x: 340
                y: 25
                width: 300
                height: 35
                min_value: 5
                max_value: 100
                value: 80
                on_value:
                  - lambda: |-
                      const float b = (float)x / 100.0f;
                      // Keep backlight power on while adjusting brightness
                      id(lcd_backlight).turn_on().set_brightness(b).perform();

                      char buf[8];
                      snprintf(buf, sizeof(buf), "%d%%", (int)x);
                      lv_label_set_text(id(lbl_brightness_val), buf);

            - obj:
                id: pill_brightness_val
                width: 141
                height: 45
                radius: 22
                bg_color: 4342338
                align: right_mid
                x: -15
                pad_all: 0
                scrollable: false
                scrollbar_mode: 'off'
                widgets:
                  - label:
                      id: lbl_brightness_val
                      text: 80%
                      text_font: my_font_small
                      text_color: 16777215
                      align: center
                      width: 141
                      text_align: center
                      x: 0
                      y: 0

# Top-right menu button (same pattern as Wi-Fi page)
      - button:
          id: btn_topright_display
          width: 102
          height: 70
          align: top_right
          x: -38            # nudge from right edge
          y: 15             # nudge from top
          bg_color: 0x23282F
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          pad_all: 0
          shadow_color: 0x23282F
          on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: menu_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay 
          widgets:
            - image:
                src: img_menu_res
                align: center
                bg_opa: 0
                zoom: 0.5  
  - id: wifi_page
    bg_color: 0x141B21
    widgets:
      - label:
          x: 51
          y: 20
          text: Wi-Fi
          text_font: my_font_large
          text_color: 16777215

      - obj:
          id: card_wifi_status
          x: 77
          y: 150
          width: 870
          height: 375
          radius: 15
          bg_color: 0x1C2229
          border_width: 1
          border_color: 3355443
          scrollable: false
          widgets:
            - label:
                x: 20
                y: 18
                text: Connection
                text_font: my_font
                text_color: 16777215

            # Connection pill (left)
            - obj:
                id: pill_wifi_state
                x: 190
                y: 14
                width: 123
                height: 45
                radius: 22
                bg_color: 4342338
                scrollable: false
                widgets:
                  - label:
                      id: lbl_wifi_state
                      text: --
                      text_font: my_font_small
                      text_color: 16777215
                      align: center



            - label:
                x: 20
                y: 85
                text: SSID
                text_font: my_font_small
                text_color: 10395294
            - label:
                id: lbl_wifi_ssid
                x: 205
                y: 85
                width: 614
                text: --
                text_font: my_font_small
                text_color: 16777215

            - label:
                x: 20
                y: 135
                text: IP
                text_font: my_font_small
                text_color: 10395294
            - label:
                id: lbl_wifi_ip
                x: 205
                y: 135
                width: 614
                text: --
                text_font: my_font_small
                text_color: 16777215

            - label:
                x: 20
                y: 185
                text: Signal
                text_font: my_font_small
                text_color: 10395294
            - label:
                id: lbl_wifi_rssi
                x: 205
                y: 185
                width: 614
                text: --
                text_font: my_font_small
                text_color: 16777215



            - label:
                x: 20
                y: 235
                text: Api Key
                text_font: my_font_small
                text_color: 10395294

            - label:
                id: lbl_api_key
                x: 205
                y: 235
                width: 560
                text: " "
                text_font: my_font_small
                text_color: 16777215
                long_mode: DOT

            - button:
                id: btn_show_api_key
                x: 230
                y: 228
                width: 54
                height: 54
                radius: 14
                bg_color: 0x2E3A46
                pad_all: 0
                on_click:
                  - lambda: |-
                      lv_label_set_text(id(secret_title), "API encryption key");
                      lv_label_set_text(id(secret_value), "${api_key_full}");
                  - lvgl.widget.show: secret_overlay
                widgets:
                  - label:
                      text: "\U000F0208"
                      align: center
                      text_font: mdi_60
                      text_color: 0xFFFFFF


            - label:
                x: 20
                y: 285
                text: Ota Key
                text_font: my_font_small
                text_color: 10395294

            - label:
                id: lbl_ota_key
                x: 205
                y: 285
                width: 560
                text: " "
                text_font: my_font_small
                text_color: 16777215
                long_mode: DOT

            - button:
                id: btn_show_ota_key
                x: 230
                y: 278
                width: 54
                height: 54
                radius: 14
                bg_color: 0x2E3A46
                pad_all: 0
                on_click:
                  - lambda: |-
                      lv_label_set_text(id(secret_title), "OTA password");
                      lv_label_set_text(id(secret_value), "${ota_key_full}");
                  - lvgl.widget.show: secret_overlay
                widgets:
                  - label:
                      text: "\U000F0208"
                      align: center
                      text_font: mdi_60
                      text_color: 0xFFFFFF



      - button:
          id: btn_wifi_back
          width: 70
          height: 70
          align: top_right
          x: -38
          y: 15
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          pad_all: 0
          on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: settings_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - image:
                src: img_close_res
                align: center
                bg_opa: 0
                zoom: 0.5
      # RIGHT: Fallback AP (sticky)
      - button:
          x: 670
          y: 200
          width: 256
          height: 60
          radius: 12
          on_click:
            # Keep captive portal available even if your normal Wi-Fi is in range:
            # switch the radio into AP-only mode (ESP-IDF) and keep enforcing it.
            - lambda: |-
                id(force_ap_mode) = true;

                wifi_config_t ap_cfg;
                memset(&ap_cfg, 0, sizeof(ap_cfg));

                const std::string ssid = id(fallback_ap_ssid_str);
                const std::string pass = id(fallback_ap_pass_str);

                strncpy((char*) ap_cfg.ap.ssid, ssid.c_str(), sizeof(ap_cfg.ap.ssid));
                ap_cfg.ap.ssid_len = ssid.size();

                if (!pass.empty()) {
                  strncpy((char*) ap_cfg.ap.password, pass.c_str(), sizeof(ap_cfg.ap.password));
                  ap_cfg.ap.authmode = WIFI_AUTH_WPA2_PSK;
                } else {
                  ap_cfg.ap.authmode = WIFI_AUTH_OPEN;
                }

                ap_cfg.ap.max_connection = 4;
                ap_cfg.ap.channel = 1;

                // Drop STA and bring up AP.
                esp_wifi_disconnect();
                esp_wifi_stop();
                esp_wifi_set_mode(WIFI_MODE_AP);
                esp_wifi_set_config(WIFI_IF_AP, &ap_cfg);
                esp_wifi_start();
            - lambda: |-
                lv_label_set_text(id(lbl_wifi_ip), "192.168.4.1");
                lv_label_set_text(id(lbl_wifi_ssid), id(fallback_ap_ssid_str).c_str());

            - lvgl.label.update:
                id: lbl_wifi_state
                text: "AP"
            - lvgl.label.update:
                id: lbl_addwifi_state
                text: "AP"
          widgets:
            - label:
                text: Fallback AP
                text_font: my_font
                text_color: 16777215
                align: center

      # RIGHT: Restore EW14
      - button:
          x: 670
          y: 265
          width: 256
          height: 55
          radius: 12
          on_click:
            - lambda: |-
                id(force_ap_mode) = false;
                esp_wifi_set_mode(WIFI_MODE_STA);
            - wifi.disable
            - delay: 200ms
            - wifi.configure:
                ssid: !secret wifi_ssid_1
                password: !secret wifi_password_1
                save: true
            - wifi.enable
          widgets:
            - label:
                text: Connect to EW14
                text_font: my_font_small
                text_color: 16777215
                align: center

      # RIGHT: Restore WIFI_2
      - button:
          x: 670
          y: 325
          width: 256
          height: 55
          radius: 12
          on_click:
            - lambda: |-
                id(force_ap_mode) = false;
                esp_wifi_set_mode(WIFI_MODE_STA);
            - wifi.disable
            - delay: 200ms
            - wifi.configure:
                ssid: !secret wifi_ssid_2
                password: !secret wifi_password_2
                save: true
            - wifi.enable
          widgets:
            - label:
                text: Connect to WIFI_2
                text_font: my_font_small
                text_color: 16777215
                align: center

      # RIGHT: Restore WIFI_3
      - button:
          x: 670
          y: 385
          width: 256
          height: 55
          radius: 12
          on_click:
            - lambda: |-
                id(force_ap_mode) = false;
                esp_wifi_set_mode(WIFI_MODE_STA);
            - wifi.disable
            - delay: 200ms
            - wifi.configure:
                ssid: !secret wifi_ssid_3
                password: !secret wifi_password_3
                save: true
            - wifi.enable
          widgets:
            - label:
                text: Connect to WIFI_3
                text_font: my_font_small
                text_color: 16777215
                align: center



      # RIGHT: Add Network
      - button:
          x: 670
          y: 455
          width: 256
          height: 55
          radius: 12
          on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: add_wifi_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - label:
                text: Add Network
                text_font: my_font_small
                text_color: 16777215
                align: center

  - id: add_wifi_page
    bg_color: 0x141B21
    widgets:
      # Title
      - label:
          x: 51
          y: 20
          text: Add Network
          text_font: my_font_large
          text_color: 16777215

      # Connection pill
      - obj:
          id: pill_addwifi_state
          x: 500
          y: 320
          width: 170
          height: 45
          radius: 22
          bg_color: 4342338
          scrollable: false
          widgets:
            - label:
                id: lbl_addwifi_state
                text: --
                text_font: my_font_small
                text_color: 16777215
                align: center

      # Close (X) button
      - button:
          id: btn_addwifi_close
          width: 70
          height: 70
          align: top_right
          x: -38
          y: 15
          bg_opa: 0
          border_width: 0
          outline_width: 0
          shadow_width: 0
          pad_all: 0
          on_click:
            - lvgl.widget.show: loading_overlay
            - delay: 20ms
            - lvgl.page.show: wifi_page
            - delay: 250ms
            - lvgl.widget.hide: loading_overlay
          widgets:
            - image:
                src: img_close_res
                align: center
                bg_opa: 0
                zoom: 0.5

      # SSID field
      - label:
          x: 80
          y: 120
          text: "SSID"
          text_font: my_font_small
          text_color: 0x9E9E9E

      - textarea:
          id: ta_add_wifi_ssid
          x: 80
          y: 150
          width: 864
          height: 48
          text: ""
          text_font: my_font
          text_color: 0x000000
          max_length: 32
          one_line: true
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lvgl.keyboard.update:
                id: kb_addwifi
                textarea: ta_add_wifi_ssid
            - lvgl.widget.show: kb_addwifi
            - lvgl.widget.show: btn_addwifi_kb_done

      # Password field
      - label:
          x: 80
          y: 215
          text: "Password"
          text_font: my_font_small
          text_color: 0x9E9E9E

      - textarea:
          id: ta_add_wifi_pass
          x: 80
          y: 245
          width: 864
          height: 48
          text: ""
          text_font: my_font
          text_color: 0x000000
          max_length: 64
          one_line: true
          scrollable: false
          scrollbar_mode: 'off'
          on_click:
            - lvgl.keyboard.update:
                id: kb_addwifi
                textarea: ta_add_wifi_pass
            - lvgl.widget.show: kb_addwifi
            - lvgl.widget.show: btn_addwifi_kb_done

      # Connect button
      - button:
          x: 670
          y: 320
          width: 256
          height: 55
          radius: 12
          on_click:
            - lambda: |-
                id(force_ap_mode) = false;
                id(add_wifi_ssid_str) = std::string(lv_textarea_get_text(id(ta_add_wifi_ssid)));
                id(add_wifi_pass_str) = std::string(lv_textarea_get_text(id(ta_add_wifi_pass)));
            - wifi.disable
            - delay: 200ms
            - wifi.configure:
                ssid: !lambda "return id(add_wifi_ssid_str);"
                password: !lambda "return id(add_wifi_pass_str);"
                save: true
            - wifi.enable
          widgets:
            - label:
                text: Connect
                text_font: my_font_small
                text_color: 16777215
                align: center

      # Keyboard (floating)
      - keyboard:
          id: kb_addwifi
          width: 1024
          height: 220
          align: bottom_mid
          y: 0
          mode: TEXT_LOWER
          floating: true
          bg_color: 0x1C2229
          border_width: 0
          outline_width: 0
          shadow_width: 0
          hidden: true

      # Done button for keyboard (floats above keyboard)
      - obj:
          id: btn_addwifi_kb_done
          x: 20
          y: -230
          width: 100
          height: 40
          align: bottom_left
          bg_color: 0x333333
          radius: 10
          pad_all: 8
          on_click:
            - lvgl.widget.hide: kb_addwifi
            - lvgl.widget.hide: btn_addwifi_kb_done
          widgets:
            - label:
                text: "Done"
                align: center
                text_color: 0xFFFFFF
                long_mode: dot
          hidden: true

  - id: graph_page
    bg_color: 0x141B21
    widgets:
    - label:
        id: lbl_graph_title
        x: 154
        y: 20
        text: Today - Solar Production (Wh)
        text_font: my_font
        text_color: 16777215
        scrollbar_mode: 'off'
    - button:
        id: ds_btn_0
        x: 31
        y: 88
        width: 128
        height: 45
        radius: 12
        bg_color: 4473924
        on_click:
        - lambda: 'id(current_dataset) = 0;

            lv_label_set_text(id(lbl_graph_title), "Today - Solar Production (Wh)");'
        widgets:
        - label:
            text: PV
            text_color: 16777215
            text_font: my_font_small
            align: center
    - button:
        id: ds_btn_1
        x: 166
        y: 88
        width: 128
        height: 45
        radius: 12
        bg_color: 4473924
        on_click:
        - lambda: 'id(current_dataset) = 1;

            lv_label_set_text(id(lbl_graph_title), "Today - PV -> House (Wh)");'
        widgets:
        - label:
            text: PV->Home
            text_color: 16777215
            text_font: my_font_small
            align: center
    - button:
        id: ds_btn_2
        x: 302
        y: 88
        width: 128
        height: 45
        radius: 12
        bg_color: 4473924
        on_click:
        - lambda: 'id(current_dataset) = 2;

            lv_label_set_text(id(lbl_graph_title), "Today - House (Wh)");'
        widgets:
        - label:
            text: House
            text_color: 16777215
            text_font: my_font_small
            align: center
    - button:
        id: ds_btn_3
        x: 438
        y: 88
        width: 128
        height: 45
        radius: 12
        bg_color: 4473924
        on_click:
        - lambda: 'id(current_dataset) = 3;

            lv_label_set_text(id(lbl_graph_title), "Today - Import (Wh)");'
        widgets:
        - label:
            text: Import
            text_color: 16777215
            text_font: my_font_small
            align: center
    - button:
        id: ds_btn_4
        x: 573
        y: 88
        width: 128
        height: 45
        radius: 12
        bg_color: 4473924
        on_click:
        - lambda: 'id(current_dataset) = 4;

            lv_label_set_text(id(lbl_graph_title), "Today - Export (Wh)");'
        widgets:
        - label:
            text: Export
            text_color: 16777215
            text_font: my_font_small
            align: center
    - button:
        id: ds_btn_5
        x: 709
        y: 88
        width: 128
        height: 45
        radius: 12
        bg_color: 4473924
        on_click:
        - lambda: 'id(current_dataset) = 5;

            lv_label_set_text(id(lbl_graph_title), "Today - Battery In (Wh)");'
        widgets:
        - label:
            text: Batt In
            text_color: 16777215
            text_font: my_font_small
            align: center
    - button:
        id: ds_btn_6
        x: 845
        y: 88
        width: 128
        height: 45
        radius: 12
        bg_color: 4473924
        on_click:
        - lambda: 'id(current_dataset) = 6;

            lv_label_set_text(id(lbl_graph_title), "Today - Battery Out (Wh)");'
        widgets:
        - label:
            text: Batt Out
            text_color: 16777215
            text_font: my_font_small
            align: center
    - button:
        id: ds_btn_7
        x: 31
        y: 138
        width: 128
        height: 45
        radius: 12
        bg_color: 4473924
        on_click:
        - lambda: 'id(current_dataset) = 7;

            lv_label_set_text(id(lbl_graph_title), "Today - Battery (%)");'
        widgets:
        - label:
            text: Batt %
            text_color: 16777215
            text_font: my_font_small
            align: center
    - obj:
        id: graph_baseline
        x: 26
        y: 527
        width: 973
        height: 2
        bg_color: 10395294
        bg_opa: 100%
        border_width: 0
    - obj:
        id: bar_00
        x: 31
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_01
        x: 69
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_02
        x: 108
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_03
        x: 146
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_04
        x: 184
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_05
        x: 223
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_06
        x: 261
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_07
        x: 300
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_08
        x: 338
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_09
        x: 376
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_10
        x: 415
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_11
        x: 453
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_12
        x: 492
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_13
        x: 530
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_14
        x: 568
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_15
        x: 607
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_16
        x: 645
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_17
        x: 684
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_18
        x: 722
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_19
        x: 760
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_20
        x: 799
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_21
        x: 837
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_22
        x: 876
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - obj:
        id: bar_23
        x: 914
        y: 525
        width: 23
        height: 2
        radius: 5
        bg_color: 3706428
        bg_opa: 100%
        border_width: 0
        scrollbar_mode: 'off'
    - label:
        id: lbl_hr_00
        x: 31
        y: 555
        text: '0'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_01
        x: 69
        y: 555
        text: '1'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_02
        x: 108
        y: 555
        text: '2'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_03
        x: 146
        y: 555
        text: '3'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_04
        x: 184
        y: 555
        text: '4'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_05
        x: 223
        y: 555
        text: '5'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_06
        x: 261
        y: 555
        text: '6'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_07
        x: 300
        y: 555
        text: '7'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_08
        x: 338
        y: 555
        text: '8'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_09
        x: 376
        y: 555
        text: '9'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_10
        x: 415
        y: 555
        text: '10'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_11
        x: 453
        y: 555
        text: '11'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_12
        x: 492
        y: 555
        text: '12'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_13
        x: 530
        y: 555
        text: '13'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_14
        x: 568
        y: 555
        text: '14'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_15
        x: 607
        y: 555
        text: '15'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_16
        x: 645
        y: 555
        text: '16'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_17
        x: 684
        y: 555
        text: '17'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_18
        x: 722
        y: 555
        text: '18'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_19
        x: 760
        y: 555
        text: '19'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_20
        x: 799
        y: 555
        text: '20'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_21
        x: 837
        y: 555
        text: '21'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_22
        x: 876
        y: 555
        text: '22'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_hr_23
        x: 914
        y: 555
        text: '23'
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_00
        x: 31
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_01
        x: 69
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_02
        x: 108
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_03
        x: 146
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_04
        x: 184
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_05
        x: 223
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_06
        x: 261
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_07
        x: 300
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_08
        x: 338
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_09
        x: 376
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_10
        x: 415
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_11
        x: 453
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_12
        x: 492
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_13
        x: 530
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_14
        x: 568
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_15
        x: 607
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_16
        x: 645
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_17
        x: 684
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_18
        x: 722
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_19
        x: 760
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_20
        x: 799
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_21
        x: 837
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_22
        x: 876
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215
    - label:
        id: lbl_val_23
        x: 914
        y: 188
        text: ''
        text_font: my_font_small
        text_color: 16777215

    - button:
        id: btn_topright_graph
        width: 102
        height: 70
        align: top_right
        x: -38            # nudge from right edge
        y: 15             # nudge from top
        bg_color: 0x23282F
        bg_opa: 0
        border_width: 0
        outline_width: 0
        shadow_width: 0
        pad_all: 0
        shadow_color: 0x23282F
        on_click:
          - lvgl.widget.show: loading_overlay
          - delay: 20ms
          - lvgl.page.show: menu_page
          - delay: 250ms
          - lvgl.widget.hide: loading_overlay 
        widgets:
          - image:
              src: img_menu_res
              align: center
              bg_opa: 0
              zoom: 0.5  
button:
- platform: restart
  id: restart_device
  name: Restart Device

display:
- platform: rpi_dpi_rgb
  id: my_display
  update_interval: never
  auto_clear_enabled: false
  color_order: RGB
  pclk_frequency: 30MHz
  pclk_inverted: true
  rotation: 0
  dimensions:
    width: 1024
    height: 600
  de_pin: 5
  reset_pin:
    waveshare_io_ch32v003: wave_io
    number: 3
#  enable_pin:
#    ch422g: io_ex
#    number: 4
  hsync_pulse_width: 162
  hsync_back_porch: 152
  hsync_front_porch: 48
  vsync_pulse_width: 45
  vsync_back_porch: 13
  vsync_front_porch: 3
  pclk_pin: 7
  hsync_pin: { number: 46, ignore_strapping_warning: true }
  vsync_pin: { number: 3,  ignore_strapping_warning: true }
  data_pins:
    red:
    - 1
    - 2
    - 42
    - 41
    - 40
    green:
    - 39
    - 0
    - 45
    - 48
    - 47
    - 21
    blue:
    - 14
    - 38
    - 18
    - 17
    - 10

font:
- file: fonts/Roboto_SemiCondensed-SemiBold.ttf
  id: my_font
  size: 30
- file: fonts/Roboto_SemiCondensed-SemiBold.ttf
  id: my_font_large
  size: 50
- file: fonts/Roboto_SemiCondensed-SemiBold.ttf
  id: my_font_small
  size: 25
- file: fonts/Roboto_SemiCondensed-SemiBold.ttf
  id: my_font_medium
  size: 38
- file: fonts/materialdesignicons-webfont.ttf
  id: mdi_60
  size: 60
  glyphs:
    - "\U000F0143" # mdi-chevron-up
    - "\U000F0140" # mdi-chevron-down
    - "\U000F0156" # mdi-return
    - "\U000F0208" # mdi-eye


color:
- id: mdi_blue
  hex: 2196F3
- id: mdi_purple
  hex: 673AB7
- id: mdi_grey
  hex: 9E9E9E
- id: mdi_dark_grey
  hex: 424242
- id: mdi_white
  hex: FFFFFF
- id: mdi_green
  hex: 388E3C
- id: mdi_red
  hex: B71C1C
- id: mdi_orange
  hex: FF9800
image:
- id: img_device1
  file: "icons/device1.png"
  type: RGB565
  transparency: alpha_channel
- id: img_close_res
  file: "icons/close.png"
  type: RGB565
  transparency: alpha_channel
- id: img_menu_res
  file: "icons/menu.png"
  type: RGB565
  transparency: alpha_channel
- id: arrow_down_res
  file: "icons/arrowdownred.png"
  type: RGB565
  transparency: alpha_channel
- id: arrow_up_res
  file: "icons/arrowupblue.png"
  type: RGB565
  transparency: alpha_channel
- id: node_solar_img
  file: "icons/icon_sun_100.png"
  type: RGB565
  transparency: alpha_channel
- id: node_home_100
  file: "icons/icon_home_100.png"
  type: RGB565
  transparency: alpha_channel
- id: node_battery_100
  file: "icons/icon_battery_100.png"
  type: RGB565
  transparency: alpha_channel
- id: node_grid_100
  file: "icons/icon_grid_100.png"
  type: RGB565
  transparency: alpha_channel
- id: esphome_logo
  file: "icons/esphome.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_img_solar
  file: "icons/solar.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_img_grid
  file: "icons/grid.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_img_home
  file: "icons/home.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_batt_0010
  file: "icons/battery10.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_batt_1020
  file: "icons/battery1020.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_batt_2030
  file: "icons/battery2030.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_batt_3040
  file: "icons/battery3040.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_batt_4050
  file: "icons/battery4050.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_batt_5060
  file: "icons/battery5060.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_batt_6070
  file: "icons/battery6070.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_batt_7080
  file: "icons/battery7080.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_batt_8090
  file: "icons/battery8090.png"
  type: RGB565
  transparency: alpha_channel
- id: hp2_batt_90100
  file: "icons/battery90100.png"
  type: RGB565
  transparency: alpha_channel
- id: hu_icon_homecog
  file: "icons/homecog.png"
  type: RGB565
  transparency: alpha_channel
- id: hu_icon_towel
  file: "icons/towel.png"
  type: RGB565
  transparency: alpha_channel
- id: hu_icon_dehumidifier
  file: "icons/dehumidifier.png"
  type: RGB565
  transparency: alpha_channel
- id: hu_icon_heater
  file: "icons/heater.png"
  type: RGB565
  transparency: alpha_channel
- id: hu_icon_heating
  file: "icons/heating.png"
  type: RGB565
  transparency: alpha_channel
- id: hu_icon_office
  file: "icons/office.png"
  type: RGB565
  transparency: alpha_channel
- id: hu_icon_pcdesk
  file: "icons/pcdesk.png"
  type: RGB565
  transparency: alpha_channel
- id: hu_icon_sauna
  file: "icons/sauna.png"
  type: RGB565
  transparency: alpha_channel
- id: hu_icon_sofa
  file: "icons/sofa.png"
  type: RGB565
  transparency: alpha_channel
- id: hu_icon_spa
  file: "icons/spa.png"
  type: RGB565
  transparency: alpha_channel
script:
- id: boot_flow
  mode: queued
  then:
    - lvgl.page.show: boot_page
    - lvgl.widget.hide: btn_boot_menu
    - lambda: lv_label_set_text(id(lbl_boot_status), "Connecting to Home Assistant…");
- id: finish_boot
  mode: restart
  then:
    - lambda: id(api_ready) = true;
    - lambda: lv_label_set_text(id(lbl_boot_status), "Connected. Loading entities…");
    - delay: !lambda |
        return id(boot_extra_delay_ms);
    - if:
        condition:
          switch.is_on: change_homepage 
        then:
          - lvgl.page.show: home_page         # old/original homepage
        else:
          - lvgl.page.show: home_page_2       # new homepage
- id: maybe_show_boot_menu
  mode: restart
  then:
    - delay: 30s
    - if:
        condition:
          api.connected: null
        then:
          - logger.log: API connected; keeping boot menu hidden
        else:
        - lvgl.widget.show: btn_boot_menu
        - lambda: lv_label_set_text(id(lbl_boot_status), "No API connection yet. Open Menu.");

- id: interval_show_target_page
  mode: restart
  then:
    - if:
        condition:
          lambda: 'return id(interval_target_bit) == 0;'
        then:
          - lvgl.page.show: home_page
    - if:
        condition:
          lambda: 'return id(interval_target_bit) == 1;'
        then:
          - lvgl.page.show: home_page_2
    - if:
        condition:
          lambda: 'return id(interval_target_bit) == 2;'
        then:
          - lvgl.page.show: solar_page
    - if:
        condition:
          lambda: 'return id(interval_target_bit) == 3;'
        then:
          - lvgl.page.show: solar_info_page
    - if:
        condition:
          lambda: 'return id(interval_target_bit) == 4;'
        then:
          - lvgl.page.show: battery_page
    - if:
        condition:
          lambda: 'return id(interval_target_bit) == 5;'
        then:
          - lvgl.page.show: grid_page
    - if:
        condition:
          lambda: 'return id(interval_target_bit) == 6;'
        then:
          - lvgl.page.show: graph_page
    - if:
        condition:
          lambda: 'return id(interval_target_bit) == 7;'
        then:
          - lvgl.page.show: home_usage_page

- id: interval_refresh_settings_ui
  mode: restart
  then:
    - lambda: |-
        auto set_border = [&](lv_obj_t *btn, int bit) {
          if (btn == nullptr) return;
          bool on = (id(interval_pages_mask) & (1 << bit)) != 0;
          lv_obj_set_style_border_width(btn, on ? 4 : 1, 0);
          lv_obj_set_style_border_color(btn, lv_color_hex(on ? 0x2E7D32 : 0x333333), 0);
        };

        // Seconds label on settings page
        if (id(lbl_interval_seconds) != nullptr) {
          lv_label_set_text(id(lbl_interval_seconds), str_sprintf("%d", id(interval_seconds)).c_str());
        }

        // Tile outlines
        set_border(id(btn_int_home), 0);
        set_border(id(btn_int_home2), 1);
        set_border(id(btn_int_info), 3);
        set_border(id(btn_int_solar), 2);
        set_border(id(btn_int_battery), 4);
        set_border(id(btn_int_grid), 5);
        set_border(id(btn_int_graph), 6);
        set_border(id(btn_int_usage), 7);

        // "All/None" tile text
        if (id(lbl_int_allnone) != nullptr) {
          int mask = id(interval_pages_mask) & 0xFF;
          lv_label_set_text(id(lbl_int_allnone), (mask == 0xFF) ? "None" : "All");
        }


- id: hu_refresh_icon_picker
  mode: restart
  then:
    - lambda: |-
        // Highlight the selected icon tile on usage_settings_page
        int sel = id(hu_edit_icon_idx);
        auto set_tile = [&](lv_obj_t* btn, lv_obj_t* chk, int idx) {
          if (idx == sel) {
            lv_obj_set_style_border_width(btn, 4, LV_PART_MAIN);
            lv_obj_set_style_border_color(btn, lv_color_hex(0x2E7D32), LV_PART_MAIN);
            lv_obj_clear_flag(chk, LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_set_style_border_width(btn, 1, LV_PART_MAIN);
            lv_obj_set_style_border_color(btn, lv_color_hex(0x333333), LV_PART_MAIN);
            lv_obj_add_flag(chk, LV_OBJ_FLAG_HIDDEN);
          }
        };

        set_tile(id(btn_hu_icon_0), id(chk_hu_icon_0), 0);
        set_tile(id(btn_hu_icon_1), id(chk_hu_icon_1), 1);
        set_tile(id(btn_hu_icon_2), id(chk_hu_icon_2), 2);
        set_tile(id(btn_hu_icon_3), id(chk_hu_icon_3), 3);
        set_tile(id(btn_hu_icon_4), id(chk_hu_icon_4), 4);
        set_tile(id(btn_hu_icon_5), id(chk_hu_icon_5), 5);
        set_tile(id(btn_hu_icon_6), id(chk_hu_icon_6), 6);
        set_tile(id(btn_hu_icon_7), id(chk_hu_icon_7), 7);
        set_tile(id(btn_hu_icon_8), id(chk_hu_icon_8), 8);
        set_tile(id(btn_hu_icon_9), id(chk_hu_icon_9), 9);

- id: hu_refresh_sp_icon_picker
  mode: restart
  then:
    - lambda: |-
        // Highlight selected icon tile on subpanel_settings_page (green outline only)
        const int sel = id(hu_sp_edit_icon_idx);

        auto set_tile = [&](lv_obj_t* btn, int idx) {
          if (!btn) return;
          if (idx == sel) {
            lv_obj_set_style_outline_width(btn, 3, LV_PART_MAIN);
            lv_obj_set_style_outline_color(btn, lv_color_hex(0x2E7D32), LV_PART_MAIN);
          } else {
            lv_obj_set_style_outline_width(btn, 0, LV_PART_MAIN);
          }
        };

        set_tile(id(btn_sp_icon_0), 0);
        set_tile(id(btn_sp_icon_1), 1);
        set_tile(id(btn_sp_icon_2), 2);
        set_tile(id(btn_sp_icon_3), 3);
        set_tile(id(btn_sp_icon_4), 4);
        set_tile(id(btn_sp_icon_5), 5);
        set_tile(id(btn_sp_icon_6), 6);
        set_tile(id(btn_sp_icon_7), 7);
        set_tile(id(btn_sp_icon_8), 8);
        set_tile(id(btn_sp_icon_9), 9);


- id: hu_refresh_sp_device_picker
  mode: restart
  then:
    - lambda: |-
        // Update device membership buttons for the currently edited subpanel (green outline only)
        const int sp = id(hu_current_subpanel);

        auto selected = [&](int route) -> bool {
          return (sp == 1) ? (route == 1) : (route == 2);
        };

        auto set_btn = [&](lv_obj_t* btn, int route) {
          if (!btn) return;
          if (selected(route)) {
            lv_obj_set_style_outline_width(btn, 3, LV_PART_MAIN);
            lv_obj_set_style_outline_color(btn, lv_color_hex(0x2E7D32), LV_PART_MAIN);
          } else {
            lv_obj_set_style_outline_width(btn, 0, LV_PART_MAIN);
          }
        };

        set_btn(id(btn_sp_dev1), id(hu_dev1_route));
        set_btn(id(btn_sp_dev2), id(hu_dev2_route));
        set_btn(id(btn_sp_dev3), id(hu_dev3_route));
        set_btn(id(btn_sp_dev4), id(hu_dev4_route));
        set_btn(id(btn_sp_dev5), id(hu_dev5_route));

        // Sync button labels to configured device names
        if (id(lbl_sp_dev1)) lv_label_set_text(id(lbl_sp_dev1), id(hu_dev1_name_str).c_str());
        if (id(lbl_sp_dev2)) lv_label_set_text(id(lbl_sp_dev2), id(hu_dev2_name_str).c_str());
        if (id(lbl_sp_dev3)) lv_label_set_text(id(lbl_sp_dev3), id(hu_dev3_name_str).c_str());
        if (id(lbl_sp_dev4)) lv_label_set_text(id(lbl_sp_dev4), id(hu_dev4_name_str).c_str());
        if (id(lbl_sp_dev5)) lv_label_set_text(id(lbl_sp_dev5), id(hu_dev5_name_str).c_str());



interval:
  - interval: 80ms
    then:
      - lambda: |-
          // Animate loading spinner only when visible
          if (lv_obj_has_flag(id(loading_overlay), LV_OBJ_FLAG_HIDDEN)) return;
          id(loading_rot) = (id(loading_rot) + 20) % 360;
          lv_arc_set_rotation(id(loading_arc), id(loading_rot));
  - interval: 1s
    then:
      - lambda: |-
          const uint32_t now = millis();

          // If auto sleep is disabled, do nothing
          if (!id(display_auto_sleep_toggle).state) {
            return;
          }

          // If HMMD currently sees presence, refresh the last_seen time
          if (id(hmmd_presence).state) {
            id(ld1125_last_presence_ms) = now;
            return;  // never turn off while presence is ON
          }

          // If we've never seen presence, nothing to do
          if (id(ld1125_last_presence_ms) == 0) {
            return;
          }

          // Timeout in ms, based on your pill value (seconds)
          uint32_t timeout_ms = (uint32_t)(id(display_timeout_seconds).state * 1000.0f);

          // If the timeout has passed since the last presence, and the screen is on, turn it off
          if (now - id(ld1125_last_presence_ms) > timeout_ms) {
            if (id(backlight_switch).state) {
              id(backlight_switch).turn_off();
            }
          }
  - interval: 100ms
    then:
      - lambda: |-
          // Only run when the Home Usage page is active
          if (!id(hu_home_usage_active)) return;
          if (!id(home_usage_page).is_showing()) return;


          if (!id(hu_anim_enabled)) return;
          // Keep the house power label aligned under the home icon (match info flow style)
          lv_obj_update_layout(id(hu_node_home));
          lv_obj_update_layout(id(hu_home_usage_value_label));
          lv_obj_align_to(id(hu_home_usage_value_label), id(hu_node_home), LV_ALIGN_OUT_BOTTOM_MID, 0, 8);

          // === Subpanel names (from globals) =================================
          lv_label_set_text(id(hu_sp1_name), id(hu_sp1_name_str).c_str());
          lv_label_set_text(id(hu_sp2_name), id(hu_sp2_name_str).c_str());

          // Subpanel value labels (formatted like devices: W)
          auto fmt_watts = [](float v) -> std::string {
            if (!std::isfinite(v)) return std::string("--");
            char b[24];
            snprintf(b, sizeof(b), "%.0f W", v);
            return std::string(b);
          };
          auto sp1_ok = id(hu_sp1_usage).has_state() && std::isfinite(id(hu_sp1_usage).state) && (id(hu_sp1_usage).state > 0.0f);
          if (sp1_ok) {
            lv_label_set_text(id(hu_sp1_value), fmt_watts(id(hu_sp1_usage).state).c_str());
          } else {
            lv_label_set_text(id(hu_sp1_value), "");
          }
          auto sp2_ok = id(hu_sp2_usage).has_state() && std::isfinite(id(hu_sp2_usage).state) && (id(hu_sp2_usage).state > 0.0f);
          if (sp2_ok) {
            lv_label_set_text(id(hu_sp2_value), fmt_watts(id(hu_sp2_usage).state).c_str());
          } else {
            lv_label_set_text(id(hu_sp2_value), "");
          }


          // === Home usage device names =====================================
          lv_label_set_text(id(hu_dev1_name), id(hu_dev1_name_str).c_str());
          lv_label_set_text(id(hu_dev2_name), id(hu_dev2_name_str).c_str());
          lv_label_set_text(id(hu_dev3_name), id(hu_dev3_name_str).c_str());
          lv_label_set_text(id(hu_dev4_name), id(hu_dev4_name_str).c_str());
          lv_label_set_text(id(hu_dev5_name), id(hu_dev5_name_str).c_str());

          // === Home usage device icons =====================================
          static int last_i1 = -1, last_i2 = -1, last_i3 = -1, last_i4 = -1, last_i5 = -1;
          auto icon_from_idx = [&](int idx) -> const void* {
            switch (idx) {
              case 0: return id(hu_icon_homecog).get_lv_img_dsc();
              case 1: return id(hu_icon_towel).get_lv_img_dsc();
              case 2: return id(hu_icon_dehumidifier).get_lv_img_dsc();
              case 3: return id(hu_icon_heater).get_lv_img_dsc();
              case 4: return id(hu_icon_heating).get_lv_img_dsc();
              case 5: return id(hu_icon_office).get_lv_img_dsc();
              case 6: return id(hu_icon_pcdesk).get_lv_img_dsc();
              case 7: return id(hu_icon_sauna).get_lv_img_dsc();
              case 8: return id(hu_icon_sofa).get_lv_img_dsc();
              case 9: return id(hu_icon_spa).get_lv_img_dsc();
              default: return id(hu_icon_homecog).get_lv_img_dsc();
            }
          };
          auto apply_icon = [&](lv_obj_t* img, int &last, int idx) {
            if (idx != last) {
              last = idx;
              lv_img_set_src(img, icon_from_idx(idx));
            }
          };
          apply_icon(id(hu_dev1_icon), last_i1, id(hu_dev1_icon_idx));
          apply_icon(id(hu_dev2_icon), last_i2, id(hu_dev2_icon_idx));
          apply_icon(id(hu_dev3_icon), last_i3, id(hu_dev3_icon_idx));
          apply_icon(id(hu_dev4_icon), last_i4, id(hu_dev4_icon_idx));
          apply_icon(id(hu_dev5_icon), last_i5, id(hu_dev5_icon_idx));

          static int last_sp1 = -1;
          static int last_sp2 = -1;
          apply_icon(id(hu_sp1_icon), last_sp1, id(hu_sp1_icon_idx));
          apply_icon(id(hu_sp2_icon), last_sp2, id(hu_sp2_icon_idx));


          // ---------- Helpers ----------
          // Row updater: show/hide + value text
          auto update_row = [](lv_obj_t* icon,
                               lv_obj_t* name_lbl,
                               lv_obj_t* val_lbl,
                               homeassistant::HomeassistantSensor* s) {
            if (!s || !s->has_state() || std::isnan(s->state) || std::isinf(s->state) || s->state <= 0.0f) {
              lv_obj_add_flag(icon, LV_OBJ_FLAG_HIDDEN);
              lv_obj_add_flag(name_lbl, LV_OBJ_FLAG_HIDDEN);
              lv_obj_add_flag(val_lbl, LV_OBJ_FLAG_HIDDEN);
              return;
            }
            lv_obj_clear_flag(icon, LV_OBJ_FLAG_HIDDEN);
            lv_obj_clear_flag(name_lbl, LV_OBJ_FLAG_HIDDEN);
            lv_obj_clear_flag(val_lbl, LV_OBJ_FLAG_HIDDEN);

            char buf[32];
            snprintf(buf, sizeof(buf), "%.0f W", s->state);
            lv_label_set_text(val_lbl, buf);
          };

          // Get top-left "screen" position by walking parents
          auto screen_pos = [](lv_obj_t* obj) -> std::pair<int,int> {
            int x = 0, y = 0;
            lv_obj_t* cur = obj;
            while (cur) {
              x += lv_obj_get_x(cur);
              y += lv_obj_get_y(cur);
              cur = lv_obj_get_parent(cur);
            }
            return {x, y};
          };

          // Center of 'obj' expressed in the coordinate space of 'parent_space'
          auto center_in_parent = [&](lv_obj_t* obj, lv_obj_t* parent_space) -> std::pair<int,int> {
            // Ensure positions/sizes are up-to-date before reading coordinates
            lv_obj_update_layout(parent_space);
            lv_obj_update_layout(obj);
            auto [ox, oy] = screen_pos(obj);
            auto [px, py] = screen_pos(parent_space);
            int cx = (ox - px) + lv_obj_get_width(obj)  / 2;
            int cy = (oy - py) + lv_obj_get_height(obj) / 2;
            return {cx, cy};
          };

          // ---------- Update rows ----------
          update_row(id(hu_dev1_icon), id(hu_dev1_name), id(hu_dev1_value), id(hu_dev1_usage));
          update_row(id(hu_dev2_icon), id(hu_dev2_name), id(hu_dev2_value), id(hu_dev2_usage));
          update_row(id(hu_dev3_icon), id(hu_dev3_name), id(hu_dev3_value), id(hu_dev3_usage));
          update_row(id(hu_dev4_icon), id(hu_dev4_name), id(hu_dev4_value), id(hu_dev4_usage));
          update_row(id(hu_dev5_icon), id(hu_dev5_name), id(hu_dev5_value), id(hu_dev5_usage));

          // ---------- Persistent point buffers (LVGL keeps pointers) ----------
          static lv_point_t hu_d1_pts[2];
          static lv_point_t hu_d2_pts[2];
          static lv_point_t hu_d3_pts[2];
          static lv_point_t hu_d4_pts[2];
          static lv_point_t hu_d5_pts[2];

          // Helper: get a point on left/right-middle of an icon, in parent_space coords
          auto side_point = [&](lv_obj_t* obj, lv_obj_t* parent_space, bool right_side) -> std::pair<int,int> {
            if (!obj) return {0,0};
            lv_obj_update_layout(obj);
            lv_area_t a;
            lv_obj_get_coords(obj, &a);
            lv_area_t p;
            lv_obj_get_coords(parent_space, &p);
            int w = a.x2 - a.x1 + 1;
            int h = a.y2 - a.y1 + 1;
            int cx = a.x1 - p.x1 + w/2;
            int cy = a.y1 - p.y1 + h/2;
            if (right_side) cx += (w/2);
            else cx -= (w/2);
            return {cx, cy};
          };

          // ---------- Animator for one device ----------
          auto animate_device = [&](homeassistant::HomeassistantSensor* s,
                                    float &phase,
                                    lv_obj_t* home_icon,
                                    lv_obj_t* dev_icon,
                                    lvgl::LvLineType* line_comp,
                                    lv_obj_t* dots[6],
                                    lv_point_t* pts) {
            // If no line object, hide dots and bail
            if (!line_comp || !line_comp->obj) {
              for (int i = 0; i < 6; i++) lv_obj_add_flag(dots[i], LV_OBJ_FLAG_HIDDEN);
              return;
            }

            // Ensure the line object spans its parent so our points aren't clipped
            lv_obj_t* line_parent = lv_obj_get_parent(line_comp->obj);
            if (line_parent) {
              lv_obj_set_pos(line_comp->obj, 0, 0);
              lv_obj_set_size(line_comp->obj,
                              lv_obj_get_width(line_parent),
                              lv_obj_get_height(line_parent));
            }

            // Make the line visible regardless of theme defaults
            lv_obj_set_style_line_width(line_comp->obj, 3, LV_PART_MAIN);
            lv_obj_set_style_line_color(line_comp->obj, lv_color_hex(0x334455), LV_PART_MAIN);
            lv_obj_set_style_line_opa(line_comp->obj, LV_OPA_COVER, LV_PART_MAIN);
            lv_obj_set_style_line_rounded(line_comp->obj, true, LV_PART_MAIN);

            // No data or <= 0: hide line & dots
            if (!s || !s->has_state() || std::isnan(s->state) || std::isinf(s->state) || s->state <= 0.0f) {
              lv_obj_add_flag(line_comp->obj, LV_OBJ_FLAG_HIDDEN);
              for (int i = 0; i < 6; i++) lv_obj_add_flag(dots[i], LV_OBJ_FLAG_HIDDEN);
              return;
            }

            // Show line & dots
            lv_obj_clear_flag(line_comp->obj, LV_OBJ_FLAG_HIDDEN);
            for (int i = 0; i < 6; i++) lv_obj_clear_flag(dots[i], LV_OBJ_FLAG_HIDDEN);

            // Compute centers in the line's parent coordinate space
            lv_obj_t* parent_space = line_parent ? line_parent : lv_obj_get_parent(home_icon);
            auto [home_x, home_y] = center_in_parent(home_icon, parent_space);
            auto [dev_x,  dev_y ] = center_in_parent(dev_icon,  parent_space);

            // Stagger Home-side origins (top→bottom: SP1, Dev1..5, SP2)
            if (home_icon == id(hu_node_home)) {
              // Use a consistent Home-side anchor (right-middle) for stable ordering
              auto [hx, hy] = side_point(home_icon, parent_space, true);
              home_x = hx;
              home_y = hy;

              int rank = -1;
              if (dev_icon == id(hu_sp1_icon)) rank = 0;
              else if (dev_icon == id(hu_dev1_icon)) rank = 1;
              else if (dev_icon == id(hu_dev2_icon)) rank = 2;
              else if (dev_icon == id(hu_dev3_icon)) rank = 3;
              else if (dev_icon == id(hu_dev4_icon)) rank = 4;
              else if (dev_icon == id(hu_dev5_icon)) rank = 5;
              else if (dev_icon == id(hu_sp2_icon)) rank = 6;

              if (rank >= 0) {
                int h = lv_obj_get_height(home_icon);
                int step = h / 9;  // dynamic spacing based on icon size
                if (step < 12) step = 12;
                if (step > 20) step = 20;
                home_y += (rank - 3) * step;
              }
            }

            float vx = float(dev_x - home_x);
            float vy = float(dev_y - home_y);
            float L  = sqrtf(vx*vx + vy*vy);
            // Guard against degenerate/invalid geometry (prevents dots "sticking" at top-left)
            if (!std::isfinite(L) || L < 1e-3f) {
              lv_obj_add_flag(line_comp->obj, LV_OBJ_FLAG_HIDDEN);
              for (int i = 0; i < 6; i++) {
                lv_obj_add_flag(dots[i], LV_OBJ_FLAG_HIDDEN);
                lv_obj_set_pos(dots[i], -20, -20);
              }
              return;
            }

            float ux = vx / L;
            float uy = vy / L;

            // Edge trims so line/dots touch icon edges, not centers
            int home_w = lv_obj_get_width(home_icon);
            int home_h = lv_obj_get_height(home_icon);
            int dev_w  = lv_obj_get_width(dev_icon);
            int dev_h  = lv_obj_get_height(dev_icon);
            float home_r = 0.5f * float((home_w < home_h) ? home_w : home_h);
            float dev_r  = 0.5f * float((dev_w  < dev_h)  ? dev_w  : dev_h);
            bool start_is_home = (home_icon == id(hu_node_home));
            // If we anchored to the home icon edge already, don't push the start further out.
            float trim_start = start_is_home ? 6.0f : (home_r + 6.0f);
            float trim_end   = dev_r  + 6.0f;

            float sx = home_x + ux * trim_start;
            float sy = home_y + uy * trim_start;
            float ex = dev_x  - ux * trim_end;
            float ey = dev_y  - uy * trim_end;

            // Update persistent points and line geometry
            pts[0].x = (lv_coord_t)sx; pts[0].y = (lv_coord_t)sy;
            pts[1].x = (lv_coord_t)ex; pts[1].y = (lv_coord_t)ey;
            lv_line_set_points(line_comp->obj, pts, 2);

            // Dot speed scales with usage (clamped to avoid aliasing / "reverse" illusion)
            float usage = s ? s->state : NAN;
            if (!std::isfinite(usage) || usage <= 0.0f) usage = 1.0f;

            // With 6 dots: spacing = 1/6 ≈ 0.166. Keep step < ~0.083 to avoid wagon-wheel.
            // We choose a conservative max step.
            float speed = 0.015f + (usage / 3000.0f) * 0.04f;   // tune feel
            if (speed < 0.010f) speed = 0.010f;
            if (speed > 0.070f) speed = 0.070f;

            // Robust wrap
            phase = fmodf(phase + speed, 1.0f);
            if (phase < 0.0f) phase += 1.0f;


            // Place 6 dots along the line segment
            const int N = 6;
            for (int i = 0; i < N; i++) {
              float t = phase + (float)i / N;
              while (t > 1.0f) t -= 1.0f;
              float x = sx + (ex - sx) * t;
              float y = sy + (ey - sy) * t;
              if (!std::isfinite(x) || !std::isfinite(y)) {
                lv_obj_add_flag(dots[i], LV_OBJ_FLAG_HIDDEN);
                continue;
              }
              lv_obj_clear_flag(dots[i], LV_OBJ_FLAG_HIDDEN);
              lv_obj_set_pos(dots[i], (int)x - 5, (int)y - 5);
            }
          };

          // Dot arrays
          lv_obj_t* sp1dots[6] = { id(hu_sp1_dot_0), id(hu_sp1_dot_1), id(hu_sp1_dot_2), id(hu_sp1_dot_3), id(hu_sp1_dot_4), id(hu_sp1_dot_5) };
          lv_obj_t* sp2dots[6] = { id(hu_sp2_dot_0), id(hu_sp2_dot_1), id(hu_sp2_dot_2), id(hu_sp2_dot_3), id(hu_sp2_dot_4), id(hu_sp2_dot_5) };

          lv_obj_t* dots1[6] = { id(hu_d1_dot_0), id(hu_d1_dot_1), id(hu_d1_dot_2), id(hu_d1_dot_3), id(hu_d1_dot_4), id(hu_d1_dot_5) };
          lv_obj_t* dots2[6] = { id(hu_d2_dot_0), id(hu_d2_dot_1), id(hu_d2_dot_2), id(hu_d2_dot_3), id(hu_d2_dot_4), id(hu_d2_dot_5) };
          lv_obj_t* dots3[6] = { id(hu_d3_dot_0), id(hu_d3_dot_1), id(hu_d3_dot_2), id(hu_d3_dot_3), id(hu_d3_dot_4), id(hu_d3_dot_5) };
          lv_obj_t* dots4[6] = { id(hu_d4_dot_0), id(hu_d4_dot_1), id(hu_d4_dot_2), id(hu_d4_dot_3), id(hu_d4_dot_4), id(hu_d4_dot_5) };
          lv_obj_t* dots5[6] = { id(hu_d5_dot_0), id(hu_d5_dot_1), id(hu_d5_dot_2), id(hu_d5_dot_3), id(hu_d5_dot_4), id(hu_d5_dot_5) };

          // Decide which subpanels should be shown
          auto has_valid_w = [](homeassistant::HomeassistantSensor* s) -> bool {
            return s && s->has_state() && std::isfinite(s->state) && s->state > 0.0f;
          };
          bool sp1_has_device = (id(hu_dev1_route) == 1) || (id(hu_dev2_route) == 1) || (id(hu_dev3_route) == 1) || (id(hu_dev4_route) == 1) || (id(hu_dev5_route) == 1);
          bool sp2_has_device = (id(hu_dev1_route) == 2) || (id(hu_dev2_route) == 2) || (id(hu_dev3_route) == 2) || (id(hu_dev4_route) == 2) || (id(hu_dev5_route) == 2);
          bool show_sp1 = id(hu_sp1_enabled) && (sp1_has_device || has_valid_w(id(hu_sp1_usage)));
          bool show_sp2 = id(hu_sp2_enabled) && (sp2_has_device || has_valid_w(id(hu_sp2_usage)));

          // Show/hide subpanel widgets
          auto set_hidden = [](lv_obj_t* o, bool hide) {
            if (!o) return;
            if (hide) lv_obj_add_flag(o, LV_OBJ_FLAG_HIDDEN);
            else lv_obj_clear_flag(o, LV_OBJ_FLAG_HIDDEN);
          };
          set_hidden(id(hu_sp1_icon), !show_sp1);
          set_hidden(id(hu_sp1_name), !show_sp1);
          set_hidden(id(hu_sp1_value), !show_sp1);
          set_hidden(id(hu_sp2_icon), !show_sp2);
          set_hidden(id(hu_sp2_name), !show_sp2);
          set_hidden(id(hu_sp2_value), !show_sp2);

          // Animate Home -> Subpanel links
          static lv_point_t hu_sp1_pts[2];
          static lv_point_t hu_sp2_pts[2];

          auto animate_link_watts = [&](float watts,
                                       float &phase,
                                       lv_obj_t* start_icon,
                                       lv_obj_t* end_icon,
                                       lvgl::LvLineType* line_comp,
                                       lv_obj_t* dots[6],
                                       lv_point_t* pts,
                                       bool force_side_mid) {
            if (!line_comp || !line_comp->obj) {
              for (int i = 0; i < 6; i++) lv_obj_add_flag(dots[i], LV_OBJ_FLAG_HIDDEN);
              return;
            }

            lv_obj_t* line_parent = lv_obj_get_parent(line_comp->obj);
            lv_obj_t* parent_space = line_parent ? line_parent : lv_obj_get_parent(start_icon);

            // Ensure line spans full parent
            if (line_parent) {
              lv_obj_set_size(line_comp->obj, lv_obj_get_width(line_parent), lv_obj_get_height(line_parent));
              lv_obj_set_pos(line_comp->obj, 0, 0);
            }

            lv_obj_clear_flag(line_comp->obj, LV_OBJ_FLAG_HIDDEN);
            for (int i = 0; i < 6; i++) lv_obj_clear_flag(dots[i], LV_OBJ_FLAG_HIDDEN);

            int sx, sy, ex, ey;
            if (force_side_mid) {
              auto [sx0, sy0] = side_point(start_icon, parent_space, true);   // right-middle
              auto [ex0, ey0] = side_point(end_icon,   parent_space, false);  // left-middle
              sx = sx0; sy = sy0; ex = ex0; ey = ey0;              // Stagger Home-side link origins to avoid crossing (top→bottom: SP1, Dev1..5, SP2)
              if (start_icon == id(hu_node_home)) {
                // Use consistent Home-side anchor (right-middle) for stable ordering
                auto [hx, hy] = side_point(start_icon, parent_space, true);
                sx = hx;
                sy = hy;

                int rank = -1;
                if (end_icon == id(hu_sp1_icon)) rank = 0;
                else if (end_icon == id(hu_sp2_icon)) rank = 6;
                if (rank >= 0) {
                  int h = lv_obj_get_height(start_icon);
                  int step = h / 9;
                  if (step < 12) step = 12;
                  if (step > 20) step = 20;
                  sy += (rank - 3) * step;
                }
              }

            } else {
              auto [sx0, sy0] = center_in_parent(start_icon, parent_space);
              auto [ex0, ey0] = center_in_parent(end_icon,   parent_space);
              sx = sx0; sy = sy0; ex = ex0; ey = ey0;
            }

            float vx = float(ex - sx);
            float vy = float(ey - sy);
            float L  = sqrtf(vx*vx + vy*vy);

            if (!std::isfinite(L) || L < 1e-3f) {
              lv_obj_add_flag(line_comp->obj, LV_OBJ_FLAG_HIDDEN);
              for (int i = 0; i < 6; i++) {
                lv_obj_add_flag(dots[i], LV_OBJ_FLAG_HIDDEN);
                lv_obj_set_pos(dots[i], -20, -20);
              }
              return;
            }

            pts[0].x = (lv_coord_t)sx; pts[0].y = (lv_coord_t)sy;
            pts[1].x = (lv_coord_t)ex; pts[1].y = (lv_coord_t)ey;
            lv_line_set_points(line_comp->obj, pts, 2);

            if (!std::isfinite(watts) || watts <= 0.0f) watts = 1.0f; // keep gentle animation

            // Clamp to avoid aliasing / apparent reverse flow at high watts
            float speed = 0.015f + (watts / 3000.0f) * 0.04f;
            if (speed < 0.010f) speed = 0.010f;
            if (speed > 0.070f) speed = 0.070f;

            phase = fmodf(phase + speed, 1.0f);
            if (phase < 0.0f) phase += 1.0f;


            const int N = 6;
            for (int i = 0; i < N; i++) {
              float t = phase + (float)i / (float)N;
              if (t > 1.0f) t -= 1.0f;
              float x = (float)sx + vx * t;
              float y = (float)sy + vy * t;
              if (!std::isfinite(x) || !std::isfinite(y)) {
                lv_obj_add_flag(dots[i], LV_OBJ_FLAG_HIDDEN);
                continue;
              }
              lv_obj_clear_flag(dots[i], LV_OBJ_FLAG_HIDDEN);
              lv_obj_set_pos(dots[i], (int)x - 5, (int)y - 5);
            }
          };

          // Read subpanel watts (may be NaN/0) for animation
          float sp1_w = id(hu_sp1_usage).has_state() ? id(hu_sp1_usage).state : NAN;
          float sp2_w = id(hu_sp2_usage).has_state() ? id(hu_sp2_usage).state : NAN;

          if (show_sp1) {
            animate_link_watts(sp1_w, id(hu_sp1_phase), id(hu_node_home), id(hu_sp1_icon), id(hu_line_sp1), sp1dots, hu_sp1_pts, true);
          } else {
            if (id(hu_line_sp1) && id(hu_line_sp1)->obj) lv_obj_add_flag(id(hu_line_sp1)->obj, LV_OBJ_FLAG_HIDDEN);
            for (int i=0;i<6;i++) { lv_obj_add_flag(sp1dots[i], LV_OBJ_FLAG_HIDDEN); lv_obj_set_pos(sp1dots[i], -20, -20); }
          }
          if (show_sp2) {
            animate_link_watts(sp2_w, id(hu_sp2_phase), id(hu_node_home), id(hu_sp2_icon), id(hu_line_sp2), sp2dots, hu_sp2_pts, true);
          } else {
            if (id(hu_line_sp2) && id(hu_line_sp2)->obj) lv_obj_add_flag(id(hu_line_sp2)->obj, LV_OBJ_FLAG_HIDDEN);
            for (int i=0;i<6;i++) { lv_obj_add_flag(sp2dots[i], LV_OBJ_FLAG_HIDDEN); lv_obj_set_pos(sp2dots[i], -20, -20); }
          }

          // Animate all 5 devices with flexible routing
          lv_obj_t* start1 = (id(hu_dev1_route) == 1 && show_sp1) ? id(hu_sp1_icon) : (id(hu_dev1_route) == 2 && show_sp2) ? id(hu_sp2_icon) : id(hu_node_home);
          lv_obj_t* start2 = (id(hu_dev2_route) == 1 && show_sp1) ? id(hu_sp1_icon) : (id(hu_dev2_route) == 2 && show_sp2) ? id(hu_sp2_icon) : id(hu_node_home);
          lv_obj_t* start3 = (id(hu_dev3_route) == 1 && show_sp1) ? id(hu_sp1_icon) : (id(hu_dev3_route) == 2 && show_sp2) ? id(hu_sp2_icon) : id(hu_node_home);
          lv_obj_t* start4 = (id(hu_dev4_route) == 1 && show_sp1) ? id(hu_sp1_icon) : (id(hu_dev4_route) == 2 && show_sp2) ? id(hu_sp2_icon) : id(hu_node_home);
          lv_obj_t* start5 = (id(hu_dev5_route) == 1 && show_sp1) ? id(hu_sp1_icon) : (id(hu_dev5_route) == 2 && show_sp2) ? id(hu_sp2_icon) : id(hu_node_home);

          animate_device(id(hu_dev1_usage), id(hu_d1_phase), start1, id(hu_dev1_icon), id(hu_line_d1), dots1, hu_d1_pts);
          animate_device(id(hu_dev2_usage), id(hu_d2_phase), start2, id(hu_dev2_icon), id(hu_line_d2), dots2, hu_d2_pts);
          animate_device(id(hu_dev3_usage), id(hu_d3_phase), start3, id(hu_dev3_icon), id(hu_line_d3), dots3, hu_d3_pts);
          animate_device(id(hu_dev4_usage), id(hu_d4_phase), start4, id(hu_dev4_icon), id(hu_line_d4), dots4, hu_d4_pts);
          animate_device(id(hu_dev5_usage), id(hu_d5_phase), start5, id(hu_dev5_icon), id(hu_line_d5), dots5, hu_d5_pts);

  - interval: 300ms
    then:
      - lambda: |-
          // ----------------- Solar Info Page -----------------

          // Only animate when the soalr info page is active (optional, but nice)
          if (!id(solar_info_page).is_showing()) {
            return;
          }

          // Node positions (center points)
          const int sx = 512, sy = 75;     // Solar (top)      was 60
          const int hx = 845, hy = 300;    // Home  (right)    was 240
          const int bx = 512, by = 500;    // Battery (bottom) was 400
          const int gx = 179, gy = 300;    // Grid  (left)     was 240
          const int cx = 512, cy = 300;    // Center (hub)     was 240

          auto clampf = [](float v, float lo, float hi) { return v < lo ? lo : (v > hi ? hi : v); };
          // Build a cubic Bézier path that curves inside and trims near endpoints
          auto build_bezier_path = [&](int sx0, int sy0, int dx0, int dy0,
                                       int c1x, int c1y, int c2x, int c2y,
                                       int lane_dx, int lane_dy,
                                       int* xs, int* ys, int& outN) {
            outN = 0;
            const int   M    = 23;        // samples per path
            const float TRIM = 71.0f;     // ~ radius(32) + 8px gap

            float C1x = float(c1x + lane_dx), C1y = float(c1y + lane_dy);
            float C2x = float(c2x + lane_dx), C2y = float(c2y + lane_dy);

            float Sx = float(sx0), Sy = float(sy0);
            float Dx = float(dx0), Dy = float(dy0);

            auto normalize = [&](float& vx, float& vy) {
              float L = sqrtf(vx * vx + vy * vy);
              if (L < 1e-3f) { vx = 1.0f; vy = 0.0f; return; }
              vx /= L; vy /= L;
            };

            { float vx = C1x - Sx, vy = C1y - Sy; normalize(vx, vy); Sx += vx * TRIM; Sy += vy * TRIM; }
            { float vx = Dx - C2x, vy = Dy - C2y; normalize(vx, vy); Dx -= vx * TRIM; Dy -= vy * TRIM; }

            xs[outN] = int(Sx); ys[outN] = int(Sy); outN++;
            for (int k = 1; k < M; ++k) {
              float t  = float(k) / float(M);
              float u  = 1.0f - t;
              float bx = u*u*u*Sx + 3*u*u*t*C1x + 3*u*t*t*C2x + t*t*t*Dx;
              float by = u*u*u*Sy + 3*u*u*t*C1y + 3*u*t*t*C2y + t*t*t*Dy;
              xs[outN] = int(roundf(bx));
              ys[outN] = int(roundf(by));
              outN++;
            }
            xs[outN] = int(Dx); ys[outN] = int(Dy); outN++;
          };

          // Animate dots along a polyline
          auto animate_poly = [&](float watts,
                                  const int* xs, const int* ys, int n,
                                  lv_obj_t** dots, int count, int slot) {
            static float offs[8] = {0};
            float segL[48]; float total = 0.0f;

            for (int i = 0; i < n - 1; i++) {
              float dx = float(xs[i + 1] - xs[i]);
              float dy = float(ys[i + 1] - ys[i]);
              float L  = sqrtf(dx * dx + dy * dy);
              segL[i]  = (L < 1.0f) ? 1.0f : L;
              total   += segL[i];
            }

            if (std::isnan(watts) || fabsf(watts) < 1.0f || total < 2.0f) {
              for (int i = 0; i < count; i++) lv_obj_set_pos(dots[i], -77, -75);
              return;
            }

            float speed = clampf(fabsf(watts) / 220.0f, 1.2f, 18.0f); // px/tick
            int dir = (watts >= 0.0f) ? 1 : -1;

            offs[slot] += dir * speed;
            while (offs[slot] >= total) offs[slot] -= total;
            while (offs[slot] < 0)      offs[slot] += total;

            float spacing = total / float(count);

            for (int i = 0; i < count; i++) {
              float tdist = fmodf(offs[slot] + i * spacing, total);

              float acc = 0.0f; int seg = 0;
              while (seg < n - 1 && tdist >= acc + segL[seg]) { acc += segL[seg]; seg++; }
              if (seg >= n - 1) seg = n - 2;

              float local = tdist - acc;
              float ux = (xs[seg + 1] - xs[seg]) / segL[seg];
              float uy = (ys[seg + 1] - ys[seg]) / segL[seg];

              int x = int(xs[seg] + ux * local);
              int y = int(ys[seg] + uy * local);
              lv_obj_set_pos(dots[i], x - 4, y - 4);
            }
          };

          // Point+normal at fraction t for dynamic label placement
          auto point_and_normal = [&](const int* xs, const int* ys, int n, float t,
                                      int& ox, int& oy, float& nx, float& ny) {
            float segL[48]; float total = 0.0f;
            for (int i = 0; i < n - 1; i++) {
              float dx = xs[i + 1] - xs[i], dy = ys[i + 1] - ys[i];
              float L  = sqrtf(dx * dx + dy * dy);
              segL[i]  = (L < 1.0f) ? 1.0f : L; total += segL[i];
            }
            if (total < 1.0f) { ox = xs[0]; oy = ys[0]; nx = 0; ny = -1; return; }
            float dist = (t < 0.f ? 0.f : (t > 1.f ? 1.f : t)) * total;

            float acc = 0.0f; int seg = 0;
            while (seg < n - 1 && dist > acc + segL[seg]) { acc += segL[seg]; seg++; }
            if (seg >= n - 1) seg = n - 2;

            float local = dist - acc;
            float ux = (xs[seg + 1] - xs[seg]) / segL[seg];
            float uy = (ys[seg + 1] - ys[seg]) / segL[seg];

            ox = int(xs[seg] + ux * local);
            oy = int(ys[seg] + uy * local);
            nx = -uy; ny = ux;  // unit normal
          };

          // Place label on outside of curve
          auto update_label_outside = [&](lv_obj_t* lbl, float w,
                                          const int* xs, const int* ys, int n,
                                          float t, float base_offset_px) {
            if (std::isnan(w) || fabsf(w) < 1.0f) {
              lv_label_set_text(lbl, "");
              lv_obj_set_pos(lbl, -102, -100);
              return;
            }
            char b[20];
            if (fabsf(w) >= 1000.0f) snprintf(b, sizeof(b), "%.1f kW", w / 1000.0f);
            else                      snprintf(b, sizeof(b), "%.0f W",  w);
            lv_label_set_text(lbl, b);

            int px, py; float nx, ny;
            point_and_normal(xs, ys, n, t, px, py, nx, ny);

            float vx = cx - px, vy = cy - py;
            if (nx * vx + ny * vy > 0.0f) { nx = -nx; ny = -ny; }

            const float DOT_R = 5.0f;
            const float SAFE  = 28.0f;
            float offset = base_offset_px + DOT_R + SAFE;

            int lx = px + int(nx * offset) - 18;
            int ly = py + int(ny * offset) - 10;
            lv_obj_set_pos(lbl, lx, ly);
          };

          // --- dot arrays ------------------------------------------------------
          lv_obj_t* g2h[6]     = { id(g2h_dot_0),     id(g2h_dot_1),     id(g2h_dot_2),     id(g2h_dot_3),     id(g2h_dot_4),     id(g2h_dot_5) };
          lv_obj_t* grid2h[6]  = { id(grid2h_dot_0),  id(grid2h_dot_1),  id(grid2h_dot_2),  id(grid2h_dot_3),  id(grid2h_dot_4),  id(grid2h_dot_5) };
          lv_obj_t* b2h[6]     = { id(b2h_dot_0),     id(b2h_dot_1),     id(b2h_dot_2),     id(b2h_dot_3),     id(b2h_dot_4),     id(b2h_dot_5) };
          lv_obj_t* g2b[6]     = { id(g2b_dot_0),     id(g2b_dot_1),     id(g2b_dot_2),     id(g2b_dot_3),     id(g2b_dot_4),     id(g2b_dot_5) };
          lv_obj_t* grid2b[6]  = { id(grid2b_dot_0),  id(grid2b_dot_1),  id(grid2b_dot_2),  id(grid2b_dot_3),  id(grid2b_dot_4),  id(grid2b_dot_5) };
          lv_obj_t* g2g[6]     = { id(g2g_dot_0),     id(g2g_dot_1),     id(g2g_dot_2),     id(g2g_dot_3),     id(g2g_dot_4),     id(g2g_dot_5) };
          lv_obj_t* b2g[6]     = { id(b2g_dot_0),     id(b2g_dot_1),     id(b2g_dot_2),     id(b2g_dot_3),     id(b2g_dot_4),     id(b2g_dot_5) };

          // --- inside-curving Bézier lanes (parallel) -------------------------
          // Rightward bundle (to Home)
          int x_g2h[24],    y_g2h[24],    n_g2h;
          int x_grid2h[24], y_grid2h[24], n_grid2h;
          int x_b2h[24],    y_b2h[24],    n_b2h;
          build_bezier_path(sx, sy, hx, hy,  cx,    cy - 40, cx + 46, cy,     0,  -12, x_g2h,    y_g2h,    n_g2h);
          build_bezier_path(gx, gy, hx, hy,  cx - 46, cy - 10, cx + 46, cy - 10, 0,   -2,  x_grid2h, y_grid2h, n_grid2h);
          build_bezier_path(bx, by, hx, hy,  cx,    cy + 40, cx + 46, cy,     0,  +12, x_b2h,    y_b2h,    n_b2h);

          // Downward bundle (to Battery)
          int x_g2b[24],    y_g2b[24],    n_g2b;
          int x_grid2b[24], y_grid2b[24], n_grid2b;
          build_bezier_path(sx, sy, bx, by,  cx,    cy - 46, cx,     cy + 46, -12, 0,   x_g2b,    y_g2b,    n_g2b);
          build_bezier_path(gx, gy, bx, by,  cx - 46, cy,     cx,     cy + 46, +12, 0,   x_grid2b, y_grid2b, n_grid2b);

          // Leftward bundle (to Grid)
          int x_g2g[24], y_g2g[24], n_g2g;
          int x_b2g[24], y_b2g[24], n_b2g;
          build_bezier_path(sx, sy, gx, gy,  cx,    cy - 40, cx - 46, cy,     0,  0,   x_g2g,    y_g2g,    n_g2g);
          build_bezier_path(bx, by, gx, gy,  cx,    cy + 40, cx - 46, cy,     0,  0,   x_b2g,    y_b2g,    n_b2g);

          // --- animate dots ----------------------------------------------------
          animate_poly(id(generation_to_house).state,   x_g2h,    y_g2h,    n_g2h,    g2h,    6, 0);
          animate_poly(id(grid_to_house).state,         x_grid2h, y_grid2h, n_grid2h, grid2h, 6, 1);
          animate_poly(id(battery_to_house).state,      x_b2h,    y_b2h,    n_b2h,    b2h,    6, 2);

          animate_poly(id(generation_to_battery).state, x_g2b,    y_g2b,    n_g2b,    g2b,    6, 3);
          animate_poly(id(grid_to_battery).state,       x_grid2b, y_grid2b, n_grid2b, grid2b, 6, 4);

          animate_poly(id(generation_to_grid).state,    x_g2g,    y_g2g,    n_g2g,    g2g,    6, 5);
          animate_poly(id(battery_to_grid).state,       x_b2g,    y_b2g,    n_b2g,    b2g,    6, 6);

          // Outside the curves, farther from dots
          update_label_outside(id(lbl_g2h),    id(generation_to_house).state,   x_g2h,    y_g2h,    n_g2h,    0.45f, 20.0f);
          update_label_outside(id(lbl_grid2h), id(grid_to_house).state,         x_grid2h, y_grid2h, n_grid2h, 0.50f, 22.0f);
          update_label_outside(id(lbl_b2h),    id(battery_to_house).state,      x_b2h,    y_b2h,    n_b2h,    0.55f, 20.0f);

          update_label_outside(id(lbl_g2b),    id(generation_to_battery).state, x_g2b,    y_g2b,    n_g2b,    0.45f, 20.0f);
          update_label_outside(id(lbl_grid2b), id(grid_to_battery).state,       x_grid2b, y_grid2b, n_grid2b, 0.52f, 22.0f);

          update_label_outside(id(lbl_g2g),    id(generation_to_grid).state,    x_g2g,    y_g2g,    n_g2g,    0.48f, 20.0f);
          update_label_outside(id(lbl_b2g),    id(battery_to_grid).state,       x_b2g,    y_b2g,    n_b2g,    0.52f, 22.0f);

  - interval: 750ms
    then:
      - lambda: |-


          // ===== Dynamic Home left tile: Solar when producing, otherwise Grid import ====
          {
            auto nz = [](float v) { return (std::isnan(v) ? 0.0f : v); };

            const float SOLAR_MIN_W = 64.0f;  // threshold to consider "no solar"

            float solar_w = nz(id(solar_panel_production_sensor).state);
            float grid_w  = nz(id(imported_power_w).state);

            char b[20];

            if (solar_w > SOLAR_MIN_W) {
              // --- Show SOLAR production
              if (fabsf(solar_w) >= 1000.0f) snprintf(b, sizeof(b), "%.1f kW", solar_w / 1000.0f);
              else                            snprintf(b, sizeof(b), "%.0f W",  solar_w);
              lv_label_set_text(id(solar_input_value_label), b);

              // color (green high, orange mid, red low)
              if      (solar_w > 6000) lv_obj_set_style_text_color(id(solar_input_value_label), lv_color_hex(0x388E3C), LV_PART_MAIN);
              else if (solar_w > 1000) lv_obj_set_style_text_color(id(solar_input_value_label), lv_color_hex(0xFF9800), LV_PART_MAIN);
              else                     lv_obj_set_style_text_color(id(solar_input_value_label), lv_color_hex(0xB71C1C), LV_PART_MAIN);

              // show sun, hide grid (Solar tile navigates to Solar page)
              lv_obj_clear_flag(id(img_home_solar), LV_OBJ_FLAG_HIDDEN);
              lv_obj_add_flag   (id(img_home_grid),  LV_OBJ_FLAG_HIDDEN);
            } else {
              // --- Show GRID import
              if (fabsf(grid_w) >= 1000.0f) snprintf(b, sizeof(b), "%.1f kW", grid_w / 1000.0f);
              else                          snprintf(b, sizeof(b), "%.0f W",  grid_w);
              lv_label_set_text(id(solar_input_value_label), b);

              // color for import (red high, orange mid, green low)
              if      (grid_w > 5000) lv_obj_set_style_text_color(id(solar_input_value_label), lv_color_hex(0xB71C1C), LV_PART_MAIN);
              else if (grid_w > 1000) lv_obj_set_style_text_color(id(solar_input_value_label), lv_color_hex(0xFF9800), LV_PART_MAIN);
              else                    lv_obj_set_style_text_color(id(solar_input_value_label), lv_color_hex(0x388E3C), LV_PART_MAIN);

              // show grid, hide sun (Grid tile navigates to Grid page)
              lv_obj_clear_flag(id(img_home_grid),  LV_OBJ_FLAG_HIDDEN);
              lv_obj_add_flag   (id(img_home_solar), LV_OBJ_FLAG_HIDDEN);
            }
          }

          // ==================== Suggestion Box Logic (with OFF-GRID override) ====================
          {
            auto nz = [](float v) { return (std::isnan(v) ? 0.0f : v); };

            // --- OFF-GRID / BACKUP detection ---
            bool ha_backup = false;
            if (id(grid_backup_status_ha).has_state()) {
              ha_backup = !id(grid_backup_status_ha).state;  // invert: "off" => backup
            }
            bool sim_backup = id(simulate_backup_switch).state;
            bool is_backup  = ha_backup || sim_backup;

            // Helper for consistent box layout
            auto style_box_base = [&]() {
              const int padL = 20, padR = 16, padT = 12, padB = 12;
              lv_obj_set_width(id(suggestion_box), 973);
              lv_obj_align(id(suggestion_box), LV_ALIGN_BOTTOM_MID, 0, -5);
              lv_obj_set_style_pad_left  (id(suggestion_box), padL, LV_PART_MAIN);
              lv_obj_set_style_pad_right (id(suggestion_box), padR, LV_PART_MAIN);
              lv_obj_set_style_pad_top   (id(suggestion_box), padT, LV_PART_MAIN);
              lv_obj_set_style_pad_bottom(id(suggestion_box), padB, LV_PART_MAIN);
              lv_label_set_long_mode(id(suggestion_label), LV_LABEL_LONG_WRAP);
              lv_obj_set_width(id(suggestion_label), 760 - (padL + padR));
              lv_obj_align(id(suggestion_label), LV_ALIGN_TOP_LEFT, padL, padT);
              lv_obj_clear_flag(id(suggestion_box),   LV_OBJ_FLAG_HIDDEN);
              lv_obj_clear_flag(id(suggestion_label), LV_OBJ_FLAG_HIDDEN);
            };

            // === OFF-GRID override: force-visible, flashing RED background ===
            if (is_backup) {
              static int blink = 0;   // 150 ms interval above -> ~0.15s per tick
              blink = (blink + 1) % 8; // ~1.2s cycle
              bool on = (blink < 4);  // 50% duty

              style_box_base();

              // Red background flash + white text
              lv_obj_set_style_bg_color(id(suggestion_box), lv_color_hex(0xB71C1C), LV_PART_MAIN);
              lv_obj_set_style_bg_opa  (id(suggestion_box), on ? LV_OPA_COVER : LV_OPA_20, LV_PART_MAIN);
              lv_obj_set_style_outline_width(id(suggestion_box), 6, LV_PART_MAIN);
              lv_obj_set_style_outline_color(id(suggestion_box), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
              lv_obj_set_style_radius(id(suggestion_box), 12, LV_PART_MAIN);

              lv_obj_set_style_text_color(id(suggestion_label), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
              lv_label_set_text(id(suggestion_label), "Off grid. Backup mode on. Reduce energy!");

              // Do not run normal suggestions when in backup
              goto _suggestion_done;
            }

            // === DATA WARNING override (all power flows ~0 W) ===
            {
              // If all power-flow entities are ≈ 0 W, assume inverter/Modbus data fault
              auto nzf = [&](float v)->float { return std::isnan(v) ? 0.0f : v; };
              const float EPS_W = 1.0f;
              float flows[] = {
                fabsf(nzf(id(generation_to_house).state)),
                fabsf(nzf(id(grid_to_house).state)),
                fabsf(nzf(id(battery_to_house).state)),
                fabsf(nzf(id(generation_to_battery).state)),
                fabsf(nzf(id(grid_to_battery).state)),
                fabsf(nzf(id(generation_to_grid).state)),
                fabsf(nzf(id(battery_to_grid).state))
              };
              bool all_zero = true;
              for (size_t i = 0; i < sizeof(flows) / sizeof(flows[0]); ++i) {
                if (flows[i] > EPS_W) { all_zero = false; break; }
              }
              if (all_zero) {
                style_box_base();
                lv_obj_set_style_bg_color(id(suggestion_box), lv_color_hex(0xFF9800), LV_PART_MAIN);
                lv_obj_set_style_bg_opa  (id(suggestion_box), LV_OPA_COVER,          LV_PART_MAIN);
                lv_obj_set_style_outline_width(id(suggestion_box), 6, LV_PART_MAIN);
                lv_obj_set_style_outline_color(id(suggestion_box), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
                lv_obj_set_style_radius(id(suggestion_box), 12, LV_PART_MAIN);
                lv_obj_set_style_text_color(id(suggestion_label), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
                lv_label_set_text(id(suggestion_label), "Data issue. Inverter is not sending information.");
                goto _suggestion_done;
              }
            }

            // === Normal suggestions (respect toggle) ===
            if (id(suggestion_toggle).state == false) {
              lv_obj_add_flag(id(suggestion_box),   LV_OBJ_FLAG_HIDDEN);
              lv_obj_add_flag(id(suggestion_label), LV_OBJ_FLAG_HIDDEN);
            } else {
              float solar_w = nz(id(solar_panel_production_sensor).state);
              float g2h_w   = nz(id(grid_to_house).state);
              float b2h_w   = nz(id(battery_to_house).state);
              float b2g_w   = nz(id(battery_to_grid).state);
              float g2g_w   = nz(id(generation_to_grid).state);
              float b_in_w  = nz(id(battery_in_w).state);
              float house_w = nz(id(solar_house_consumption_sensor).state);
              float soc_pct = nz(id(solaredge_battery_soc).state);

              auto set_box = [&](const char* msg, uint32_t border_hex) {
                style_box_base();
                lv_obj_set_style_bg_color(id(suggestion_box), lv_color_hex(0x424242), LV_PART_MAIN);
                lv_obj_set_style_bg_opa  (id(suggestion_box), LV_OPA_COVER,          LV_PART_MAIN);
                lv_obj_set_style_outline_width(id(suggestion_box), 6, LV_PART_MAIN);
                lv_obj_set_style_border_color(id(suggestion_box), lv_color_hex(border_hex), LV_PART_MAIN);
                lv_obj_set_style_radius(id(suggestion_box), 12, LV_PART_MAIN);
                lv_obj_set_style_text_color(id(suggestion_label), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
                lv_label_set_text(id(suggestion_label), msg);
              };

              float export_w = fabsf(g2g_w) + fabsf(b2g_w);

              if (soc_pct <= 5.0f && g2h_w > 100.0f) {
                set_box("Battery is empty. Using grid power. Try to save energy.", 0xB71C1C);
              } else if (soc_pct < 30.0f) {
                set_box("Battery is low. Consider reducing usage.", 0xFF9800);
              } else if (g2h_w >= 4000.0f) {
                set_box("High grid use. Consider delaying or turning off appliances.", 0xB71C1C);
              } else if (solar_w > 4000.0f && export_w >= 2000.0f) {
                set_box("Lots of solar available. Good time to use energy.", 0x388E3C);
              } else if (b_in_w >= 4000.0f) {
                set_box("Battery is charging quickly. Storing extra solar.", 0x388E3C);
              } else if (b2h_w >= 2000.0f) {
                set_box("Battery is powering the home. Try to limit heavy appliances.", 0xFF9800);
              } else if (solar_w >= 1000.0f && solar_w < 4000.0f) {
                set_box("Solar production is moderate. Use energy normally.", 0x2196F3);
              } else if (solar_w > 50.0f && g2h_w < 200.0f && export_w < 300.0f) {
                set_box("Energy is balanced. Solar and battery are covering usage.", 0x388E3C);
              } else if (solar_w <= 50.0f && b2h_w > 100.0f) {
                set_box("No solar. Running on battery.", 0x2196F3);
              } else if (solar_w > 50.0f && solar_w < 800.0f) {
                set_box("Low solar. Battery may start discharging soon.", 0xFF9800);
              } else if (house_w < 300.0f) {
                set_box("Low household use. Efficient.", 0x388E3C);
              } else {
                set_box("Monitoring your energy flows.", 0x9E9E9E);
              }
            }

            _suggestion_done:;
          }
          // ==================== END Suggestion Box Logic ====================


          // --- Daily totals labels (PV, Home, Grid, Battery) ---
          {
            // Position the labels relative to their nodes (no scrolling)
            lv_obj_align_to(id(lbl_home_total_info),  id(node_home),    LV_ALIGN_OUT_BOTTOM_MID, 0, 8);
            lv_obj_align_to(id(lbl_pv_total_info),    id(node_solar),   LV_ALIGN_OUT_LEFT_MID,  -12, 0);
            lv_obj_align_to(id(lbl_batt_totals_info), id(node_battery), LV_ALIGN_OUT_LEFT_MID,  -12, 0);
            lv_obj_align_to(id(lbl_grid_totals_info), id(node_grid),    LV_ALIGN_OUT_TOP_MID,     0,-8);

            // Keep SoC circle glued to the battery icon
            lv_obj_align_to(id(batt_soc_circle), id(node_battery), LV_ALIGN_OUT_RIGHT_MID, -12, 30);
            lv_obj_align(id(batt_soc_circle_text), LV_ALIGN_CENTER, 0, 0);
            bool show = id(show_totals_toggle).state;
            if (!show) {
              lv_obj_add_flag(id(lbl_home_total_info),  LV_OBJ_FLAG_HIDDEN);
              lv_obj_add_flag(id(lbl_pv_total_info),    LV_OBJ_FLAG_HIDDEN);
              lv_obj_add_flag(id(lbl_grid_totals_info), LV_OBJ_FLAG_HIDDEN);
              lv_obj_add_flag(id(lbl_batt_totals_info), LV_OBJ_FLAG_HIDDEN);
            } else {
              lv_obj_clear_flag(id(lbl_home_total_info),  LV_OBJ_FLAG_HIDDEN);
              lv_obj_clear_flag(id(lbl_pv_total_info),    LV_OBJ_FLAG_HIDDEN);
              lv_obj_clear_flag(id(lbl_grid_totals_info), LV_OBJ_FLAG_HIDDEN);
              lv_obj_clear_flag(id(lbl_batt_totals_info), LV_OBJ_FLAG_HIDDEN);

              // Use existing sensor values / existing labels (no calculations)
              auto nz = [](float v)->float { return std::isnan(v) ? 0.0f : v; };
              char buf[96];

              // PV
              snprintf(buf, sizeof(buf), "PV: %.2f kWh", nz(id(pv_daily).state));
              lv_label_set_text(id(lbl_pv_total_info), buf);

              // Home
              snprintf(buf, sizeof(buf), "Home: %.2f kWh", nz(id(house_consumption_daily).state));
              lv_label_set_text(id(lbl_home_total_info), buf);

              // Grid — reuse the text already on the Grid page to avoid new sensors
              const char* exp_txt = lv_label_get_text(id(lbl_export_daily));
              const char* imp_txt = lv_label_get_text(id(lbl_import_daily));
              char gb[128];
              snprintf(gb, sizeof(gb), "Export: %s\nImport: %s", exp_txt ? exp_txt : "--", imp_txt ? imp_txt : "--");
              lv_label_set_text(id(lbl_grid_totals_info), gb);

              // Battery
              snprintf(buf, sizeof(buf), "In: %.2f kWh\nOut: %.2f kWh", nz(id(battery_in_daily).state), nz(id(battery_out_daily).state));
              lv_label_set_text(id(lbl_batt_totals_info), buf);
            }
          }

          // ===== Hourly bar graph (dataset switchable) ================================
          // Fixed X positions for bars (must match YAML placement of the bar objs)
          static const int BAR_X[24] = {
             31,  69, 108, 146, 184, 223,
            261, 300, 338, 376, 415, 453,
            492, 530, 568, 607, 645, 684,
            722, 760, 799, 837, 876, 914
          };
          {
            auto nz = [](float v) { return (std::isnan(v) ? 0.0f : v); };

            // -- arrays per dataset (bind directly to HA sensor states) --
            float solar[24] = {
              nz(id(prod_h00).state), nz(id(prod_h01).state), nz(id(prod_h02).state), nz(id(prod_h03).state),
              nz(id(prod_h04).state), nz(id(prod_h05).state), nz(id(prod_h06).state), nz(id(prod_h07).state),
              nz(id(prod_h08).state), nz(id(prod_h09).state), nz(id(prod_h10).state), nz(id(prod_h11).state),
              nz(id(prod_h12).state), nz(id(prod_h13).state), nz(id(prod_h14).state), nz(id(prod_h15).state),
              nz(id(prod_h16).state), nz(id(prod_h17).state), nz(id(prod_h18).state), nz(id(prod_h19).state),
              nz(id(prod_h20).state), nz(id(prod_h21).state), nz(id(prod_h22).state), nz(id(prod_h23).state)
            };
            float pv2house[24] = {
              nz(id(tohouse_h00).state), nz(id(tohouse_h01).state), nz(id(tohouse_h02).state), nz(id(tohouse_h03).state),
              nz(id(tohouse_h04).state), nz(id(tohouse_h05).state), nz(id(tohouse_h06).state), nz(id(tohouse_h07).state),
              nz(id(tohouse_h08).state), nz(id(tohouse_h09).state), nz(id(tohouse_h10).state), nz(id(tohouse_h11).state),
              nz(id(tohouse_h12).state), nz(id(tohouse_h13).state), nz(id(tohouse_h14).state), nz(id(tohouse_h15).state),
              nz(id(tohouse_h16).state), nz(id(tohouse_h17).state), nz(id(tohouse_h18).state), nz(id(tohouse_h19).state),
              nz(id(tohouse_h20).state), nz(id(tohouse_h21).state), nz(id(tohouse_h22).state), nz(id(tohouse_h23).state)
            };
            float house[24] = {
              nz(id(house_h00).state), nz(id(house_h01).state), nz(id(house_h02).state), nz(id(house_h03).state),
              nz(id(house_h04).state), nz(id(house_h05).state), nz(id(house_h06).state), nz(id(house_h07).state),
              nz(id(house_h08).state), nz(id(house_h09).state), nz(id(house_h10).state), nz(id(house_h11).state),
              nz(id(house_h12).state), nz(id(house_h13).state), nz(id(house_h14).state), nz(id(house_h15).state),
              nz(id(house_h16).state), nz(id(house_h17).state), nz(id(house_h18).state), nz(id(house_h19).state),
              nz(id(house_h20).state), nz(id(house_h21).state), nz(id(house_h22).state), nz(id(house_h23).state)
            };
            float import_[24] = {
              nz(id(imp_h00).state), nz(id(imp_h01).state), nz(id(imp_h02).state), nz(id(imp_h03).state),
              nz(id(imp_h04).state), nz(id(imp_h05).state), nz(id(imp_h06).state), nz(id(imp_h07).state),
              nz(id(imp_h08).state), nz(id(imp_h09).state), nz(id(imp_h10).state), nz(id(imp_h11).state),
              nz(id(imp_h12).state), nz(id(imp_h13).state), nz(id(imp_h14).state), nz(id(imp_h15).state),
              nz(id(imp_h16).state), nz(id(imp_h17).state), nz(id(imp_h18).state), nz(id(imp_h19).state),
              nz(id(imp_h20).state), nz(id(imp_h21).state), nz(id(imp_h22).state), nz(id(imp_h23).state)
            };
            float export_[24] = {
              nz(id(exp_h00).state), nz(id(exp_h01).state), nz(id(exp_h02).state), nz(id(exp_h03).state),
              nz(id(exp_h04).state), nz(id(exp_h05).state), nz(id(exp_h06).state), nz(id(exp_h07).state),
              nz(id(exp_h08).state), nz(id(exp_h09).state), nz(id(exp_h10).state), nz(id(exp_h11).state),
              nz(id(exp_h12).state), nz(id(exp_h13).state), nz(id(exp_h14).state), nz(id(exp_h15).state),
              nz(id(exp_h16).state), nz(id(exp_h17).state), nz(id(exp_h18).state), nz(id(exp_h19).state),
              nz(id(exp_h20).state), nz(id(exp_h21).state), nz(id(exp_h22).state), nz(id(exp_h23).state)
            };
            float batt_in[24] = {
              nz(id(bin_h00).state), nz(id(bin_h01).state), nz(id(bin_h02).state), nz(id(bin_h03).state),
              nz(id(bin_h04).state), nz(id(bin_h05).state), nz(id(bin_h06).state), nz(id(bin_h07).state),
              nz(id(bin_h08).state), nz(id(bin_h09).state), nz(id(bin_h10).state), nz(id(bin_h11).state),
              nz(id(bin_h12).state), nz(id(bin_h13).state), nz(id(bin_h14).state), nz(id(bin_h15).state),
              nz(id(bin_h16).state), nz(id(bin_h17).state), nz(id(bin_h18).state), nz(id(bin_h19).state),
              nz(id(bin_h20).state), nz(id(bin_h21).state), nz(id(bin_h22).state), nz(id(bin_h23).state)
            };
            float batt_out[24] = {
              nz(id(bout_h00).state), nz(id(bout_h01).state), nz(id(bout_h02).state), nz(id(bout_h03).state),
              nz(id(bout_h04).state), nz(id(bout_h05).state), nz(id(bout_h06).state), nz(id(bout_h07).state),
              nz(id(bout_h08).state), nz(id(bout_h09).state), nz(id(bout_h10).state), nz(id(bout_h11).state),
              nz(id(bout_h12).state), nz(id(bout_h13).state), nz(id(bout_h14).state), nz(id(bout_h15).state),
              nz(id(bout_h16).state), nz(id(bout_h17).state), nz(id(bout_h18).state), nz(id(bout_h19).state),
              nz(id(bout_h20).state), nz(id(bout_h21).state), nz(id(bout_h22).state), nz(id(bout_h23).state)
            };
            float batt_pct[24] = {
              nz(id(soc_h00).state), nz(id(soc_h01).state), nz(id(soc_h02).state), nz(id(soc_h03).state),
              nz(id(soc_h04).state), nz(id(soc_h05).state), nz(id(soc_h06).state), nz(id(soc_h07).state),
              nz(id(soc_h08).state), nz(id(soc_h09).state), nz(id(soc_h10).state), nz(id(soc_h11).state),
              nz(id(soc_h12).state), nz(id(soc_h13).state), nz(id(soc_h14).state), nz(id(soc_h15).state),
              nz(id(soc_h16).state), nz(id(soc_h17).state), nz(id(soc_h18).state), nz(id(soc_h19).state),
              nz(id(soc_h20).state), nz(id(soc_h21).state), nz(id(soc_h22).state), nz(id(soc_h23).state)
            };

            // pick dataset
            float* ds = solar;
            switch (id(current_dataset)) {
              case 1: ds = pv2house; break;
              case 2: ds = house;    break;
              case 3: ds = import_;  break;
              case 4: ds = export_;  break;
              case 5: ds = batt_in;  break;
              case 6: ds = batt_out; break;
              case 7: ds = batt_pct; break;
              default: ds = solar;   break;
            }

            // scale
            float maxv = 0.0f;
            for (int i = 0; i < 24; i++) if (ds[i] > maxv) maxv = ds[i];
            if (id(current_dataset) == 7) {
              maxv = 100.0f; // Battery % fixed range
            } else if (maxv < 0.1f) {
              maxv = 0.1f;
            }

            const int BASE_Y = 525;
            const int MAX_H  = 325;
            const int W      = 23;

            // dataset color for bars
            uint32_t col = 0x388E3C; // solar default
            switch (id(current_dataset)) {
              case 1: col = 0xFFC107; break; // PV→House
              case 2: col = 0xFFFFFF; break; // House
              case 3: col = 0xB71C1C; break; // Import
              case 4: col = 0x12B4D7; break; // Export
              case 5: col = 0x4CAF50; break; // Batt In
              case 6: col = 0x8E24AA; break; // Batt Out
              case 7: col = 0x2E7D32; break; // Batt %
              default: break;
            }

            // --- Active dataset button highlighting (now 8 buttons) ---
            {
              lv_obj_t* ds_btns[8] = {
                id(ds_btn_0), id(ds_btn_1), id(ds_btn_2), id(ds_btn_3),
                id(ds_btn_4), id(ds_btn_5), id(ds_btn_6), id(ds_btn_7)
              };
              const uint32_t ds_colors[8] = {
                0x388E3C, 0xFFC107, 0xFFFFFF, 0xB71C1C,
                0x12B4D7, 0x4CAF50, 0x8E24AA, 0x2E7D32
              };
              int active = id(current_dataset);
              for (int i = 0; i < 8; ++i) {
                bool is_active = (i == active);
                uint32_t bg = is_active ? ds_colors[i] : 0x444444;
                lv_obj_t* btn = ds_btns[i];

                lv_obj_set_style_bg_color(btn, lv_color_hex(bg), LV_PART_MAIN);
                lv_obj_set_style_bg_opa  (btn, LV_OPA_COVER,     LV_PART_MAIN);
                lv_obj_set_style_border_width(btn, is_active ? 2 : 0, LV_PART_MAIN);
                lv_obj_set_style_outline_color(btn, lv_color_hex(0xFFFFFF), LV_PART_MAIN);

                // set text color on the LABEL child (so we override the YAML label color)
                lv_obj_t* lbl = lv_obj_get_child(btn, 0);
                if (lbl) {
                  // Only dataset 2 (House) gets black text when active; all others stay white
                  lv_color_t txt = (is_active && i == 2) ? lv_color_hex(0x000000) : lv_color_hex(0xFFFFFF);
                  lv_obj_set_style_text_color(lbl, txt, LV_PART_MAIN);
                }
              }
            }

            // map LVGL objects (bars + vertical value labels)
            lv_obj_t* bars[24] = {
              id(bar_00), id(bar_01), id(bar_02), id(bar_03), id(bar_04), id(bar_05),
              id(bar_06), id(bar_07), id(bar_08), id(bar_09), id(bar_10), id(bar_11),
              id(bar_12), id(bar_13), id(bar_14), id(bar_15), id(bar_16), id(bar_17),
              id(bar_18), id(bar_19), id(bar_20), id(bar_21), id(bar_22), id(bar_23)
            };
            lv_obj_t* vlabels[24] = {
              id(lbl_val_00), id(lbl_val_01), id(lbl_val_02), id(lbl_val_03), id(lbl_val_04), id(lbl_val_05),
              id(lbl_val_06), id(lbl_val_07), id(lbl_val_08), id(lbl_val_09), id(lbl_val_10), id(lbl_val_11),
              id(lbl_val_12), id(lbl_val_13), id(lbl_val_14), id(lbl_val_15), id(lbl_val_16), id(lbl_val_17),
              id(lbl_val_18), id(lbl_val_19), id(lbl_val_20), id(lbl_val_21), id(lbl_val_22), id(lbl_val_23)
            };

            // draw/update bars
            for (int i = 0; i < 24; i++) {
              int h = int((ds[i] / maxv) * MAX_H + 0.5f);
              if (h < 2) h = 2;
              lv_obj_set_style_bg_color(bars[i], lv_color_hex(col), LV_PART_MAIN);
              lv_obj_set_size(bars[i], W, h);
              lv_obj_set_pos(bars[i], BAR_X[i], BASE_Y - h);  // use BAR_X to match YAML
            }

            // helper: good contrast text color for inside-bar labels
            auto inside_contrast = [](uint32_t rgb_hex)->lv_color_t {
              int r = (rgb_hex >> 16) & 0xFF;
              int g = (rgb_hex >> 8)  & 0xFF;
              int b = (rgb_hex)       & 0xFF;
              int lum = (r*299 + g*587 + b*114) / 1000; // 0..255
              return (lum > 140) ? lv_color_hex(0x000000) : lv_color_hex(0xFFFFFF);
            };

            // helper to build vertical text like "3\n5\n0\nW"
            auto make_vert = [](const char* s, char* out, int outsz) {
              int n = 0;
              for (int i = 0; s[i] != 0 && n < outsz - 2; ++i) {
                out[n++] = s[i];
                if (s[i + 1] != 0) out[n++] = '\n';
              }
              out[n] = 0;
            };

            // value labels — obey "Show Graph Values" toggle
            bool show_vals = id(graph_values_toggle).state;

            for (int i = 0; i < 24; i++) {
              if (!show_vals) {
                lv_label_set_text(vlabels[i], "");
                lv_obj_set_style_opa(vlabels[i], LV_OPA_TRANSP, LV_PART_MAIN);
                continue;
              }

              // Decide the flat text once: either "###W" or "##%"
              char flat[20];
              bool have_text = true;

              if (id(current_dataset) == 7) {
                // Battery % dataset (0..100)
                float pct = ds[i];
                if (pct < 0.5f) {  // hide tiny bars
                  have_text = false;
                } else {
                  snprintf(flat, sizeof(flat), "%.0f%%", pct);
                }
              } else {
                // Other datasets are kWh-like hourly values -> show as Watts
                float watts_v = ds[i] * 1000.0f;
                if (watts_v < 1.0f) {
                  have_text = false;
                } else {
                  snprintf(flat, sizeof(flat), "%.0fW", watts_v);
                }
              }

              if (!have_text) {
                lv_label_set_text(vlabels[i], "");
                lv_obj_set_style_opa(vlabels[i], LV_OPA_TRANSP, LV_PART_MAIN);
                continue;
              }

              // Build vertical string and apply
              char vtxt[40];
              make_vert(flat, vtxt, sizeof(vtxt));
              lv_label_set_text(vlabels[i], vtxt);

              // Same width as bar & centered
              lv_obj_set_width(vlabels[i], W);
              lv_obj_set_style_text_align(vlabels[i], LV_TEXT_ALIGN_CENTER, LV_PART_MAIN);

              // Place outside for short bars, inside for tall bars
              int bar_h = lv_obj_get_height(bars[i]);
              if (bar_h < (MAX_H / 2)) {
                lv_obj_set_style_text_color(vlabels[i], lv_color_hex(0xFFFFFF), LV_PART_MAIN);
                lv_obj_align_to(vlabels[i], bars[i], LV_ALIGN_OUT_TOP_MID, 0, -6);
              } else {

          // === Daily totals labels: position, visibility, text updates ===
          // Position relative to nodes
          lv_obj_align_to(id(lbl_home_total_info),  id(node_home),    LV_ALIGN_OUT_BOTTOM_MID, 0, 8);
          lv_obj_align_to(id(lbl_pv_total_info),    id(node_solar),   LV_ALIGN_OUT_LEFT_MID,  -12, 0);
          lv_obj_align_to(id(lbl_batt_totals_info), id(node_battery), LV_ALIGN_OUT_LEFT_MID,  -12, 0);
          lv_obj_align_to(id(lbl_grid_totals_info), id(node_grid),    LV_ALIGN_OUT_TOP_MID,     0, -8);
          // Show/Hide
          if (id(show_totals_toggle).state) {
            lv_obj_clear_flag(id(lbl_home_total_info),  LV_OBJ_FLAG_HIDDEN);
            lv_obj_clear_flag(id(lbl_pv_total_info),    LV_OBJ_FLAG_HIDDEN);
            lv_obj_clear_flag(id(lbl_grid_totals_info), LV_OBJ_FLAG_HIDDEN);
            lv_obj_clear_flag(id(lbl_batt_totals_info), LV_OBJ_FLAG_HIDDEN);
          } else {
            lv_obj_add_flag(id(lbl_home_total_info),  LV_OBJ_FLAG_HIDDEN);
            lv_obj_add_flag(id(lbl_pv_total_info),    LV_OBJ_FLAG_HIDDEN);
            lv_obj_add_flag(id(lbl_grid_totals_info), LV_OBJ_FLAG_HIDDEN);
            lv_obj_add_flag(id(lbl_batt_totals_info), LV_OBJ_FLAG_HIDDEN);
          }
          // Text values (using existing sensors/labels only)
          {
            auto nz = [](float v)->float { return std::isnan(v) ? 0.0f : v; };
            char buf[96];
            // PV
            snprintf(buf, sizeof(buf), "PV: %.2f kWh", nz(id(pv_daily).state));
            lv_label_set_text(id(lbl_pv_total_info), buf);
            // Home
            snprintf(buf, sizeof(buf), "Home: %.2f kWh", nz(id(house_consumption_daily).state));
            lv_label_set_text(id(lbl_home_total_info), buf);
            // Grid (reuse existing Grid page daily labels to avoid calc)
            const char* exp_txt = lv_label_get_text(id(lbl_export_daily));
            const char* imp_txt = lv_label_get_text(id(lbl_import_daily));
            char gb[128];
            snprintf(gb, sizeof(gb), "Export: %s\nImport: %s",
                     (exp_txt && exp_txt[0]) ? exp_txt : "--",
                     (imp_txt && imp_txt[0]) ? imp_txt : "--");
            lv_label_set_text(id(lbl_grid_totals_info), gb);
            // Battery
            snprintf(buf, sizeof(buf), "In: %.2f kWh\nOut: %.2f kWh",
                     nz(id(battery_in_daily).state), nz(id(battery_out_daily).state));
            lv_label_set_text(id(lbl_batt_totals_info), buf);
          }

          // === Keep SoC widgets glued to battery icon (~30px left & down) ===
          lv_obj_align_to(id(batt_soc_circle), id(node_battery), LV_ALIGN_OUT_RIGHT_MID, -12, 30);
          lv_obj_align(id(batt_soc_circle_text), LV_ALIGN_CENTER, 0, 0);
          lv_obj_align_to(id(batt_soc_arc),     id(node_battery), LV_ALIGN_OUT_RIGHT_MID, -12, 30);

          // === Settings/pills sync: add Daily Totals pill ===
          {
            bool on = id(show_totals_toggle).state;
            lv_obj_set_style_bg_color(id(pill_daily_totals), lv_color_hex(on ? 0x2E7D32 : 0x424242), LV_PART_MAIN);
            lv_label_set_text(id(lbl_daily_totals_state), on ? "ON" : "OFF");
            lv_obj_align(id(lbl_daily_totals_state), LV_ALIGN_CENTER, 0, 0);
          }
          lv_obj_set_style_text_color(vlabels[i], inside_contrast(col), LV_PART_MAIN);
          lv_obj_align_to(vlabels[i], bars[i], LV_ALIGN_TOP_MID, 0, 8);
              }

              lv_obj_set_style_opa(vlabels[i], LV_OPA_COVER, LV_PART_MAIN);
            }

            // highlight current hour (once)
            int cur_h = 0;
            auto now = id(sntp_time).now();
            if (now.is_valid()) cur_h = now.hour;   // 0..23
            for (int i = 0; i < 24; i++) {
              lv_obj_set_style_border_width(bars[i], (i == cur_h) ? 2 : 0, LV_PART_MAIN);
              lv_obj_set_style_outline_color(bars[i], lv_color_hex(0xFFFFFF), LV_PART_MAIN);
            }
          }

          // === Settings & Wi-Fi pills sync ==========================================
          auto set_pill = [](lv_obj_t* pill, lv_obj_t* lbl, bool on) {
            // background color
            lv_obj_set_style_bg_color(
              pill,
              lv_color_hex(on ? 0x2E7D32 : 0x424242),
              LV_PART_MAIN
            );

            // choose text
            const char* text;
            // Special case: Screen Sleep pill → "Motion" / "Always"
            if (lbl == id(lbl_display_mode_state)) {
              text = on ? "Motion" : "Always";
            } else {
              // All other pills → "ON" / "OFF"
              text = on ? "ON" : "OFF";
            }

            // apply text and keep centered
            lv_label_set_text(lbl, text);
            lv_obj_align(lbl, LV_ALIGN_CENTER, 0, 0);
          };

          // Backlight (uses a real GPIO switch)
          set_pill(id(pill_backlight),   id(lbl_backlight_state),   id(backlight_switch).state);

          // Display auto sleep (template switch)
          set_pill(id(pill_display_mode), id(lbl_display_mode_state), id(display_auto_sleep_toggle).state);

          // Suggestions (template switch)
          set_pill(id(pill_suggestions), id(lbl_suggestions_state), id(suggestion_toggle).state);

          // Graph value labels (template switch)
          set_pill(id(pill_graphvals),   id(lbl_graph_values_state), id(graph_values_toggle).state);
          // Daily Totals (template switch)
          set_pill(id(pill_daily_totals), id(lbl_daily_totals_state), id(show_totals_toggle).state);

          // Simulate Backup Mode
          set_pill(id(pill_backup_sim),  id(lbl_backup_sim_state),  id(simulate_backup_switch).state);


          // Homepage selector (template switch)
          set_pill(id(pill_homepage_select), id(lbl_homepage_select_state), id(change_homepage).state);

          // Wi-Fi status pill (connected/disconnected)
          {
            bool connected = (strcmp(lv_label_get_text(id(lbl_wifi_state)), "Connected") == 0);
            lv_obj_set_style_bg_color(id(pill_wifi_state), lv_color_hex(connected ? 0x2E7D32 : 0x8E24AA), LV_PART_MAIN);
            lv_obj_align(id(lbl_wifi_state), LV_ALIGN_CENTER, 0, 0);
          }

      # ========================
      # home_page_2 – Solar power
      # ========================
      - lambda: |-
          {
            float v = id(solar_panel_production_sensor).state;   // sensor.solar_panel_production_w
            char buf[24];
            if (fabsf(v) >= 1000.0f)
              snprintf(buf, sizeof(buf), "%.1f kW", v / 1000.0f);
            else
              snprintf(buf, sizeof(buf), "%.0f W", v);
            lv_label_set_text(id(hp2_lbl_solar_w), buf);
          }

      # ========================
      # home_page_2 – Home (house) power
      # ========================
      - lambda: |-
          {
            float v = id(solar_house_consumption_sensor).state;  // sensor.solar_house_consumption_w
            char buf[24];
            if (fabsf(v) >= 1000.0f)
              snprintf(buf, sizeof(buf), "%.1f kW", v / 1000.0f);
            else
              snprintf(buf, sizeof(buf), "%.0f W", v);
            lv_label_set_text(id(hp2_lbl_home_w), buf);
          }
          
          // ========================
          // home_page_2 – Battery SoC % (unchanged)
          // ========================
          {
            float soc = id(solaredge_battery_soc).state;
            if (std::isnan(soc)) soc = 0.0f;
            char pct[12];
            snprintf(pct, sizeof(pct), "%.0f%%", soc);
            lv_label_set_text(id(hp2_lbl_batt_pct), pct);
          }

          // ========================
          // home_page_2 – Battery Power using HA entities
          //   + charging  = sensor.solar_battery_in_w  (id: battery_in_w)
          //   - discharging = sensor.solar_battery_out_w (id: battery_out_w)
          // ========================
          {
            auto nz = [](float v){ return std::isnan(v) ? 0.0f : v; };

            float in_w  = nz(id(battery_in_w).state);   // + into battery (charging)
            float out_w = nz(id(battery_out_w).state);  // + out of battery (discharging)

            float batt_net_w = in_w - out_w;            // + = charging, - = discharging

            // Format with sign (+/-) and W/kW
            char b[24];
            if (fabsf(batt_net_w) >= 1000.0f)
              snprintf(b, sizeof(b), "%s%.1f kW", (batt_net_w >= 0 ? "+" : "-"), fabsf(batt_net_w) / 1000.0f);
            else
              snprintf(b, sizeof(b), "%s%.0f W",  (batt_net_w >= 0 ? "+" : "-"), fabsf(batt_net_w));

            lv_label_set_text(id(hp2_lbl_batt_power), b);

            // Optional: color hint (green charge, red discharge)
            lv_obj_set_style_text_color(
              id(hp2_lbl_batt_power),
              lv_color_hex(batt_net_w >= 0 ? 0x2E7D32 : 0xD32F2F),
              LV_PART_MAIN
            );
          }
      # ========================
      # home_page_2 – Grid (Import/Export arrows)
      # ========================
      - lambda: |-
          {
            auto nz = [](float v){ return std::isnan(v) ? 0.0f : v; };

            float g_house   = nz(id(grid_to_house).state);    // grid → house
            float g_batt    = nz(id(grid_to_battery).state);  // grid → battery
            float pv2grid   = nz(id(pv_to_grid_w).state);     // solar → grid
            float batt2grid = nz(id(battery_to_grid).state);  // battery → grid

            float import_w = g_house + g_batt;
            float export_w = pv2grid + batt2grid;
            float net_w    = import_w - export_w;

            // Label
            char buf[24];
            if (fabsf(net_w) >= 1000.0f)
              snprintf(buf, sizeof(buf), "%.1f kW", net_w / 1000.0f);
            else
              snprintf(buf, sizeof(buf), "%.0f W", net_w);
            lv_label_set_text(id(hp2_lbl_grid_w), buf);

            // Toggle widgets (NOTE: *_inst are widgets, not resources)
            if (net_w < 0) {
              // exporting → show UP, hide DOWN
              lv_obj_add_flag  (id(hp2_img_grid_arrow_down_inst), LV_OBJ_FLAG_HIDDEN);
              lv_obj_clear_flag(id(hp2_img_grid_arrow_up_inst),   LV_OBJ_FLAG_HIDDEN);
            } else {
              // importing → show DOWN, hide UP
              lv_obj_add_flag  (id(hp2_img_grid_arrow_up_inst),   LV_OBJ_FLAG_HIDDEN);
              lv_obj_clear_flag(id(hp2_img_grid_arrow_down_inst), LV_OBJ_FLAG_HIDDEN);
            }
          }
      - lambda: |-
          {
            // -------- Exported today (use lbl_export_daily text) --------
            const char* exp_txt = lv_label_get_text(id(lbl_export_daily));
            if (exp_txt && exp_txt[0]) {
              lv_label_set_text(id(hp2_lbl_exported_today_value), exp_txt);
            } else {
              lv_label_set_text(id(hp2_lbl_exported_today_value), "--");
            
            }
            // -------- Self-use today (use house_consumption_daily sensor) --------
            if (id(house_consumption_daily).has_state()) {
              float v = id(house_consumption_daily).state;
              char buf[24];
              if (v >= 1000.0f) snprintf(buf, sizeof(buf), "%.2f MWh", v / 1000.0f);
              else              snprintf(buf, sizeof(buf), "%.2f kWh", v);
              lv_label_set_text(id(hp2_lbl_selfuse_today_value), buf);
            } else {
              lv_label_set_text(id(hp2_lbl_selfuse_today_value), "--");
            }
          }
      - lambda: |-
          {
            // Pull the text your original logic already builds on the other page
            const char* s = lv_label_get_text(id(suggestion_label));

            // Detect backup/off-grid exactly like elsewhere
            bool ha_backup = false;
            if (id(grid_backup_status_ha).has_state()) {
              ha_backup = !id(grid_backup_status_ha).state;  // grid off => backup
            }
            bool sim_backup = id(simulate_backup_switch).state;
            bool is_backup  = ha_backup || sim_backup;

            // 1) BACKUP MODE HAS PRIORITY — always show & flash, ignore suggestions toggle
            if (is_backup) {
              // Use existing message if present, else a safe fallback
              if (s && s[0]) lv_label_set_text(id(hp2_lbl_suggestion), s);
              else           lv_label_set_text(id(hp2_lbl_suggestion), "BACKUP MODE — running on solar and battery");

              static uint8_t tick = 0;      // flash red ↔ white
              tick = (tick + 1) & 7;        // ~1.2s at your 150ms interval
              bool on = (tick < 4);
              lv_obj_set_style_text_color(
                id(hp2_lbl_suggestion),
                on ? lv_color_hex(0xFF3B30) : lv_color_hex(0xFFFFFF),
                LV_PART_MAIN
              );
              // Do NOT return early anywhere else; backup already handled
            }
            else {
              // 2) NOT in backup: now we respect the suggestions toggle
              if (!id(suggestion_toggle).state || !(s && s[0])) {
                lv_label_set_text(id(hp2_lbl_suggestion), "");
              } else {
                lv_label_set_text(id(hp2_lbl_suggestion), s);
                lv_obj_set_style_text_color(id(hp2_lbl_suggestion), lv_color_hex(0xFFFFFF), LV_PART_MAIN);
              }
            }
          }
  - interval: 1s
    then:
      - lambda: |-
          // Interval mode only runs after entering the Interval page
          if (!id(interval_mode_active)) return;

          // If we returned to menu/settings (or other configuration pages), stop interval mode
          if (id(menu_page).is_showing() || id(settings_page).is_showing() || id(interval_settings_page).is_showing() ||
              id(usage_device_select_page).is_showing() || id(usage_settings_page).is_showing()) {
            id(interval_mode_active) = false;
            id(interval_running) = false;
            return;
          }

          int mask = id(interval_pages_mask) & 0xFF;
          if (mask == 0) return;

          // While the Interval page is visible, show a short countdown before starting rotation.
          if (id(interval_page).is_showing()) {
            if (!id(interval_running)) {
              if (id(interval_prelude_remaining) > 0) {
                id(interval_prelude_remaining) -= 1;
                // Update label
                lv_label_set_text(id(interval_prelude_lbl), str_sprintf("Starting in: %ds", id(interval_prelude_remaining)).c_str());
                return;
              }

              // Countdown finished: start rotation by showing the first selected page
              id(interval_running) = true;
              id(interval_countdown) = id(interval_seconds);
              id(interval_show_target_page).execute();
            }
            return;
          }

          // Rotation logic on data pages
          if (!id(interval_running)) return;

          if (id(interval_countdown) <= 0) {
            // find next selected page bit
            int start = id(interval_current_bit);
            int next = -1;
            for (int i = 1; i <= 8; i++) {
              int b = (start + i) % 8;
              if (mask & (1 << b)) { next = b; break; }
            }
            if (next < 0) return;

            id(interval_current_bit) = next;
            id(interval_target_bit) = next;
            id(interval_countdown) = id(interval_seconds);

            // show the page
            id(interval_show_target_page).execute();
          } else {
            id(interval_countdown) -= 1;
          }

  - interval: 1s
    then:
      - if:
          condition:
            lambda: return id(force_ap_mode);
          then:
            - lambda: |-
                // Force AP-only mode (ESP-IDF)
                // Keep the captive portal reachable even if STA could reconnect.
                esp_wifi_set_mode(WIFI_MODE_AP);